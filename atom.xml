<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>LittleYe233&#39;s Blog</title>
  
  
  <link href="https://blog.imakiseki.cf/atom.xml" rel="self"/>
  
  <link href="https://blog.imakiseki.cf/"/>
  <updated>2022-07-30T03:56:54.024Z</updated>
  <id>https://blog.imakiseki.cf/</id>
  
  <author>
    <name>LittleYe233</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Codeforces 1474B: Different Divisors</title>
    <link href="https://blog.imakiseki.cf/acmoi/codeforces/1474b/"/>
    <id>https://blog.imakiseki.cf/acmoi/codeforces/1474b/</id>
    <published>2022-07-30T03:14:01.000Z</published>
    <updated>2022-07-30T03:56:54.024Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><a href="https://codeforces.com/problemset/problem/1474/B">Codeforces 1474B</a> C++ 一解.</p></blockquote><span id="more"></span><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>$a$ 至少要有 $4$ 个因子 (自然包括 $1$ 和 $a$ 本身), 且任意两因子的差不小于 $d$. 为使 $a$ 尽可能小, 我们只希望 $a$ 有且仅有 $4$ 个因子, 也就是再确定两个不同的质因子 $p,q$ ($a=pq$, 且不妨设 $p&lt;q$).</p><p>一个很显然的事实是: 对于充分大的 $d$, 我们越能保证 $a-q\geq d$ (不会证明故从略), 因此我们只需要在质数表中找到不小于 $1+d$ ($1$ 即是因子升序排列的第一个因子) 的 $p$ (第二个因子) 和不小于 $p+d$ 的 $q$ (第三个因子), 再确保 $a$ (第四个因子) 与 $q$ 的差不小于 $d$ 即可. 经过验证, 对于 $d=1$ 依然有 $a-q\geq d$.</p><h3 id="生成质数表"><a href="#生成质数表" class="headerlink" title="生成质数表"></a>生成质数表</h3><p>生成质数表的方式有很多. 以下代码中尝试利用 STL 的 <code>vector&lt;int&gt;</code> 动态生成/更新指定范围内的质数表. 当然考虑到 $d\leq 10,000$, 可以直接生成完整长度 (所需的最大质数为 $20,011$, 根据质数定理估计质数表长度为 $2020$) 的质数表.</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_PRIME (20011) <span class="comment">// 10007 and 20011 are primes.</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">isPrime</span><span class="params">(<span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (x % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">3</span>; i &lt;= <span class="built_in"><span class="keyword">int</span></span>(<span class="built_in">floor</span>(<span class="built_in">sqrt</span>(x))); i += <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (x % i == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">updatePrimes</span><span class="params">(<span class="keyword">int</span> maxn, vector&lt;<span class="keyword">int</span>&gt; primes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> lastPrime = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (primes.<span class="built_in">size</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        lastPrime = primes.<span class="built_in">back</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        primes.<span class="built_in">push_back</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = lastPrime + (lastPrime == <span class="number">2</span> ? <span class="number">1</span> : <span class="number">2</span>); i &lt;= maxn; i += <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">isPrime</span>(i))</span><br><span class="line">        &#123;</span><br><span class="line">            primes.<span class="built_in">push_back</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> primes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">updatePrimes</span><span class="params">(<span class="keyword">int</span> maxn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">updatePrimes</span>(maxn, vector&lt;<span class="keyword">int</span>&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">solve</span><span class="params">(<span class="keyword">int</span> d, vector&lt;<span class="keyword">int</span>&gt; primes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt;::iterator index1 = <span class="built_in">lower_bound</span>(primes.<span class="built_in">begin</span>(), primes.<span class="built_in">end</span>(), <span class="number">1</span> + d);</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt;::iterator index2 = <span class="built_in">lower_bound</span>(primes.<span class="built_in">begin</span>(), primes.<span class="built_in">end</span>(), *index1 + d);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *index1 * *index2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> t, d;</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; primes = <span class="built_in">updatePrimes</span>(MAX_PRIME);</span><br><span class="line"></span><br><span class="line">    cin &gt;&gt; t;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (t--)</span><br><span class="line">    &#123;</span><br><span class="line">        cin &gt;&gt; d;</span><br><span class="line">        cout &lt;&lt; <span class="built_in">solve</span>(d, primes) &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://codeforces.com/problemset/problem/1474/B&quot;&gt;Codeforces 1474B&lt;/a&gt; C++ 一解.&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Essay" scheme="https://blog.imakiseki.cf/categories/Essay/"/>
    
    
    <category term="Programming" scheme="https://blog.imakiseki.cf/tags/Programming/"/>
    
    <category term="C++" scheme="https://blog.imakiseki.cf/tags/C/"/>
    
    <category term="Codeforces" scheme="https://blog.imakiseki.cf/tags/Codeforces/"/>
    
    <category term="Solution" scheme="https://blog.imakiseki.cf/tags/Solution/"/>
    
  </entry>
  
  <entry>
    <title>Codeforces 766A: Mahmoud and Longest Uncommon Subsequence</title>
    <link href="https://blog.imakiseki.cf/acmoi/codeforces/766a/"/>
    <id>https://blog.imakiseki.cf/acmoi/codeforces/766a/</id>
    <published>2022-07-30T00:52:37.000Z</published>
    <updated>2022-07-30T01:03:13.140Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><a href="https://codeforces.com/problemset/problem/766/A">Codeforces 766A</a> C++ 一解.</p></blockquote><span id="more"></span><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>两个字符串的最长不公共子序列被定义为最长的仅为其中一个字符串的子序列的字符串.</p><p>对于两个长度不相同的字符串 (不妨设 $a,b$ 且 $a$ 的长度较长), 一个非常直观的想法是: 因为一个字符串的子序列的长度必须不大于该串的长度, 只要选取 $a$ 本身作为所求的子序列, 其肯定是 $a$ 的子序列, 而不是 $b$ 的子序列.</p><p>而对于长度相同的情况, 我们同样可以使用类似的思路: 若两个串不相同, 我们总能选择其中一个串本身作为所求的子序列, 这样其一定不会是另一个串的子序列; 若两个串完全相同, 此时我们就无法找到一个串 (根据题意, 包括空串) 作为所求的子序列, 只能输出 $-1$.</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string a, b;</span><br><span class="line"></span><br><span class="line">    cin &gt;&gt; a &gt;&gt; b;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a == b)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="number">-1</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="built_in">max</span>(a.<span class="built_in">length</span>(), b.<span class="built_in">length</span>()) &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://codeforces.com/problemset/problem/766/A&quot;&gt;Codeforces 766A&lt;/a&gt; C++ 一解.&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Essay" scheme="https://blog.imakiseki.cf/categories/Essay/"/>
    
    
  </entry>
  
  <entry>
    <title>Codeforces 1520C: Not Adjacent Matrix</title>
    <link href="https://blog.imakiseki.cf/acmoi/codeforces/1520c/"/>
    <id>https://blog.imakiseki.cf/acmoi/codeforces/1520c/</id>
    <published>2022-07-28T11:23:45.000Z</published>
    <updated>2022-07-28T11:39:43.700Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><a href="https://codeforces.com/problemset/problem/1520/C">Codeforces 1520C</a> C++ 一解.</p></blockquote><span id="more"></span><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>只要求对 $n$ 阶方阵依次填充 $1,2,\cdots,n^2$, 一种常见的思考模式是依次将这个自然数序列填充到正确的位置. 显然对于本题一个较好的方案是间隔填充: 先从元素 $(0,0)$ (假定方阵左上角元素坐标为此, 其他类推) 开始每次间隔一格填充直至一行填充完毕, 再跳转到下一行间隔填充直至右下角元素 $(n-1,n-1)$, 接着顺序填充剩下的元素. 这样就能满足题意.</p><p>Codeforces 上<a href="https://codeforces.com/blog/entry/90342">编辑者博客</a>中, <a href="https://codeforces.com/profile/MikeMirzayanov">MikeMirzayazov</a> 用黑白棋盘举例, 先填充白格再填充黑格, 判定颜色依据为横纵坐标之和的奇偶性. 而以下的代码则直接将方阵拉长为长度为 $n$ 的一维数组, 直接根据下标的奇偶性填充数字, 效果类似. 当然以下的代码推出了每个坐标对应的数值的解析式, 并未利用到数组空间.</p><p>同时, 利用这样的填充方案, 显然可以得知当且仅当 $n=2$ 时找不到满足题意的方阵; 为方便编程, 这里将 $n=1$ 也做了特殊处理.</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solveAndPrint</span><span class="params">(<span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> nn = n * n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="number">1</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="number">-1</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n % <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nn; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; (nn + i) / <span class="number">2</span> + <span class="number">1</span> &lt;&lt; <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; i / <span class="number">2</span> + <span class="number">1</span> &lt;&lt; <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((i + <span class="number">1</span>) % n == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; endl;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nn; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; (nn + i + <span class="number">1</span>) / <span class="number">2</span> &lt;&lt; <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; i / <span class="number">2</span> + <span class="number">1</span> &lt;&lt; <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((i + <span class="number">1</span>) % n == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; endl;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> t, n;</span><br><span class="line"></span><br><span class="line">    cin &gt;&gt; t;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; t; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        cin &gt;&gt; n;</span><br><span class="line">        <span class="built_in">solveAndPrint</span>(n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://codeforces.com/problemset/problem/1520/C&quot;&gt;Codeforces 1520C&lt;/a&gt; C++ 一解.&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Essay" scheme="https://blog.imakiseki.cf/categories/Essay/"/>
    
    
    <category term="Programming" scheme="https://blog.imakiseki.cf/tags/Programming/"/>
    
    <category term="C++" scheme="https://blog.imakiseki.cf/tags/C/"/>
    
    <category term="Codeforces" scheme="https://blog.imakiseki.cf/tags/Codeforces/"/>
    
    <category term="Solution" scheme="https://blog.imakiseki.cf/tags/Solution/"/>
    
  </entry>
  
  <entry>
    <title>Codeforces 266B: Queue at the School</title>
    <link href="https://blog.imakiseki.cf/acmoi/codeforces/266b/"/>
    <id>https://blog.imakiseki.cf/acmoi/codeforces/266b/</id>
    <published>2022-07-26T14:57:22.000Z</published>
    <updated>2022-07-26T15:38:42.022Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><a href="https://codeforces.com/problemset/problem/266/B">Codeforces 266B</a> C++ 一解。</p></blockquote><span id="more"></span><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>简单的模拟。把 B 想象成箱子，要不断往右侧推。</p><p>需要注意的是，没有正确理解题意的话容易理解成每次让箱子统一右移一格。但实际上，遇到 <code>BBG</code> 的情况，下一秒应该是 <code>BGB</code> 而不是 <code>GBB</code>，因为某一时刻某两个相邻位置的 B 和 G 互换后，就只能考虑其后的位置了。再拿箱子举例，应该想象成连续的箱子无法推动，只能推动箱子“队列”的最末一个。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// brute force</span></span><br><span class="line"><span class="function">string <span class="title">solve</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> t, string s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = s.<span class="built_in">length</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; t; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (j &lt; l - <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (s[j] == <span class="string">&#x27;B&#x27;</span> &amp;&amp; s[j + <span class="number">1</span>] == <span class="string">&#x27;G&#x27;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                s[j] = <span class="string">&#x27;G&#x27;</span>;</span><br><span class="line">                s[j + <span class="number">1</span>] = <span class="string">&#x27;B&#x27;</span>;</span><br><span class="line">                j += <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                ++j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, t;</span><br><span class="line">    string s, a;</span><br><span class="line"></span><br><span class="line">    cin &gt;&gt; n &gt;&gt; t;</span><br><span class="line">    cin &gt;&gt; s;</span><br><span class="line"></span><br><span class="line">    a = <span class="built_in">solve</span>(n, t, s);</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; a &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://codeforces.com/problemset/problem/266/B&quot;&gt;Codeforces 266B&lt;/a&gt; C++ 一解。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="essay" scheme="https://blog.imakiseki.cf/categories/essay/"/>
    
    
    <category term="Programming" scheme="https://blog.imakiseki.cf/tags/Programming/"/>
    
    <category term="C++" scheme="https://blog.imakiseki.cf/tags/C/"/>
    
    <category term="Codeforces" scheme="https://blog.imakiseki.cf/tags/Codeforces/"/>
    
    <category term="Solution" scheme="https://blog.imakiseki.cf/tags/Solution/"/>
    
  </entry>
  
  <entry>
    <title>【Arch Linux】本地化：简体中文</title>
    <link href="https://blog.imakiseki.cf/techdev/arch/localization-simplified-chinese/"/>
    <id>https://blog.imakiseki.cf/techdev/arch/localization-simplified-chinese/</id>
    <published>2022-07-13T14:26:58.000Z</published>
    <updated>2022-07-13T18:14:13.562Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要介绍 Arch Linux 本地化为简体中文的操作。</p><p>本文的测试环境是 KDE Plasma + SDDM + Wayland。考虑到 Xorg 教程较多，且大部分操作通用，本文会存在 Xorg 和 Wayland 混合描述的情况。</p><span id="more"></span><h2 id="必要配置"><a href="#必要配置" class="headerlink" title="必要配置"></a>必要配置</h2><p>不建议用户日常使用 root 帐户，则此时用户的当前帐户建议拥有 sudo 权限。安装 <code>sudo</code> 包。</p><p>同时部分本地化安装包在 AUR 源中，建议用户安装 AUR helper。本文以 <code>yay</code> 为例。</p><h2 id="生成语言环境-1"><a href="#生成语言环境-1" class="headerlink" title="生成语言环境^1"></a>生成语言环境<a href="https://wiki.archlinux.org/title/Localization/Simplified_Chinese#locale_settings">^1</a></h2><p>编辑 <code>/etc/locale.gen</code>，找到 <code>#en_US.UTF-8 UTF-8</code> 和 <code>#zh_CN.UTF-8 UTF-8</code>，删除前面的注释符号“#”。</p><p>再生成语言环境文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo locale-gen</span><br></pre></td></tr></table></figure><p>为保证大部分程序和终端环境显示正常，在 <code>/etc/locale.conf</code> 中设置 <code>LANG</code> 环境变量：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LANG=en_US.UTF-8</span><br></pre></td></tr></table></figure><h3 id="（可选）为-Xorg-图形界面设置中文语言环境"><a href="#（可选）为-Xorg-图形界面设置中文语言环境" class="headerlink" title="（可选）为 Xorg 图形界面设置中文语言环境"></a>（可选）为 Xorg 图形界面设置中文语言环境</h3><p>编辑 <code>~/.xinitrc</code> 或 <code>~/.xprofile</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LANG=zh_CN.UTF-8</span><br><span class="line"><span class="built_in">export</span> LANGUAGE=zh_CN:en_US</span><br></pre></td></tr></table></figure><h2 id="显示简体中文字体"><a href="#显示简体中文字体" class="headerlink" title="显示简体中文字体"></a>显示简体中文字体</h2><p>此时图形界面的中文显示一般是异常的。这可以通过安装相关字体解决。</p><h3 id="安装字体-2"><a href="#安装字体-2" class="headerlink" title="安装字体^2"></a>安装字体<a href="https://wiki.archlinux.org/title/Localization/Simplified_Chinese#Install_fonts">^2</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S wqy-microhei wqy-microhei-lite wqy-bitmapfont wqy-zenhei ttf-arphic-ukai ttf-arphic-uming adobe-source-han-sans-cn-fonts adobe-source-han-serif-cn-fonts noto-fonts-cjk</span><br></pre></td></tr></table></figure><p>可选 AUR 源中 <code>ttf-ms-win11-auto-*</code> 相关的包（存在已知问题，见<a href="#ttf-ms-win11-auto--%E7%9B%B8%E5%85%B3%E5%8C%85%E6%97%A0%E6%95%88">下文</a>）。</p><p>一般此时字体缓存已刷新。若无：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fc-cache -fv</span><br></pre></td></tr></table></figure><p>可以通过类似下述命令验证字体缓存：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fc-match -s | grep <span class="string">&#x27;Noto Sans CJK&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="ttf-ms-win11-auto-相关包无效"><a href="#ttf-ms-win11-auto-相关包无效" class="headerlink" title="ttf-ms-win11-auto-* 相关包无效"></a><code>ttf-ms-win11-auto-*</code> 相关包无效</h4><p>参见 <code>ttf-ms-win11-auto</code> AUR 包<a href="https://aur.archlinux.org/packages/ttf-ms-win11-auto">详情页面</a>下的<a href="https://aur.archlinux.org/packages/ttf-ms-win11-auto#comment-873004">评论</a>：</p><blockquote><p>It still throws <code>ln: failed to create symbolic link &#39;/home/&lt;User&gt;/.cache/yay/ttf-ms-win11-auto/src/&#39; -&gt; &#39;&#39;: No such file or directory</code> warnings when I install the package via yay. Manually copy/move the font files from <code>~/.cache/yay/ttf-ms-win11-auto/src</code> to <code>/usr/share/fonts</code> and <code>fc-cache -fv</code> can solve the problem.</p></blockquote><p>因此，读者只需查看 AUR 包的缓存（如 <code>~/.cache/yay/ttf-ms-win11-auto</code>），找到其中的字体文件，或是解压其中的压缩包（如 <code>ttf-ms-win11-auto-zh_cn-10.0.22000.318-2-any.pkg.tar.zst</code>）得到字体文件，将其复制到 <code>/usr/share/fonts</code> 并重新生成字体缓存即可。</p><h3 id="修复简体中文字符显示为日文的问题-3"><a href="#修复简体中文字符显示为日文的问题-3" class="headerlink" title="修复简体中文字符显示为日文的问题^3"></a>修复简体中文字符显示为日文的问题<a href="https://wiki.archlinux.org/title/Localization/Simplified_Chinese#Fixed_Simplified_Chinese_display_as_a_variant_(Japanese)_glyph">^3</a></h3><p>新建文件 <code>/etc/fonts/conf.avail/64-language-selector-prefer.conf</code>：</p><p>若安装 <a href="https://archlinux.org/packages/?name=noto-fonts-cjk">noto-fonts-cjk</a> 包：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">fontconfig</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;fonts.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">fontconfig</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">alias</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">family</span>&gt;</span>serif<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prefer</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Serif CJK SC<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Serif CJK TC<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Serif CJK JP<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">prefer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">alias</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">alias</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">family</span>&gt;</span>sans-serif<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prefer</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Sans CJK SC<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Sans CJK TC<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Sans CJK JP<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">prefer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">alias</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">alias</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">family</span>&gt;</span>monospace<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prefer</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Sans Mono CJK SC<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Sans Mono CJK TC<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Sans Mono CJK JP<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">prefer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">alias</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">fontconfig</span>&gt;</span></span><br></pre></td></tr></table></figure><p>若安装 <a href="https://archlinux.org/packages/?name=adobe-source-han-sans-otc-fonts">adobe-source-han-sans-otc-fonts</a> 包：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">fontconfig</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;fonts.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">fontconfig</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">alias</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">family</span>&gt;</span>serif<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prefer</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Source Han Serif SC<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Source Han Serif TC<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Source Han Serif HW<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Source Han Serif K<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">prefer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">alias</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">alias</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">family</span>&gt;</span>sans-serif<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prefer</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Source Han Sans SC<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Source Han Sans TC<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Source Han Sans HW<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Source Han Sans K<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">prefer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">alias</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">alias</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">family</span>&gt;</span>monospace<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prefer</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Source Han Sans SC<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Source Han Sans TC<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Source Han Sans HW<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">family</span>&gt;</span>Source Han Sans K<span class="tag">&lt;/<span class="name">family</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">prefer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">alias</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">fontconfig</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后新建软链接应用配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /etc/fonts/conf.avail/64-language-selector-prefer.conf /etc/fonts/conf.d/64-language-selector-prefer.conf</span><br></pre></td></tr></table></figure><p>随后刷新字体缓存生效：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fc-cache -fv</span><br></pre></td></tr></table></figure><h2 id="中文输入法"><a href="#中文输入法" class="headerlink" title="中文输入法"></a>中文输入法</h2><p>本文使用 Fcitx 5 框架配套 Rime 输入法引擎和 Clover Pinyin（四叶草拼音）输入方案。</p><h3 id="Fcitx-5"><a href="#Fcitx-5" class="headerlink" title="Fcitx 5"></a>Fcitx 5</h3><h4 id="安装-4"><a href="#安装-4" class="headerlink" title="安装^4"></a>安装<a href="https://wiki.archlinux.org/title/Fcitx5#Installation">^4</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S fcitx5 fcitx5-qt fcitx5-gtk fcitx5-configtool</span><br></pre></td></tr></table></figure><p>在 Xorg 环境下，编辑 <code>~/.xprofile</code>：<a href="https://wiki.archlinux.org/title/Fcitx5#Integration">^5</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GTK_IM_MODULE=fcitx5</span><br><span class="line"><span class="built_in">export</span> QT_IM_MODULE=fcitx5</span><br><span class="line"><span class="built_in">export</span> XMODIFIERS=<span class="string">&quot;@im=fcitx5&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> LANG=<span class="string">&quot;zh_CN.UTF-8&quot;</span></span><br><span class="line"><span class="built_in">export</span> LC_CTYPE=<span class="string">&quot;zh_CN.UTF-8&quot;</span></span><br></pre></td></tr></table></figure><p>在 Wayland 环境下，编辑 <code>/etc/environment</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GTK_IM_MODULE=fcitx</span><br><span class="line">QT_IM_MODULE=fcitx</span><br><span class="line">XMODIFIERS=<span class="string">&quot;@im=fcitx&quot;</span></span><br></pre></td></tr></table></figure><p>注销会话或重启。</p><h4 id="外观"><a href="#外观" class="headerlink" title="外观"></a>外观</h4><p>本文使用 <a href="https://github.com/hosxy/Fcitx5-Material-Color">Material Color</a> 皮肤。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S fcitx5-material-color</span><br></pre></td></tr></table></figure><p>再编辑 Fcitx 5 的配置文件 <code>~/.config/fcitx5/conf/classicui.conf</code>：<a href="https://github.com/hosxy/Fcitx5-Material-Color/blob/master/README.md#%E6%89%8B%E5%8A%A8%E5%AE%89%E8%A3%85">^6</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 垂直候选列表</span></span><br><span class="line">Vertical Candidate List=False</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按屏幕 DPI 使用</span></span><br><span class="line">PerScreenDPI=True</span><br><span class="line"></span><br><span class="line"><span class="comment"># Font (设置成你喜欢的字体)</span></span><br><span class="line">Font=<span class="string">&quot;思源黑体 CN Medium 13&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主题</span></span><br><span class="line">Theme=Material-Color-Pink</span><br></pre></td></tr></table></figure><h4 id="诊断工具"><a href="#诊断工具" class="headerlink" title="诊断工具"></a>诊断工具</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fcitx5-diagnose</span><br></pre></td></tr></table></figure><h3 id="Rime"><a href="#Rime" class="headerlink" title="Rime"></a><a href="https://rime.im/">Rime</a></h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S fcitx5-rime</span><br></pre></td></tr></table></figure><p>重启 Fcitx 5。依次 System Settings -&gt; Regional Settings -&gt; Input Method -&gt; Add Input Method… -&gt; Only Show Current Language [Uncheck] -&gt; Rime（中州韻）来激活输入法。</p><p><strong>注意</strong>：Rime 系统目录位于 <code>/usr/share/rime-data</code>。本地目录 <code>~/.local/share/fcitx5/rime</code> 可以覆盖前者的配置。</p><h4 id="单行模式"><a href="#单行模式" class="headerlink" title="单行模式"></a>单行模式</h4><p>单行模式类似于 Windows 10 中微软拼音的默认行为：输入的拼音序列能同时键入到文本中，待选定候选词后才将其替换为对应的词。</p><p>编辑 <code>~/.config/fcitx5/conf/rime.conf</code>：<a href="https://github.com/hosxy/Fcitx5-Material-Color/blob/master/README.md#%E5%8D%95%E8%A1%8C%E6%A8%A1%E5%BC%8F-inline-preedit">^7</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可用时在应用程序中显示预编辑文本（开启单行模式）</span></span><br><span class="line">PreeditInApplication=True</span><br></pre></td></tr></table></figure><h3 id="Clover-Pinyin"><a href="#Clover-Pinyin" class="headerlink" title="Clover Pinyin"></a>Clover Pinyin</h3><h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yay -S rime-cloverpinyin</span><br></pre></td></tr></table></figure><p>编辑 <code>~/.local/share/fcitx5/rime/default.custom.yaml</code>：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">patch:</span></span><br><span class="line">  <span class="comment"># 每页候选词个数</span></span><br><span class="line">  <span class="attr">&quot;menu/page_size&quot;:</span> <span class="number">9</span></span><br><span class="line">  <span class="attr">schema_list:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">schema:</span> <span class="string">clover</span></span><br></pre></td></tr></table></figure><p>重启 Fcitx 5。</p><p><strong>注意</strong>：Clover Pinyin 有关快捷键等配置位于 <code>~/.local/share/fcitx5/rime/build/clover.schema.yaml</code>。</p><h4 id="Emoji"><a href="#Emoji" class="headerlink" title="Emoji"></a>Emoji</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S noto-fonts-emoji</span><br><span class="line">yay -S noto-color-emoji-fontconfig</span><br></pre></td></tr></table></figure><p>注销会话或重启。</p><h4 id="特殊符号"><a href="#特殊符号" class="headerlink" title="特殊符号"></a>特殊符号</h4><p>指输入特殊符号拼音出现候选词（如“pingfang”出现“²”），或输入“/xx”（“xx”表示一些英文字母的组合）出现一类候选词（如“/sx”出现数学相关特殊符号）。</p><p>对于前者，目前尚无较好的解决方案。</p><p>对于后者，参考该<a href="https://github.com/fkxxyz/rime-cloverpinyin/issues/71#issuecomment-820448262">回复</a>。</p><p><strong>注意</strong>：特殊符号支持存在已知问题，可能导致内存溢出，可以通过如下命令简单修复：<a href="https://github.com/fkxxyz/rime-cloverpinyin/issues/99">^8</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&quot;<span class="subst">$(curl -fsSL https://github.com/fkxxyz/rime-symbols/raw/master/rime-symbols-gen)</span>&quot;</span></span><br><span class="line">mkdir -p ~/.<span class="built_in">local</span>/share/fcitx5/rime/opencc</span><br><span class="line">mv symbol.json symbol_category.txt symbol_word.txt ~/.<span class="built_in">local</span>/share/fcitx5/rime/opencc</span><br></pre></td></tr></table></figure><p>重新部署 Rime。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文主要介绍 Arch Linux 本地化为简体中文的操作。&lt;/p&gt;
&lt;p&gt;本文的测试环境是 KDE Plasma + SDDM + Wayland。考虑到 Xorg 教程较多，且大部分操作通用，本文会存在 Xorg 和 Wayland 混合描述的情况。&lt;/p&gt;</summary>
    
    
    
    <category term="Essay" scheme="https://blog.imakiseki.cf/categories/Essay/"/>
    
    <category term="Tutorial" scheme="https://blog.imakiseki.cf/categories/Essay/Tutorial/"/>
    
    
    <category term="Arch Linux" scheme="https://blog.imakiseki.cf/tags/Arch-Linux/"/>
    
    <category term="Simplified Chinese" scheme="https://blog.imakiseki.cf/tags/Simplified-Chinese/"/>
    
    <category term="Operating System" scheme="https://blog.imakiseki.cf/tags/Operating-System/"/>
    
    <category term="Desktop" scheme="https://blog.imakiseki.cf/tags/Desktop/"/>
    
    <category term="Localization" scheme="https://blog.imakiseki.cf/tags/Localization/"/>
    
  </entry>
  
  <entry>
    <title>【Arch Linux】maddy 邮件服务器搭建</title>
    <link href="https://blog.imakiseki.cf/techdev/arch/maddy/"/>
    <id>https://blog.imakiseki.cf/techdev/arch/maddy/</id>
    <published>2022-05-15T17:09:52.000Z</published>
    <updated>2022-07-13T12:03:22.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><a href="https://github.com/foxcpp/maddy">maddy</a> 是一个开源的轻量级“可组合”（composable）多合一邮件服务器，支持通过 IMAP/SMTP 等协议和 DKIM、SPF、DMARC、DANE、MTA-STS 等安全模式收发邮件。本文将以<a href="https://maddy.email/tutorials/setting-up/">官方文档</a>为主线，整理 maddy 服务器配置流程。</p></blockquote><span id="more"></span><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>为保证 maddy 的正常运行，请先明确一些建议满足的前提条件：</p><ul><li>具有公网地址（本文以 IPv4 为例）并开放 25、143、465（TLS）、587、993（TLS）等端口（一些 VPS 提供商如谷歌云不支持）的服务器；</li><li>拥有一个域名（最好是付费二级域名，避免一些 DNS 服务商如 Cloudflare 封禁对其的 API 操作），并接入 DNS 服务商（本文以 <a href="https://www.cloudflare.com/">Cloudflare</a> 为例）；</li><li>TLS 证书（本文以 <a href="https://letsencrypt.org/">Let’s Encrypt</a> 和一款证书获取软件 <a href="https://certbot.eff.org/">certbot</a> 为例）。</li></ul><p>为叙述方便，本文假设邮件服务器的主域名为 example.org，<a href="https://zh.wikipedia.org/zh-cn/MX%E8%AE%B0%E5%BD%95">邮件交换</a>（<a href="https://en.wikipedia.org/wiki/MX_record">MX</a>）域名为 mx1.example.org，公网 IPv4 地址为 10.2.3.4，邮件账户为 <a href="mailto:&#x70;&#x6f;&#115;&#x74;&#109;&#97;&#115;&#x74;&#x65;&#114;&#64;&#101;&#x78;&#x61;&#109;&#x70;&#x6c;&#101;&#x2e;&#x6f;&#114;&#103;">&#x70;&#x6f;&#115;&#x74;&#109;&#97;&#115;&#x74;&#x65;&#114;&#64;&#101;&#x78;&#x61;&#109;&#x70;&#x6c;&#101;&#x2e;&#x6f;&#114;&#103;</a>。</p><p>同时需要在服务器上至少安装如下的软件包：</p><ul><li>maddy</li><li>certbot<ul><li>certbot-dns-cloudflare</li></ul></li><li>nginx（或其他 Web 服务端）</li></ul><p>除 maddy 外，其他的软件包都可以使用 <code>pacman</code> 直接安装。</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>可以在 GitHub 的 <a href="https://github.com/foxcpp/maddy/releases">Releases</a> 页面获取 maddy 最新版本的源码和预编译程序。也可以参照<a href="https://maddy.email/tutorials/setting-up/#installing-maddy">官方文档</a>的说明，从源码构建、AUR 处获取或 Docker 镜像部署。</p><p><strong>注意</strong>：从 AUR 处获取需要下载体积很大的 golang 编译器。为节约下载并安装编译器的时间，读者可以直接使用 GitHub 的预编译程序。本文也以此为例。</p><p>在服务器终端中执行如下命令，以下载 maddy 的预编译程序：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 zstd 包，以解压 *.zst 类型的文件</span></span><br><span class="line">sudo pacman -S zstd --needed</span><br><span class="line"><span class="comment"># 下载地址，可以任意选择</span></span><br><span class="line"><span class="built_in">cd</span> ~/Downloads</span><br><span class="line">wget https://github.com/foxcpp/maddy/releases/download/v0.5.4/maddy-0.5.4-x86_64-linux-musl.tar.zst</span><br><span class="line"><span class="comment"># 参考 zsh 的 extract 插件</span></span><br><span class="line">tar --zstd -xvf maddy-0.5.4-x86_64-linux-musl.tar.zst || zstdcat maddy-0.5.4-x86_64-linux-musl.tar.zst | tar xvf -</span><br><span class="line"><span class="built_in">cd</span> maddy-0.5.4-x86_64-linux-musl</span><br><span class="line"><span class="comment"># 复制服务</span></span><br><span class="line">sudo cp systemd/*.service /etc/systemd/system</span><br><span class="line"><span class="comment"># 复制可执行文件</span></span><br><span class="line">sudo cp maddy maddyctl /usr/<span class="built_in">local</span>/bin</span><br><span class="line"><span class="comment"># 复制配置文件</span></span><br><span class="line">sudo mkdir -p /etc/maddy</span><br><span class="line">sudo cp maddy.conf /etc/maddy</span><br><span class="line"><span class="comment"># 复制 man 文件</span></span><br><span class="line">sudo cp man/*.1 /usr/share/man/man1</span><br><span class="line">sudo cp man/*.5 /usr/share/man/man5</span><br></pre></td></tr></table></figure><p>启动服务前，先加载所有新增服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure><p>若要开机自启：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> maddy</span><br></pre></td></tr></table></figure><p>因为 maddy 运行在非 root 用户上，还需要创建一个用户用以运行 maddy 服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -mrU -s /sbin/nologin -d /var/lib/maddy -c <span class="string">&quot;maddy mail server&quot;</span> maddy</span><br></pre></td></tr></table></figure><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="域名"><a href="#域名" class="headerlink" title="域名"></a>域名</h3><p>使用任何编辑器打开 <code>/etc/maddy/maddy.conf</code>，修改 <code>$(hostname)</code> 和 <code>$(primary_domain)</code> 变量的值为 <code>mx1.example.org</code> 和 <code>example.org</code>。</p><h3 id="TLS-证书"><a href="#TLS-证书" class="headerlink" title="TLS 证书"></a>TLS 证书</h3><h4 id="获取"><a href="#获取" class="headerlink" title="获取"></a>获取</h4><p>Let’s Enccrypt 签发的 TLS 证书可以通过 certbot 获取。根据 <a href="https://eff-certbot.readthedocs.io/en/stable">certbot</a> 和 <a href="https://certbot-dns-cloudflare.readthedocs.io/en/stable/">certbot-dns-cloudflare</a> 的官方文档，首先需要在 Cloudflare 的 API Token <a href="https://dash.cloudflare.com/profile/api-tokens">配置页面</a>新建一个 Token，选择“Edit zone DNS”的模板，在“Zone Resources”选择目标二级域名（本文则是“example.org”）即可。</p><p><strong>注意</strong>：Token 只会显示一次，在配置好证书前，请务必牢记。</p><p>随后，可以在服务器上存储 Token 以方便后续使用。在终端中执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/.secrets/certbot</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;&lt;TOKEN&gt;&#x27;</span> &gt; ~/.secrets/certbot/cloudflare.ini  <span class="comment"># 替换为获取到的 Token</span></span><br></pre></td></tr></table></figure><p>并设置权限提高安全性：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 ~/.secrets/certbot/cloudflare.ini</span><br></pre></td></tr></table></figure><p>再使用 certbot 获取证书：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certbot certonly --dns-cloudflare --dns-cloudflare-credentials ~/.secrets/certbot/cloudflare.ini -d <span class="string">&#x27;*.example.org&#x27;</span> -d <span class="string">&#x27;example.org&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>注意</strong>：可以选择不为含通配符域名，而是根据后文实际需要指定必要的三级域名签发证书。</p><p>首次获取证书需要填写邮箱等个人信息。签发完毕后则可以通过 <code>sudo certbot certificates</code> 获取证书的详细信息和存储位置。一般存储位置在 <code>/etc/letsencrypt/live/example.org</code>，其中证书文件名为 <code>fullchain.pem</code>，私钥路径为 <code>privkey.pem</code>。</p><h4 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h4><p>编辑 <code>/etc/maddy/maddy.conf</code>，修改 <code>tls file</code> 一行为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tls file /etc/letsencrypt/live/$(primary_domain)/fullchain.pem /etc/letsencrypt/live/$(primary_domain)/privkey.pem</span><br></pre></td></tr></table></figure><p><code>/etc/letsencrypt/live</code> 文件夹默认权限为 750，maddy 无法访问，故需要使用 ACL 进行权限控制：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo setfacl -R -m u:maddy:rX /etc/letsencrypt/&#123;live,archive&#125;</span><br></pre></td></tr></table></figure><p>此时可以启动 maddy 服务来测试：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start maddy</span><br></pre></td></tr></table></figure><p>若服务未报错，则可以继续进行配置。</p><h3 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h3><p>进入 Cloudflare 的 DNS 配置页，作出如下所示的配置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">example.org.   A     10.2.3.4</span><br><span class="line">example.org.   MX    10 mx1.example.org.</span><br><span class="line">mx1.example.org.   A     10.2.3.4</span><br><span class="line">example.org.     TXT   &quot;v=spf1 mx ~all&quot;</span><br><span class="line">mx1.example.org. TXT   &quot;v=spf1 mx ~all&quot;</span><br><span class="line">_dmarc.example.org.   TXT    &quot;v=DMARC1; p=quarantine; ruf=mailto:postmaster@example.org&quot;</span><br><span class="line">_mta-sts.example.org.   TXT    &quot;v=STSv1; id=1&quot;</span><br><span class="line">_smtp._tls.example.org. TXT    &quot;v=TLSRPTv1;rua=mailto:postmaster@example.org&quot;</span><br><span class="line">default._domainkey.example.org.    TXT   &quot;v=DKIM1; k=ed25519; p=nAcUUozPlhc4VPhp7hZl+owES7j7OlEv0laaDEDBAqg=&quot;</span><br></pre></td></tr></table></figure><p>其中最后一条记录的值需要用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cat /var/lib/maddy/dkim_keys/example.org_default.dns</span><br></pre></td></tr></table></figure><p>的输出替换。若显示文件不存在，请确认 maddy 服务是否曾成功运行过至少一次。</p><h3 id="MTA-STS"><a href="#MTA-STS" class="headerlink" title="MTA-STS"></a>MTA-STS</h3><p>MTA-STS 要求访问 <a href="https://mta-sts.example.org/.well-known/mta-sts.txt">https://mta-sts.example.org/.well-known/mta-sts.txt</a> 时能输出类似如下的文本：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">version: STSv1</span><br><span class="line">mode: enforce</span><br><span class="line">max_age: 604800</span><br><span class="line">mx: mx1.example.org</span><br></pre></td></tr></table></figure><p>对于已经安装 HTTP Echo 模块的 Nginx，直接在 <code>/etc/nginx/nginx.conf</code> 中添加如下条目：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>          <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span>     mta-sts.example.org;</span><br><span class="line">    <span class="attribute">error_log</span>       /var/log/nginx/log.log;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/example.org/fullchain.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/live/example.org/privkey.pem;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">5m</span>;</span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">location</span> /.well-known/mta-sts.txt &#123;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&#x27;version: STSv1&#x27;</span>;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&#x27;mode: enforce&#x27;</span>;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&#x27;max_age: 604800&#x27;</span>;</span><br><span class="line">        <span class="attribute">echo</span> <span class="string">&#x27;mx: mx1.example.org&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于未安装该模块的 Nginx，先添加如下条目：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>          <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span>     mta-sts.example.org;</span><br><span class="line">    <span class="attribute">error_log</span>       /var/log/nginx/log.log;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/example.org/fullchain.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/live/example.org/privkey.pem;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">5m</span>;</span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">location</span> /.well-known/mta-sts.txt &#123;</span><br><span class="line">        <span class="attribute">root</span> /usr/share/nginx/mta-sts;  <span class="comment"># /usr/share/nginx 是 Nginx 的静态资源默认位置</span></span><br><span class="line">        <span class="attribute">index</span> /mta-sts.txt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再新建 <code>/usr/share/nginx/mta-sts</code> 文件夹，将指定文本写入 <code>mta-sts.txt</code> 文件中：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo cat &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">version: STSv1</span></span><br><span class="line"><span class="string">mode: enforce</span></span><br><span class="line"><span class="string">max_age: 604800</span></span><br><span class="line"><span class="string">mx: mx1.example.org</span></span><br><span class="line"><span class="string">EOF</span> &gt; /usr/share/nginx/mta-sts/mta-sts.txt</span><br></pre></td></tr></table></figure><p>重启 Nginx 服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure><p>检查上述网络路径是否能够正常访问。</p><h3 id="DANE"><a href="#DANE" class="headerlink" title="DANE"></a>DANE</h3><p>设置 TLSA（DANE）需要在 <a href="https://www.huque.com/bin/gen_tlsa">https://www.huque.com/bin/gen_tlsa</a> 生成对应的 DNS 记录。</p><p>进入页面后，在“Enter/paste PEM format X.509 certificate here:”下的文本框中输入<a href="#tls-%E8%AF%81%E4%B9%A6">上文</a>中获取的证书的内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cat /etc/letsencrypt/live/example.org/fullchain.pem</span><br></pre></td></tr></table></figure><p><strong>注意</strong>：该证书很长，务必复制完全。</p><p>下方的“Port Number:”填写 <code>25</code>，<code>Transport Protocol:</code> 填写 <code>tcp</code>，<code>Domain Name:</code> 填写 <code>mx1.example.org</code>。再点击“Generate”生成记录。将 DNS 记录写入 Cloudflare 中。</p><h3 id="创建邮件账户"><a href="#创建邮件账户" class="headerlink" title="创建邮件账户"></a>创建邮件账户</h3><p>在服务器终端中：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">maddyctl creds create postmaster@example.org</span><br><span class="line">maddyctl imap-acct create postmaster@example.org</span><br></pre></td></tr></table></figure><p>此时，邮件账户的用户名为“<a href="mailto:&#112;&#x6f;&#x73;&#116;&#x6d;&#97;&#115;&#x74;&#x65;&#x72;&#x40;&#101;&#120;&#97;&#109;&#x70;&#x6c;&#x65;&#46;&#111;&#x72;&#103;">&#112;&#x6f;&#x73;&#116;&#x6d;&#97;&#115;&#x74;&#x65;&#x72;&#x40;&#101;&#120;&#97;&#109;&#x70;&#x6c;&#x65;&#46;&#111;&#x72;&#103;</a>”，密码则在创建账户时要求设置。该账户已经可以在邮件客户端（如 Thunderbird 和 Outlook）中配置并使用。</p><h3 id="（可选）开启-DNSSEC-认证"><a href="#（可选）开启-DNSSEC-认证" class="headerlink" title="（可选）开启 DNSSEC 认证"></a>（可选）开启 DNSSEC 认证</h3><p><a href="https://en.wikipedia.org/wiki/Domain_Name_System_Security_Extensions">DNSSEC</a>（Domain Name System Security Extensions），即<a href="https://zh.wikipedia.org/zh-cn/%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E6%89%A9%E5%B1%95">域名系统安全扩展</a>，对DNS提供给DNS客户端（解析器）的DNS数据来源进行认证，并验证不存在性和校验数据完整性验证。</p><p><a href="https://wiki.archlinux.org/title/DNSSEC">Arch Wiki</a> 中给出了一些验证方法。安装 <code>ldns</code> 包后：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ drill -DT example.org  <span class="comment"># 替换为二级域名</span></span><br><span class="line"><span class="comment"># 省略多行</span></span><br><span class="line">[T] example.org. 60      IN      A       10.2.3.4</span><br><span class="line">;;[S] self sig OK; [B] bogus; [T] trusted</span><br></pre></td></tr></table></figure><p>如果命令执行结果如上所示（域名前的 flag 值为“T”），则说明 DNSSEC 认证已开启；反之，请参考 <a href="https://wiki.archlinux.org/title/DNSSEC#Install_a_DNSSEC-validating_resolver">Install a DNSSEC-validating resolver</a> 章节，或参考 DNS 服务商的文档。</p><p>以下简单介绍 Cloudflare 为域名开启 DNSSEC 的方法：进入 Cloudflare <a href="https://dash.cloudflare.com/">控制台</a>后，进入目标域名的详情页面，点击左侧的“DNS”选项卡，在页面尾部的“DNSSEC”部分点击“Enable DNSSEC”。随后 Cloudflare 将给出域名的 DS Record。再进入<strong>域名注册商</strong>的域名管理页面设置 DS Record。具体设置方法参照 Cloudflare 的<a href="https://developers.cloudflare.com/dns/additional-options/dnssec#step-2--add-ds-record-to-your-registrar">官方文档</a>。</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/foxcpp/maddy&quot;&gt;maddy&lt;/a&gt; 是一个开源的轻量级“可组合”（composable）多合一邮件服务器，支持通过 IMAP/SMTP 等协议和 DKIM、SPF、DMARC、DANE、MTA-STS 等安全模式收发邮件。本文将以&lt;a href=&quot;https://maddy.email/tutorials/setting-up/&quot;&gt;官方文档&lt;/a&gt;为主线，整理 maddy 服务器配置流程。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Essay" scheme="https://blog.imakiseki.cf/categories/Essay/"/>
    
    
    <category term="Arch Linux" scheme="https://blog.imakiseki.cf/tags/Arch-Linux/"/>
    
    <category term="maddy" scheme="https://blog.imakiseki.cf/tags/maddy/"/>
    
    <category term="Email" scheme="https://blog.imakiseki.cf/tags/Email/"/>
    
  </entry>
  
  <entry>
    <title>【Arch Linux】misskey 手动部署和配置</title>
    <link href="https://blog.imakiseki.cf/techdev/arch/misskey/"/>
    <id>https://blog.imakiseki.cf/techdev/arch/misskey/</id>
    <published>2022-04-29T12:45:20.000Z</published>
    <updated>2022-07-13T12:03:22.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://misskey-hub.net/en/">misskey</a> 是一款开源的“跨星际”（interplanetary）社交平台，以微博为主要形式，界面美观，内含元素丰富。本文即针对该平台在 Arch Linux 的手动安装方式作说明。</p><span id="more"></span><blockquote><p>笔者：为什么不用 docker 安装（这是官方认定 recommended 的安装方式）？只是不怎么想用 docker（</p></blockquote><blockquote><p><strong>注意</strong>：基于 Arch Linux 发行版的特殊性（非开箱即用），笔者会<strong>尽可能多</strong>地补充安装过程，<strong>尽可能</strong>让读者能从头到尾依照本文操作。但若存在疏漏，敬请谅解。</p></blockquote><h2 id="检查系统配置"><a href="#检查系统配置" class="headerlink" title="检查系统配置"></a>检查系统配置</h2><p>misskey 对服务端的性能配置要求较高，建议配置至少 2 核 CPU 和 4GB RAM。笔者使用的服务器部分配置如下（多人共有，但对 misskey 来说也已足够）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ neofetch</span><br><span class="line"><span class="comment"># 省略部分输出</span></span><br><span class="line">OS: Arch Linux x86_64</span><br><span class="line">Kernel: 5.15.34-1-lts</span><br><span class="line">CPU: AMD EPYC 7282 (4) @ 2.794GHz</span><br><span class="line">Memory: 1590MiB / 7950MiB</span><br></pre></td></tr></table></figure><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><h4 id="系统"><a href="#系统" class="headerlink" title="系统"></a>系统</h4><p>安装所有依赖（这里假设读者已经安装了 <code>sudo</code> 并配置好相关权限）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -Syu  <span class="comment"># 更新系统</span></span><br><span class="line">sudo pacman -S sudo visudo nano base-devel python --needed</span><br><span class="line">sudo python -m ensurepip --upgrade  <span class="comment"># 安装/升级 pip</span></span><br><span class="line">sudo ln -sf /usr/bin/&#123;nano,vi&#125;</span><br><span class="line">sudo visudo</span><br></pre></td></tr></table></figure><p>在打开的编辑器 <code>nano</code> 中去除 <code>#%wheel ALL=(ALL:ALL) ALL</code> 一行前的注释，依次按 <code>Ctrl+X</code>、<code>y</code>、<code>Enter</code> 保存。</p><p>同时考虑到 pip 用户配置下 <code>$PATH</code> 环境变量问题，使用编辑器打开当前终端配置（例如 <code>~/.bashrc</code>），添加如下行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PATH=~/.<span class="built_in">local</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><h4 id="misskey"><a href="#misskey" class="headerlink" title="misskey"></a>misskey</h4><p>官方文档中给出的 misskey 需要的依赖有：</p><ul><li>Node.JS（16.x）</li><li>PostgreSQL（建议 12.x 或 13.x）</li><li>Redis</li><li>yarn（可选，若不安装，后续安装过程中 <code>yarn</code> 应替换为 <code>npx yarn</code>）</li><li>FFmpeg</li></ul><p>考虑到大部分软件的向后兼容性，可以直接安装所有依赖：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S nodejs npm postgresql redis yarn ffmpeg --needed</span><br></pre></td></tr></table></figure><h3 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h3><p>因笔者服务器环境中存在多用户、多管理情况，此处的操作与官方文档不同——创建了一个有 <code>sudo</code> 权限、可登录、有家目录的用户。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -m -G wheel -s /bin/bash misskey</span><br></pre></td></tr></table></figure><p>并使用 <code>sudo passwd misskey</code> 设置登录密码。</p><p>若依照官方文档，仅需：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -r -s /usr/bin/nologin misskey</span><br></pre></td></tr></table></figure><p>之后切换入该用户继续操作：<code>su - misskey</code>。</p><h3 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h3><p>根据上文中用户创建方式，目录的路径可能不能完全如文中所述。请读者根据自身情况合理选择安装路径。</p><p>在终端中执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir .opt</span><br><span class="line"><span class="built_in">cd</span> .opt</span><br><span class="line">git <span class="built_in">clone</span> --recursive https://github.com/misskey-dev/misskey.git</span><br><span class="line"><span class="built_in">cd</span> misskey</span><br><span class="line">git checkout master</span><br></pre></td></tr></table></figure><p><strong>注意</strong>：截至本文编写时，misskey 源码库克隆大小 88.22MB，子库（misskey-assets）克隆大小 69.76MB。请自行选择是否“科学上网”或使用镜像站。</p><h3 id="安装依赖库"><a href="#安装依赖库" class="headerlink" title="安装依赖库"></a>安装依赖库</h3><p>在终端中执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn</span><br></pre></td></tr></table></figure><p><strong>注意</strong>：请自行选择是否“科学上网”或使用镜像站。</p><p><strong>注意</strong>：该过程耗时较长。若无人值守，建议使用 <code>tmux</code> 或 <code>screen</code> 防止 ssh 连接中断导致安装过程中断。</p><h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>在终端中执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NODE_ENV=production yarn build</span><br></pre></td></tr></table></figure><p><strong>注意</strong>：该过程耗时较长。若无人值守，建议使用 <code>tmux</code> 或 <code>screen</code> 防止 ssh 连接中断导致安装过程中断。</p><h3 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h3><h4 id="Postgresql"><a href="#Postgresql" class="headerlink" title="Postgresql"></a>Postgresql</h4><p>在终端中执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo -iu postgres  <span class="comment"># 切换到 postgres 用户</span></span><br><span class="line">initdb -D /var/lib/postgres/data</span><br><span class="line"><span class="comment"># （可选）修改 locale 和编码：</span></span><br><span class="line"><span class="comment"># initdb --locale=en_US.UTF-8 --encoding=UTF8 -D /var/lib/postgres/data</span></span><br><span class="line"><span class="built_in">exit</span>  <span class="comment"># 返回 misskey 用户</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> postgresql --now</span><br><span class="line">sudo systemctl status postgresql  <span class="comment"># 查看服务状态</span></span><br><span class="line"><span class="comment"># （可选）添加 SQL 操作历史文件</span></span><br><span class="line">sudo touch /var/lib/postgres/.psql_history</span><br><span class="line">sudo chown postgres:postgres /var/lib/postgres/.psql_history</span><br><span class="line">sudo -u postgres psql</span><br></pre></td></tr></table></figure><p>进入 Postgresql 操作界面，执行：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database misskey;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> misskey <span class="keyword">with</span> encrypted password <span class="string">&#x27;&#123;YOUR_PASSWORD&#125;&#x27;</span>;</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> database misskey <span class="keyword">to</span> misskey;</span><br><span class="line">\q</span><br></pre></td></tr></table></figure><p>其中上面的 <code>&#39;&#123;YOUR_PASSWORD&#125;&#39;</code> 可以任意配置，但需要和后面的 misskey 配置文件保持一致。</p><h4 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h4><p>在终端中执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> redis --now</span><br><span class="line">sudo systemctl status redis  <span class="comment"># 查看服务状态</span></span><br></pre></td></tr></table></figure><h3 id="前置配置"><a href="#前置配置" class="headerlink" title="前置配置"></a>前置配置</h3><p>从 <code>.config</code> 文件夹中复制 <code>example.yml</code> 到 <code>default.yml</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp .config/&#123;example,default&#125;.yml</span><br></pre></td></tr></table></figure><p>然后使用编辑器编辑后者，例如 <code>nano .config/default.yml</code>。其中最重要的配置（不修改就会直接导致 misskey 跑不通）是：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#   ┌──────────────────────────┐</span></span><br><span class="line"><span class="comment">#───┘ PostgreSQL configuration └────────────────────────────────</span></span><br><span class="line"></span><br><span class="line"><span class="attr">db:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Database name</span></span><br><span class="line">  <span class="attr">db:</span> <span class="string">misskey</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Auth</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">example-misskey-user</span></span><br><span class="line">  <span class="attr">pass:</span> <span class="string">example-misskey-pass</span></span><br></pre></td></tr></table></figure><p>将其中的 <code>user</code> 配置项改为 <code>user: misskey</code>，<code>pass</code> 配置项根据上面的配置保持一致。</p><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>在终端中执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn run init</span><br><span class="line">NODE_ENV=production npm start</span><br></pre></td></tr></table></figure><p>若在终端中看到类似如下的输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">INFO *  [core boot]     Welcome to Misskey!</span><br><span class="line">INFO *  [core boot]     Misskey v12.110.1</span><br><span class="line">INFO *  [core boot env] NODE_ENV: production</span><br><span class="line">INFO *  [core boot env] You do not have root privileges</span><br><span class="line">INFO *  [core boot nodejs]      Version v17.9.0 detected.</span><br><span class="line">DONE *  [core boot config]      Loaded</span><br><span class="line">INFO *  [core boot db]  Connecting...</span><br><span class="line">DONE *  [core boot db]  Connected: v14.2</span><br><span class="line">DONE *  [core boot]     Misskey initialized</span><br><span class="line">INFO *  [core boot]     Starting 1 worker...</span><br><span class="line">(node:324552) ExperimentalWarning: Importing JSON modules is an experimental feature. This feature could change at any time</span><br><span class="line">(Use `node --trace-warnings ...` to show where the warning was created)</span><br><span class="line">DONE *  [core boot]     All workers started</span><br><span class="line">DONE *  [core boot]     Now listening on port 3000 on https://example.tld</span><br></pre></td></tr></table></figure><p>则表示 misskey 部署成功。</p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="systemd-服务"><a href="#systemd-服务" class="headerlink" title="systemd 服务"></a>systemd 服务</h3><p>可以配置 systemd 服务让其管理 misskey 的运行。新建 <code>/etc/systemd/system/misskey.service</code>，在编辑器中打开并填入如下内容：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Misskey daemon</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">User</span>=misskey</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/npm start</span><br><span class="line"><span class="attr">WorkingDirectory</span>=/home/misskey/.opt/misskey</span><br><span class="line"><span class="attr">Environment</span>=<span class="string">&quot;NODE_ENV=production&quot;</span></span><br><span class="line"><span class="attr">TimeoutSec</span>=<span class="number">60</span></span><br><span class="line"><span class="attr">StandardOutput</span>=syslog</span><br><span class="line"><span class="attr">StandardError</span>=syslog</span><br><span class="line"><span class="attr">SyslogIdentifier</span>=misskey</span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure><p>然后分别通过 <code>sudo systemctl start misskey</code> 和 <code>sudo systemctl enable misskey</code> 启动 misskey 并添加开机自启。</p><h3 id="端口转发（反向代理）和-TLS"><a href="#端口转发（反向代理）和-TLS" class="headerlink" title="端口转发（反向代理）和 TLS"></a>端口转发（反向代理）和 TLS</h3><p>misskey 支持 HTTPS/SSL/TLS 。这需要配置相关证书，并设置端口转发（反向代理）。笔者使用的软件包是 nginx，并已在 Cloudflare 添加一个域名。</p><p><strong>注意</strong>：部分免费二级域名（如 .cf、.tk）无法使用后文中提及的 Cloudflare API 自动更新 DNS 记录。请读者自行选用其他域名，或使用其他 DNS 服务。</p><h4 id="证书"><a href="#证书" class="headerlink" title="证书"></a>证书</h4><p>首先安装自动签发 Let’s Encrypt 证书的软件包 certbot：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install certbot certbot-cloudflare-dns</span><br></pre></td></tr></table></figure><p>为防止证书信息泄露（certbot 默认工作和日志目录均在 <code>/etc</code>、<code>/var</code> 等文件夹中），先创建相关文件夹：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 工作目录、日志目录、配置目录（存放证书）</span></span><br><span class="line">mkdir -p ~/.var/letsencrypt ~/.logs/letsencrypt ~/.etc/letsencrypt</span><br></pre></td></tr></table></figure><p>再写入 Cloudflare API 的相关配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/.secrets/certbot</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;dns_cloudflare_api_token = &#123;API_TOKEN&#125;&#x27;</span> &gt; ~/.secrets/certbot/cloudflare.ini</span><br></pre></td></tr></table></figure><p>其中 <code>&#123;API_TOKEN&#125;</code> 表示 Cloudflare 账户的 API token。请参见 Cloudflare 和 Certbot 相关文档配置。</p><p>为保证安全性，建议为其重新配置权限：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod -R 700 ~/.secrets</span><br><span class="line">chmod -R 600 ~/.secrets/certbot/cloudflare.ini</span><br></pre></td></tr></table></figure><p>最后，在终端中执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 此处使用 Cloudflare API 更新 DNS</span></span><br><span class="line">certbot certonly --dns-cloudflare --dns-cloudflare-credentials ~/.secrets/certbot/cloudflare.ini -d <span class="string">&#x27;&#123;domain&#125;&#x27;</span> --config-dir ~/.etc/letsencrypt --work-dir ~/.var/letsencrypt --logs-dir ~/.logs/letsencrypt</span><br></pre></td></tr></table></figure><p>其中 <code>&#39;&#123;domain&#125;&#39;</code> 是为 misskey 分配的域名。certbot 运行过程中需要同意相关服务条款并输入邮箱注册。</p><h4 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h4><p>在 DNS 服务商（如 Cloudflare）中添加一条 A/AAAA 记录，从域名指向服务器的 IP 地址。</p><h4 id="端口转发（反向代理）"><a href="#端口转发（反向代理）" class="headerlink" title="端口转发（反向代理）"></a>端口转发（反向代理）</h4><p>在终端中执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S nginx-mainline --needed</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> nginx --now</span><br></pre></td></tr></table></figure><p>再打开 <code>/etc/nginx/nginx.conf</code>，添加如下类似的配置项：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span>  <span class="string">&#x27;&#123;domain&#125;&#x27;</span>;</span><br><span class="line">    <span class="attribute">error_log</span>    /var/log/nginx/log.log;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /home/misskey/.etc/letsencrypt/live/<span class="string">&#x27;&#123;domain&#125;&#x27;</span>/fullchain.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /home/misskey/.etc/letsencrypt/live/<span class="string">&#x27;&#123;domain&#125;&#x27;</span>/privkey.pem;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">5m</span>;</span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:3000;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP $remote_addr;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host $http_host;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Referer http://$host;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中 <code>&#39;&#123;domain&#125;&#39;</code> 表示分配的域名。证书路径以实际情况为准。</p><p>最后重启 nginx 服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure><h4 id="misskey-1"><a href="#misskey-1" class="headerlink" title="misskey"></a>misskey</h4><p>打开 misskey 配置文件 <code>~/.opt/misskey/.config/default.yml</code>，修改如下配置项：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#   ┌─────┐</span></span><br><span class="line"><span class="comment">#───┘ URL └─────────────────────────────────────────────────────</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Final accessible URL seen by a user.</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">&#x27;&#123;domain&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>设置为先前分配的域名。</p><p>最后重启 misskey 服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart misskey</span><br></pre></td></tr></table></figure><h2 id="特别致谢"><a href="#特别致谢" class="headerlink" title="特别致谢"></a>特别致谢</h2><p>感谢一位朋友“梦可味”在撰写本文前提供的在 Ubuntu 发行版中安装 misskey 的教程，其上有对多处踩坑的详细记录，让笔者能更快速地完成安装。之后会发布 misskey 在 Ubuntu 下的安装及配置教程。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://misskey-hub.net/en/docs/install/manual.html">misskey 官方文档</a></li><li><a href="https://www.garron.me/en/bits/build-essential-arch-linux.html">build-essential in Arch Linux</a></li><li><a href="https://wiki.archlinux.org/title/Users_and_groups">Users and groups - ArchWiki</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://misskey-hub.net/en/&quot;&gt;misskey&lt;/a&gt; 是一款开源的“跨星际”（interplanetary）社交平台，以微博为主要形式，界面美观，内含元素丰富。本文即针对该平台在 Arch Linux 的手动安装方式作说明。&lt;/p&gt;</summary>
    
    
    
    <category term="Essay" scheme="https://blog.imakiseki.cf/categories/Essay/"/>
    
    
    <category term="Arch Linux" scheme="https://blog.imakiseki.cf/tags/Arch-Linux/"/>
    
    <category term="misskey" scheme="https://blog.imakiseki.cf/tags/misskey/"/>
    
  </entry>
  
  <entry>
    <title>Arch Linux 物理机安装大体思路和部分实现细节（MBR &amp; GPT）</title>
    <link href="https://blog.imakiseki.cf/techdev/arch/installation/"/>
    <id>https://blog.imakiseki.cf/techdev/arch/installation/</id>
    <published>2022-04-28T12:18:05.000Z</published>
    <updated>2022-07-13T14:36:50.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>作为<a href="https://wiki.archlinux.org/title/Installation_guide">官方文档</a>的补充，大致提供一些安装 Arch Linux 到物理机上并安装桌面环境的思路和文档中未提及的细节。</p><span id="more"></span><h2 id="设备"><a href="#设备" class="headerlink" title="设备"></a>设备</h2><p>本文的主要篇幅将建立在如下几个设备之上：</p><ul><li>主力机<ul><li>操作系统：Manjaro x86_64</li><li>用途：下载并烧录镜像、为目标机器提供网络服务、<em>远程操作</em>、应急使用等</li></ul></li><li>目标机器<ul><li>操作系统：Windows 7 Utimate x86_64</li><li>磁盘数量：1</li><li>磁盘记录类型：MBR</li><li>启动类型：BIOS</li><li>目标：与 Windows 并存安装 Arch Linux</li></ul></li><li>U 盘<ul><li>总容量：8 GB</li><li>用途：烧录 Arch Linux 镜像</li></ul></li></ul><p>在文末，会对磁盘记录类型为 GPT、启动类型为 UEFI 的设备的安装过程，及图形界面其他的安装方案作一些说明。</p><p><strong>注意</strong>：强烈建议为主力机增添显示器、键盘等外设（对笔记本电脑等已有的除外），并在完全配置好网络环境前使用有线网络，防止因安装过程出现问题导致无法联网时难以检修。</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h3><p>建议在安装 Arch Linux 前分区，或是分出空闲空间，避免因不熟悉命令行环境或参数不直观导致数据丢失。笔者选择后者。</p><p>对于主力机是 Linux 的读者，可以使用 <code>gparted</code> 工具进行分区；对于 Windows 读者，可以使用 Disk Genius 工具进行分区。<strong>需要注意的是</strong>，gparted 底层使用 <code>parted</code> 命令行工具，而该工具在调整分区时无法调整分区头部位置。因此，对于有多启动需求的读者，建议在 Windows 下使用 Disk Genius 工具分区。若主力机上无 Windows 分区，可以在其他可移动介质中安装用于维护的 Windows PE 系统。</p><p>笔者的设备已有 BIOS/MBR 类型的 Windows 存在，安装时更加方便。对于大部分使用 UEFI/GPT 类型的读者，请参照<a href="https://wiki.archlinux.org/title/Arch_boot_process#Boot_loader">官方文档</a>。两种类型的设备的安装过程没有太大差异，且互联网上已有诸多相关的资料供读者参考。但若在安装后出现无法加载 Linux 或其它系统的情况（尤其是 UEFI/GPT 类型），排除软件原因后，考虑升级主板或更换相关硬件。</p><p>笔者的分区方案是：</p><table><thead><tr><th align="center">分区</th><th align="center">文件类型</th><th align="center">大小</th><th align="center">格式化</th><th align="center">启动项</th><th align="center">挂载点</th><th align="center"><strong>安装镜像环境</strong>中的挂载点</th></tr></thead><tbody><tr><td align="center"><code>/dev/sda1</code></td><td align="center">HPFS/NTFS/exFAT</td><td align="center">65GB</td><td align="center">否</td><td align="center">是</td><td align="center"></td><td align="center"></td></tr><tr><td align="center"><code>/dev/sda2</code></td><td align="center">HPFS/NTFS/exFAT</td><td align="center">312.8GB</td><td align="center">否</td><td align="center">否</td><td align="center"></td><td align="center"></td></tr><tr><td align="center"><code>/dev/sda3</code></td><td align="center">Linux swap / Solaris</td><td align="center">8GB</td><td align="center">是</td><td align="center">否</td><td align="center">[SWAP]</td><td align="center"></td></tr><tr><td align="center"><code>/dev/sda4</code></td><td align="center">Linux</td><td align="center">80GB</td><td align="center">是</td><td align="center">否</td><td align="center"><code>/</code></td><td align="center"><code>/mnt</code></td></tr></tbody></table><p>其中，“挂载点”表示该分区在<strong>安装后</strong>操作系统中的路径，“<strong>安装镜像环境</strong>中的挂载点”表示该分区在<strong>当前环境</strong>（安装镜像环境）中的路径。</p><h3 id="烧录镜像"><a href="#烧录镜像" class="headerlink" title="烧录镜像"></a>烧录镜像</h3><p>终端执行 <code>sudo fdisk -l</code> 记录需要写入镜像的 U 盘的设备路径。根据<a href="https://wiki.archlinux.org/title/USB_flash_installation_medium#Using_basic_command_line_utilities">官方文档</a>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dd bs=4M <span class="keyword">if</span>=/path/to/archlinux-version-x86_64.iso of=/dev/sdx conv=fsync oflag=direct status=progress</span><br></pre></td></tr></table></figure><p>注意写入后 U 盘的卷标应形如 <code>ARCH_YYYYDD</code>，其中 <code>YYYY</code> 和 <code>DD</code> 表示镜像版本号中的年份和月份。若不是，建议手动更改。</p><h3 id="U-盘启动"><a href="#U-盘启动" class="headerlink" title="U 盘启动"></a>U 盘启动</h3><p>U 盘启动成功后进入镜像内置的简易操作系统。与其他发行版镜像稍有不同的是，Arch Linux 镜像默认终端为 <code>zsh</code>，且相比于用户实装的 Arch Linux 内置有更多有利于系统安装和调试的工具。</p><p>正常启动后，屏幕显示的应该类似于：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">To install Arch Linux follow the installation guide:</span><br><span class="line">https://wiki.archlinux.org/title/Installation_guide</span><br><span class="line"></span><br><span class="line">For Wi-Fi, authenticate to the wireless network using the iwctl utility.</span><br><span class="line">For mobile broadband (WWAN) modems, connect with the mmcli utility.</span><br><span class="line">Ethernet, WLAN and WWAN interfaces using DHCP should work automatically.</span><br><span class="line"></span><br><span class="line">After connecting to the internet, the installation guide can be accessed</span><br><span class="line">via the convenience script Installation_guide.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Last login: Mon Apr 25 18:11:37 2022 from 10.42.0.1</span><br><span class="line">root@archiso ~ #</span><br></pre></td></tr></table></figure><p>并且文字有多种颜色（上方有一行全是空格，在屏幕上实则是不同颜色的色块（经常用于做终端颜色测试））。</p><p>而读者若发现屏幕上显示的类似于：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">:: Mounting &#x27;/dev/disk/by-label/ARCH_202204&#x27; to &#x27;/run/archiso/bootmnt&#x27;</span><br><span class="line">Waiting 30 seconds for device /dev/disk/by-label/ARCH_202204 ...</span><br><span class="line">ERROR: &#x27;/dev/disk/by-label/ARCH_202204&#x27; device did not show up after 30 seconds...</span><br><span class="line">   Falling back to interactive prompt</span><br><span class="line">   You can try to fix the problem manually, log out when you are finished</span><br><span class="line">sh: can&#x27;t access tty: job control turned off</span><br><span class="line">[rootfs ]#</span><br></pre></td></tr></table></figure><p>说明 Arch Linux 安装镜像未找到设备（也就是 U 盘）。出现这种情况，一种原因是如上所述的未修改 U 盘的卷标。而另一种可能的原因则出在硬件上。先在终端上执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls /dev/disk/by-label</span><br></pre></td></tr></table></figure><p>出现的条目中，若有类似 U 盘卷标的，尝试挂载：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /mnt</span><br><span class="line">mount /dev/disk/by-label/&lt;卷标&gt; /mnt</span><br></pre></td></tr></table></figure><p>若发现无法挂载，或挂载成功后发现其并非 U 盘的，则说明可能出现了上述硬件问题。此时尝试重新插拔 U 盘，再执行 <code>ls /dev/disk/by-label</code>。若发现形如“ARCH_YYYYDD”的条目出现，则执行 <code>exit</code> 开始安装系统。</p><p>另外，有必要检测 U 盘启动时的“启动模式”。执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls /sys/firmware/efi/efivars</span><br></pre></td></tr></table></figure><p>若没有输出，则表示 U 盘在 BIOS 模式启动；反之，则为 UEFI 模式。若启动模式与预计不符，请考虑修改 BIOS 相关的设置。</p><h3 id="远程登入"><a href="#远程登入" class="headerlink" title="远程登入"></a>远程登入</h3><p>上文中笔者提到了“<em>远程操作</em>”。Arch Linux 安装镜像中内置 <code>ssh</code>，可以使用 ssh 远程登入进行安装。需要注意的是，笔者远程登入目标机器是为了方便截取终端上的文字，而考虑到 ssh 连接中断可能导致中断安装进程，<strong>不建议</strong>这么做。若确实需要，在终端中执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><p>在文本编辑器中找到：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># To disable tunneled clear text passwords, change to no here!</span><br><span class="line">#PasswordAuthentication yes</span><br><span class="line">#PermitEmptyPasswords no</span><br></pre></td></tr></table></figure><p>将其修改为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># To disable tunneled clear text passwords, change to no here!</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">PermitEmptyPasswords yes</span><br></pre></td></tr></table></figure><p>按 <code>Ctrl+X</code>，再按 <code>y</code> 保存文件，执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure><p>重启 ssh 服务后，尝试登入。</p><h3 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h3><p>本节对应<a href="https://wiki.archlinux.org/title/Installation_guide">官方文档</a>中“<a href="https://wiki.archlinux.org/title/Installation_guide#Boot_the_live_environment">Boot the live environment</a>”小节到“<a href="https://wiki.archlinux.org/title/Installation_guide#Reboot">Reboot</a>”小节。大多数情况下只需要根据目标机器的环境修改少数参数就可以直接执行上面的代码。</p><h4 id="网络服务"><a href="#网络服务" class="headerlink" title="网络服务"></a>网络服务</h4><p>正如官方文档中提到的那样，安装镜像中的系统与用户实际使用的系统并不完全相同，在前者环境中能够正常运作的机能可能在后者环境中便会失灵。“<a href="https://wiki.archlinux.org/title/Installation_guide#Install_essential_packages">Install essential packages</a>”小节中也提到了一些可选的在安装系统时即配置的软件包，不过其中最重要的是网络服务相关的包。若不能保证离开安装镜像环境后 Arch Linux 的网络通信正常，读者可以自行安装相关的包，必要时可提前配置。</p><p>另外，对命令行环境不熟悉或读写配置文件不顺畅的读者，可以安装 <code>nmtui</code>，用以在交互式环境下管理网络服务。笔者选择的包为：<code>net-tools</code>、<code>iproute2</code>、<code>dhcpcd</code>、<code>traceroute</code>、<code>networkmanager</code>（<code>nmtui</code> 被包含在该包中）。</p><h4 id="文本编辑器"><a href="#文本编辑器" class="headerlink" title="文本编辑器"></a>文本编辑器</h4><p>后续的安装操作需要读写配置文件，因此建议安装 <code>vim</code> 或 <code>nano</code> 等文本编辑相关的包。</p><h4 id="Boot-loader"><a href="#Boot-loader" class="headerlink" title="Boot loader"></a>Boot loader</h4><p>这需要读者仔细阅读官方文档（如 <a href="https://wiki.archlinux.org/title/GRUB">GRUB</a>）的<strong>全文</strong>。绝大多数可能的情况在文档中都有描述。对于笔者的设备，笔者使用 GRUB 做了如下操作，以保证 NTFS 分区下的 Windows 能被 GRUB 识别（假定已经 <code>arch-chroot</code> 进入系统）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pacman -S os-prober grub ntfs-3g</span><br><span class="line">grub-install --target=i386-pc /dev/sda</span><br><span class="line"><span class="comment"># 修改 `/etc/default/grub`，将 `#GRUB_DISABLE_OS_PROBER=false` 一行的注释去除</span></span><br><span class="line">grub-mkconfig -o /boot/grub/grub.cfg</span><br></pre></td></tr></table></figure><p>确认无误后，执行后续安装步骤。</p><h2 id="安装后"><a href="#安装后" class="headerlink" title="安装后"></a>安装后</h2><p>读者可以在<a href="https://wiki.archlinux.org/title/General_recommendations">官方文档</a>中阅读有关安装后推荐的行动。</p><h3 id="桌面环境"><a href="#桌面环境" class="headerlink" title="桌面环境"></a>桌面环境</h3><p>笔者选择的桌面环境是：</p><ul><li>显示服务器：<a href="https://wiki.archlinux.org/title/Xorg">Xorg</a>（优先安装）</li><li>显示管理器：<a href="https://wiki.archlinux.org/title/SDDM">SDDM</a></li><li>桌面环境：<a href="https://wiki.archlinux.org/title/KDE">KDE</a></li></ul><p>这些在 Arch Linux Wiki 上都有同名词条，且描述得十分详细。这里不作赘述。即便在安装桌面环境后未能正常显示桌面，也可以使用其他 TTY 在终端下操作。</p><p>对于其中涉及的安装包，笔者不建议安装元包（包名含“-meta”）。这是考虑到：</p><ul><li>一般安装桌面环境所需的包后，无彻底卸载的需求；</li><li>应用程序相关的组件中若有想卸载的，由于这些组件都是元包的依赖项，此时无法完成卸载。</li></ul><p>若不慎安装元包，也可以在 Live CD 环境中卸载元包后重新安装组包（包名不含“-meta”，安装时需要选择组别）。结束后执行 <code>pacman -Qsq &lt;包名&gt;</code> 验证。</p><h4 id="多用户登录界面"><a href="#多用户登录界面" class="headerlink" title="多用户登录界面"></a>多用户登录界面</h4><p>如果读者需要在开机时启动桌面环境，<a href="https://wiki.archlinux.org/title/Xinit#Autostart_X_at_login">官方文档</a>给出了一种方案。但直接按照文档配置，会发现启动计算机后仍然停留在 TTY1 的终端登录页面，输入用户名后跳过输入密码阶段直接进入桌面环境。这显然不是我们所期待的。修复这个问题很简单，只需要将所给的配置项</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;DISPLAY&#125;</span>&quot;</span> ] &amp;&amp; [ <span class="string">&quot;<span class="variable">$&#123;XDG_VTNR&#125;</span>&quot;</span> -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">exec</span> startx</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>放置在系统配置文件 <code>/etc/profile</code> 中即可。</p><h3 id="本地化"><a href="#本地化" class="headerlink" title="本地化"></a>本地化</h3><p>参见<a href="/techdev/arch/localization-simplified-chinese">《【Arch Linux】本地化：简体中文》</a>和<a href="/techdev/arch/localization-japanese">《【Arch Linux】本地化：日语》</a>。</p><h2 id="UEFI-和-GPT"><a href="#UEFI-和-GPT" class="headerlink" title="UEFI 和 GPT"></a>UEFI 和 GPT</h2><p>以下所列同样仅是笔者机器的情况。请读者根据遇到的情况自行判断。</p><h3 id="分区-1"><a href="#分区-1" class="headerlink" title="分区"></a>分区</h3><p>根据笔者机器情况，笔者设计的分区方案如下：</p><table><thead><tr><th align="center">分区</th><th align="center">文件类型</th><th align="center">启动项</th><th align="center">挂载点</th><th align="center"><strong>安装镜像环境</strong>中的挂载点</th></tr></thead><tbody><tr><td align="center"><code>/dev/sda1</code></td><td align="center">Linux</td><td align="center">是</td><td align="center"><code>/boot</code></td><td align="center"><code>/mnt/boot</code></td></tr><tr><td align="center"><code>/dev/sda5</code></td><td align="center">Linux</td><td align="center">否</td><td align="center"><code>/</code></td><td align="center"><code>/mnt</code></td></tr><tr><td align="center"><code>/dev/sdb4</code></td><td align="center">Linux</td><td align="center">否</td><td align="center"><code>/home</code></td><td align="center"><code>/mnt/home</code></td></tr><tr><td align="center"><code>/dev/sdb5</code></td><td align="center">Linux</td><td align="center">否</td><td align="center"><code>/usr</code></td><td align="center"><code>/mnt/usr</code></td></tr><tr><td align="center"><code>/dev/sdb6</code></td><td align="center">Linux swap / Solaris</td><td align="center">否</td><td align="center">[SWAP]</td><td align="center"></td></tr></tbody></table><p>注意到这里 <code>/usr</code> 和 <code>/</code>、<code>/boot</code> 分属不同的硬盘。此类情况将在后文加以说明。</p><h3 id="U-盘启动无法找到盘符的问题"><a href="#U-盘启动无法找到盘符的问题" class="headerlink" title="U 盘启动无法找到盘符的问题"></a>U 盘启动无法找到盘符的问题</h3><p>尝试在 UEFI+GPT 的机器上安装时，未出现此问题。</p><h3 id="Boot-loader-1"><a href="#Boot-loader-1" class="headerlink" title="Boot loader"></a>Boot loader</h3><p>笔者仍然使用 GRUB，但所执行的命令需要更改：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB</span><br></pre></td></tr></table></figure><p>这将在 <code>/boot/EFI</code> 文件夹中生成 <code>GRUB</code> 文件夹。一些旧教程中添加了诸如 <code>/dev/sda</code>、<code>/dev/sdb</code> 的参数，但现在实则是不需要的。</p><h3 id="usr-单独分区导致启动失败"><a href="#usr-单独分区导致启动失败" class="headerlink" title="/usr 单独分区导致启动失败"></a><code>/usr</code> 单独分区导致启动失败</h3><p>按照类似笔者的方案分区后，启动系统将失败，并显示类似如下的界面：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/dev/sda1: recovering journal</span><br><span class="line">Error:Root device mounted successfully, but /sbin/init does not exist.</span><br><span class="line">Bailing out, you are on your own.Good luck.</span><br><span class="line"></span><br><span class="line">sh: can&#x27;t access tty; job control turned off</span><br><span class="line">[rootfs ]#</span><br></pre></td></tr></table></figure><p>根据<a href="https://wiki.archlinux.org/title/Mkinitcpio#/usr_as_a_separate_partition">官方文档</a>的说明，读者需要重新进入 Live CD 环境，挂载所有分区后 <code>arch-chroot</code> 进入 chroot 环境。编辑其中的 <code>/etc/mkinitcpio.conf</code> 文件，修改类似如下的行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HOOKS=(base udev autodetect modconf block filesystems keyboard fsck)</span><br></pre></td></tr></table></figure><p>为</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HOOKS=(base udev autodetect modconf block filesystems keyboard fsck usr shutdown)</span><br></pre></td></tr></table></figure><p>随后重制镜像并重启：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkinitcpio -P</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><h2 id="Wayland"><a href="#Wayland" class="headerlink" title="Wayland"></a>Wayland</h2><p>Wayland 也是一种显示服务协议（display server protocol），致力于成为 Xorg 的优秀后继者。Wayland 亦有兼容 Xorg 和 KDE 的实现，且 SDDM 依然能使用，但在 KDE 环境中并无相对 Xorg 的明显优势。</p><p>参照<a href="https://wiki.archlinux.org/title/KDE#Installation">官方文档</a>在 Xorg 基础上安装 Wayland 相关的包，并在登录界面左上角选择桌面为“Plasma (Wayland)”。</p><p>注意使用 Wayland 作为显示服务协议时，一些教程中涉及到 <code>.xprofile</code> 等配置文件将会失效。读者需要根据实际情况正确配置。在此不作赘述。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;作为&lt;a href=&quot;https://wiki.archlinux.org/title/Installation_guide&quot;&gt;官方文档&lt;/a&gt;的补充，大致提供一些安装 Arch Linux 到物理机上并安装桌面环境的思路和文档中未提及的细节。&lt;/p&gt;</summary>
    
    
    
    <category term="Essay" scheme="https://blog.imakiseki.cf/categories/Essay/"/>
    
    <category term="Tutorial" scheme="https://blog.imakiseki.cf/categories/Essay/Tutorial/"/>
    
    
    <category term="Arch Linux" scheme="https://blog.imakiseki.cf/tags/Arch-Linux/"/>
    
    <category term="Operating System" scheme="https://blog.imakiseki.cf/tags/Operating-System/"/>
    
    <category term="Boot Loader" scheme="https://blog.imakiseki.cf/tags/Boot-Loader/"/>
    
    <category term="Desktop" scheme="https://blog.imakiseki.cf/tags/Desktop/"/>
    
  </entry>
  
  <entry>
    <title>蓝桥杯真题：分巧克力</title>
    <link href="https://blog.imakiseki.cf/acmoi/lanqiao/fen-qiao-ke-li/"/>
    <id>https://blog.imakiseki.cf/acmoi/lanqiao/fen-qiao-ke-li/</id>
    <published>2022-03-19T01:55:58.000Z</published>
    <updated>2022-03-19T03:16:40.921Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>蓝桥杯 2017 年省赛真题《分巧克力》的 Python 解法。</p></blockquote><span id="more"></span><p>蓝桥杯 2017 年省赛真题：分巧克力。</p><p>题目链接：<a href="https://www.lanqiao.cn/problems/99/learning/">https://www.lanqiao.cn/problems/99/learning/</a>（需要登录）。</p><h2 id="题目大意"><a href="#题目大意" class="headerlink" title="题目大意"></a>题目大意</h2><p>将 $N$ 块大小为 $H_i\times W_i$ 的巧克力切出部分分给 $K$ 人，要求分给 $K$ 人的巧克力大小相等且都为边长是整数的正方形。求可能分法中每人巧克力的边长最大值（测试点保证答案不小于 $1$）。</p><h3 id="数据范围"><a href="#数据范围" class="headerlink" title="数据范围"></a>数据范围</h3><p>$1\leq N,K,H_i,W_i\leq10^5$。</p><h3 id="运行限制"><a href="#运行限制" class="headerlink" title="运行限制"></a>运行限制</h3><ul><li>时间限制：2s。</li></ul><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><p>注意到数据范围上限都是 $10^5$，可以猜测本题一解的时间复杂度为 $O(N\log N)$，继而联想到二分法。</p><p>那本题如何绕到二分上呢？先看选定不同的边长对分巧克力过程的影响。从题目中可知若记切出的巧克力的边长为 $a$，能切出 $b$ 块满足题设条件的巧克力，那么所有边长小于 $a$ 的切法均能切出<strong>不少于</strong> $b$ 块巧克力。换言之，若将考察范围内的边长排成一个序列，一定存在某个元素 $a_\mathrm{ans}$，使得在它之前的边长以及它本身<strong>都是</strong>满足题设条件的分法，而在它之后的边长<strong>都不满足</strong>——这就说明这个序列可以视作有序的，其元素值仅能被划分到“满足条件的”和“不满足条件的”两类中，而我们则需要找到这两类元素的“分界线”——这正是二分法的一种典型应用。</p><p>此外，我们发现，对于给定的边长 $a$ 和大小为 $H_i\times W_i$ 的巧克力，如果尽可能一块紧挨着一块切分，可以达到最大份数，具体数值为 $\left\lfloor\dfrac{H_i}{a}\right\rfloor\left\lfloor\dfrac{W_i}{a}\right\rfloor$。这也说明判断某个边长是否满足题设条件的时间复杂度为 $O(N)$。结合上述二分的描述过程，此解法的时间复杂度恰好为 $O(N\log N)$。</p><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><h3 id="Python-1"><a href="#Python-1" class="headerlink" title="Python"></a>Python</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">n, k = <span class="built_in">map</span>(<span class="built_in">int</span>, sys.stdin.readline().rstrip().split())</span><br><span class="line">h, w = [<span class="literal">None</span>] * n, [<span class="literal">None</span>] * n</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    h[i], w[i] = <span class="built_in">map</span>(<span class="built_in">int</span>, sys.stdin.readline().rstrip().split())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 考察范围的上限为所有巧克力中长和宽的最大值</span></span><br><span class="line">maxh, maxw = <span class="built_in">max</span>(h), <span class="built_in">max</span>(w)</span><br><span class="line">maxhw = <span class="built_in">max</span>(maxh, maxw)</span><br><span class="line"><span class="comment"># f[i] 为某个边长 i 是否满足题设条件</span></span><br><span class="line">f = [<span class="literal">None</span>] * (maxhw + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参考：Python 安装目录下 Lib/bisect.py</span></span><br><span class="line"><span class="comment"># 注意：在更高 Python 版本中，内置模块 bisect 支持在二分查找和排序中加入 `key` 参数，若将判断边长是否符合条件的过程写成函数，则可以</span></span><br><span class="line"><span class="comment"># 直接代入 `bisect.bisect_left()`，且该内置函数经过 C 语言优化，运行速度更快。</span></span><br><span class="line">lo, hi = <span class="number">1</span>, maxhw + <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> lo &lt; hi:</span><br><span class="line">    mid = (lo + hi) // <span class="number">2</span></span><br><span class="line">    <span class="comment"># 若 `f[mid]` 未被计算出，则开始计算</span></span><br><span class="line">    <span class="keyword">if</span> f[mid] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        s = <span class="number">0</span>  <span class="comment"># 可分出的巧克力块数</span></span><br><span class="line">        f[mid] = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">            s += (h[i] // mid) * (w[i] // mid)</span><br><span class="line">            <span class="comment"># 本题无需计算出分出巧克力的具体块数，则在判断出其已经超过 `k` 时直接跳出</span></span><br><span class="line">            <span class="keyword">if</span> s &gt;= k:</span><br><span class="line">                f[mid] = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> f[mid] == <span class="literal">True</span>:</span><br><span class="line">        lo = mid + <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        hi = mid</span><br><span class="line"></span><br><span class="line"><span class="comment"># `lo` 即为 `bisect.bisect_left()` 的返回值，其为不符合题设条件的边长最小值</span></span><br><span class="line"><span class="built_in">print</span>(lo - <span class="number">1</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;蓝桥杯 2017 年省赛真题《分巧克力》的 Python 解法。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="essay" scheme="https://blog.imakiseki.cf/categories/essay/"/>
    
    
    <category term="Programming" scheme="https://blog.imakiseki.cf/tags/Programming/"/>
    
    <category term="ACM" scheme="https://blog.imakiseki.cf/tags/ACM/"/>
    
    <category term="OI" scheme="https://blog.imakiseki.cf/tags/OI/"/>
    
    <category term="Lanqiao" scheme="https://blog.imakiseki.cf/tags/Lanqiao/"/>
    
    <category term="Problem" scheme="https://blog.imakiseki.cf/tags/Problem/"/>
    
    <category term="Python" scheme="https://blog.imakiseki.cf/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>蓝桥杯真题：纯质数</title>
    <link href="https://blog.imakiseki.cf/acmoi/lanqiao/chun-zhi-shu/"/>
    <id>https://blog.imakiseki.cf/acmoi/lanqiao/chun-zhi-shu/</id>
    <published>2022-03-11T15:39:56.000Z</published>
    <updated>2022-03-11T16:37:45.551Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>蓝桥杯 2021 年国赛真题《纯质数》的 Python 解法。</p></blockquote><span id="more"></span><p>蓝桥杯 2021 年国赛真题：纯质数。</p><p>题目链接：<a href="https://www.lanqiao.cn/problems/1561/learning/">https://www.lanqiao.cn/problems/1561/learning/</a>（需要登录）。</p><h2 id="题目大意"><a href="#题目大意" class="headerlink" title="题目大意"></a>题目大意</h2><p>输出 1 到 20210605 之间（包括两端）的“纯质数”（指十进制各数位皆为质数的质数，1 不视作质数）。</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><p>本题是填空题，原则上无需时间复杂度较低的程序也可被接受。当然，这里将给出非填空题的解法。</p><p>Python 在大数据规模的循环上耗时较大，而本题显然绕不开判断质数这一话题——乍看本题给出的数据规模达到了千万级，判断其是否为质数最坏情况下需要千级别的循环，而我们要判断 20210605 个数字是否为质数，这个耗时显然是不可接受的（预测在 C/C++ 下也难以接受）。</p><p>因此我们可以考虑<strong>能否降低需要判断是否为质数的数字的数量</strong>。注意到本题中所提到的“纯质数”不仅要求其本身是质数，还要求十进制各数位也为质数——这下我们可以先借此排除掉<strong>一定</strong>不是纯质数的数字，继而大大简化运算量。</p><p>经过分析，我们得知如果一个数要满足“十进制各数位为质数”这一条件，必须满足各个数位只可取 2、3、5、7 中的一个。粗略来看，我们省下了约五分之三的运算量。而更进一步，对于不小于 10 的数字，个位数若为 2 或 5，则一定是合数，故也可提前去除。</p><p>为了更好地实现上面的需求，我们最好是自行生成纯质数的“候选”，而不是生成一个长度为 20210605 的列表再删除不符合条件的。每一个数位有可以选择的数字，而这些选择都是<strong>互不干扰</strong>的，因此我们可以利用标准库 <code>itertools</code> 里的 <code>product()</code> 生成器生成笛卡尔积，以便于快速生成符合条件的数字。实现这一需求的主要代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> product</span><br><span class="line"></span><br><span class="line"><span class="comment"># （不小于 10 的数字）非个位可取的数字集合、个位可取的数字集合</span></span><br><span class="line">_a, _b = (<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>), (<span class="number">3</span>, <span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成“候选”数字的生成器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">candidate_gen</span>():</span></span><br><span class="line">    <span class="comment"># 1 位数</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> _a:</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line">    <span class="comment"># 2~8 位数</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, <span class="number">9</span>):</span><br><span class="line">        <span class="comment"># star expression，表示生成 (i-1) 个 `_a`，一个 `_b`</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> product(*([_a] * (i-<span class="number">1</span>)), _b):</span><br><span class="line">            <span class="comment"># `j` 是一个由各个数位组成的元组，需要先将其拼成一个整数</span></span><br><span class="line">            x = packtup(j)</span><br><span class="line">            <span class="comment"># 超出范围，终止生成</span></span><br><span class="line">            <span class="keyword">if</span> x &gt; <span class="number">20210605</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">yield</span> x</span><br></pre></td></tr></table></figure><p>判断质数的代码较为简单，在此不作详述，注意设置循环时除数的上限略高于目标数字的算术平方根即可。</p><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><h3 id="Python-1"><a href="#Python-1" class="headerlink" title="Python"></a>Python</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> product</span><br><span class="line"></span><br><span class="line">_a, _b = (<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>), (<span class="number">3</span>, <span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">packtup</span>(<span class="params">t</span>):</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sum</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> i: t[::-<span class="number">1</span>][i] * <span class="number">10</span> ** i, <span class="built_in">range</span>(<span class="built_in">len</span>(t))))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">candidate_gen</span>():</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> _a:</span><br><span class="line">    <span class="keyword">yield</span> i</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, <span class="number">9</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> product(*([_a] * (i-<span class="number">1</span>)), _b):</span><br><span class="line">      x = packtup(j)</span><br><span class="line">      <span class="keyword">if</span> x &gt; <span class="number">20210605</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">yield</span> x</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">isprime</span>(<span class="params">x</span>):</span></span><br><span class="line">  <span class="keyword">if</span> x == <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">  <span class="keyword">if</span> x == <span class="number">2</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">  <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>, <span class="built_in">int</span>(x ** <span class="number">0.5</span>) + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">if</span> x % i == <span class="number">0</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(<span class="built_in">list</span>(<span class="built_in">filter</span>(isprime, candidate_gen()))))</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;蓝桥杯 2021 年国赛真题《纯质数》的 Python 解法。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="essay" scheme="https://blog.imakiseki.cf/categories/essay/"/>
    
    
    <category term="Programming" scheme="https://blog.imakiseki.cf/tags/Programming/"/>
    
    <category term="ACM" scheme="https://blog.imakiseki.cf/tags/ACM/"/>
    
    <category term="OI" scheme="https://blog.imakiseki.cf/tags/OI/"/>
    
    <category term="Lanqiao" scheme="https://blog.imakiseki.cf/tags/Lanqiao/"/>
    
    <category term="Problem" scheme="https://blog.imakiseki.cf/tags/Problem/"/>
    
    <category term="Python" scheme="https://blog.imakiseki.cf/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>【实测】Python 和 C++ 下字符串查找的速度对比</title>
    <link href="https://blog.imakiseki.cf/techdev/python-cpp-string-find-perf-test/"/>
    <id>https://blog.imakiseki.cf/techdev/python-cpp-string-find-perf-test/</id>
    <published>2022-03-07T09:12:48.000Z</published>
    <updated>2022-03-07T09:19:40.638Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>最近在备战一场算法竞赛，语言误选了 Python ，无奈只能着手对常见场景进行语言迁移。而字符串查找的场景在算法竞赛中时有出现。本文即对此场景在 Python 和竞赛常用语言 C++ 下的速度进行对比，并提供相关参数和运行结果供他人参考。</p></blockquote><span id="more"></span><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近在备战一场算法竞赛，语言误选了 Python ，无奈只能着手对常见场景进行语言迁移。而字符串查找的场景在算法竞赛中时有出现。本文即对此场景在 Python 和竞赛常用语言 C++ 下的速度进行对比，并提供相关参数和运行结果供他人参考。</p><h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><h3 id="硬件和操作系统"><a href="#硬件和操作系统" class="headerlink" title="硬件和操作系统"></a>硬件和操作系统</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">                  -`                    root@&lt;hostname&gt;</span><br><span class="line">                 .o+`                   ------------</span><br><span class="line">                `ooo/                   OS: Arch Linux ARM aarch64</span><br><span class="line">               `+oooo:                  Host: Raspberry Pi 4 Model B</span><br><span class="line">              `+oooooo:                 Kernel: 5.16.12-1-aarch64-ARCH</span><br><span class="line">              -+oooooo+:                Uptime: 3 hours, 32 mins</span><br><span class="line">            `/:-:++oooo+:               Packages: 378 (pacman)</span><br><span class="line">           `/++++/+++++++:              Shell: zsh 5.8.1</span><br><span class="line">          `/++++++++++++++:             Terminal: /dev/pts/0</span><br><span class="line">         `/+++ooooooooooooo/`           CPU: (4) @ 1.500GHz</span><br><span class="line">        ./ooosssso++osssssso+`          Memory: 102MiB / 7797MiB</span><br><span class="line">       .oossssso-````/ossssss+`</span><br><span class="line">      -osssssso.      :ssssssso.</span><br><span class="line">     :osssssss/        osssso+++.</span><br><span class="line">    /ossssssss/        +ssssooo/-</span><br><span class="line">  `/ossssso+/:-        -:/+osssso+-</span><br><span class="line"> `+sso+:-`                 `.-/+oso:</span><br><span class="line">`++:.                           `-/+/</span><br><span class="line">.`                                 `/</span><br></pre></td></tr></table></figure><h3 id="编译环境和解释环境"><a href="#编译环境和解释环境" class="headerlink" title="编译环境和解释环境"></a>编译环境和解释环境</h3><ul><li>Python<ul><li>解释器：Python 3.10.2 (main, Jan 23 2022, 21:20:14) [GCC 10.2.0] on linux</li><li>交互环境：IPython 8.0.1</li></ul></li><li>C++<ul><li>编译器：g++ (GCC) 11.2.0</li><li>编译命令：<code>g++ test.cpp -Wall -O2 -g -std=c++11 -o test</code></li></ul></li></ul><h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><p>本次实测设置两个场景：场景 1 的源串字符分布使用伪随机数生成器生成，表示字符串查找的平均情况；场景 2 的源串可连续分割成 20,000 个长度为 50 的字符片段，其中第 15,001 个即为模式串，形如“ab…b”（1 个“a”，49 个 “b”），其余的字符片段形如“ab…c”（1 个“a”，48 个“b”，1 个“c”）。</p><table><thead><tr><th align="center">项目</th><th align="center">场景 1：平均情况</th><th align="center">场景 2：较坏情况</th></tr></thead><tbody><tr><td align="center">字符集</td><td align="center">小写字母</td><td align="center"><code>abc</code></td></tr><tr><td align="center">字符分布</td><td align="center"><code>random.choice</code></td><td align="center">有较强规律性</td></tr><tr><td align="center">源串长度</td><td align="center">1,000,000</td><td align="center">1,000,000</td></tr><tr><td align="center">模式串长度</td><td align="center">1,000</td><td align="center">50</td></tr><tr><td align="center">模式串出现位置</td><td align="center">250,000、500,000、750,000</td><td align="center">750,000</td></tr><tr><td align="center">模式串出现次数</td><td align="center">1</td><td align="center">1</td></tr></tbody></table><h3 id="测试方法"><a href="#测试方法" class="headerlink" title="测试方法"></a>测试方法</h3><p>本次实测中，Python 语言使用内置类型 <code>str</code> 的 <code>.find()</code> 成员函数，C++ 语言分别使用 <code>string</code> 类的 <code>.find()</code> 成员函数、<code>strstr</code> 标准库函数和用户实现的 KMP 算法。</p><table><thead><tr><th align="center">测试对象</th><th align="center">核心代码</th></tr></thead><tbody><tr><td align="center">Python</td><td align="center"><code>src.find(pat)</code></td></tr><tr><td align="center">C++ - <code>test.cpp</code></td><td align="center"><code>src.find(pat)</code></td></tr><tr><td align="center">C++ - <code>test_strstr.cpp</code></td><td align="center"><code>strstr(src, pat)</code></td></tr><tr><td align="center">C++ - <code>test_kmp.cpp</code></td><td align="center"><code>KMP(src, pat)</code></td></tr></tbody></table><h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><h3 id="生成源串和模式串"><a href="#生成源串和模式串" class="headerlink" title="生成源串和模式串"></a>生成源串和模式串</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment"># 场景 1：</span></span><br><span class="line"><span class="comment"># 源串</span></span><br><span class="line">s = <span class="string">&quot;&quot;</span>.join(<span class="built_in">chr</span>(random.choice(<span class="built_in">range</span>(<span class="built_in">ord</span>(<span class="string">&quot;a&quot;</span>), <span class="built_in">ord</span>(<span class="string">&quot;z&quot;</span>) + <span class="number">1</span>))) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>))</span><br><span class="line"><span class="comment"># 模式串列表，三个元素各对应一个模式串</span></span><br><span class="line">p = [s[<span class="number">250000</span>:<span class="number">251000</span>], s[<span class="number">500000</span>:<span class="number">501000</span>], s[<span class="number">750000</span>:<span class="number">751000</span>]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 场景 2：</span></span><br><span class="line"><span class="comment"># 模式串</span></span><br><span class="line">p = <span class="string">&#x27;a&#x27;</span> + <span class="string">&#x27;b&#x27;</span> * <span class="number">49</span></span><br><span class="line"><span class="comment"># 其他字符片段</span></span><br><span class="line">_s = <span class="string">&quot;a&quot;</span> + <span class="string">&quot;b&quot;</span> * <span class="number">48</span> + <span class="string">&quot;c&quot;</span></span><br><span class="line"><span class="comment"># 源串</span></span><br><span class="line">s = _s * <span class="number">15000</span> + p + _s * <span class="number">4999</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 存储到文件，便于 C++ 程序获取</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;source.in&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(s)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;pattern.in&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(p[<span class="number">0</span>])</span><br></pre></td></tr></table></figure><h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><h4 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In []: %timeit s.find(p[<span class="number">0</span>])</span><br></pre></td></tr></table></figure><h4 id="C-test-cpp"><a href="#C-test-cpp" class="headerlink" title="C++ - test.cpp"></a>C++ - <code>test.cpp</code></h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOOP_COUNT (1000)</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> std::chrono::high_resolution_clock;</span><br><span class="line"><span class="keyword">using</span> std::chrono::duration_cast;</span><br><span class="line"><span class="keyword">using</span> std::chrono::duration;</span><br><span class="line"><span class="keyword">using</span> std::chrono::milliseconds;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">test</span><span class="params">(string s, string p, <span class="keyword">size_t</span>* pos_ptr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> t1 = high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">    *pos_ptr = s.<span class="built_in">find</span>(p);</span><br><span class="line">    <span class="keyword">auto</span> t2 = high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">    duration&lt;<span class="keyword">double</span>, milli&gt; ms_double = t2 - t1;</span><br><span class="line">    <span class="keyword">return</span> ms_double.<span class="built_in">count</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    string s, p;</span><br><span class="line">    <span class="keyword">size_t</span> pos;</span><br><span class="line">    <span class="function">ifstream <span class="title">srcfile</span><span class="params">(<span class="string">&quot;source.in&quot;</span>)</span></span>;</span><br><span class="line">    <span class="function">ifstream <span class="title">patfile</span><span class="params">(<span class="string">&quot;pattern.in&quot;</span>)</span></span>;</span><br><span class="line">    srcfile &gt;&gt; s;</span><br><span class="line">    patfile &gt;&gt; p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> tot_time = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; LOOP_COUNT; ++i) &#123;</span><br><span class="line">        tot_time += <span class="built_in">test</span>(s, p, &amp;pos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Loop count:            &quot;</span> &lt;&lt; LOOP_COUNT &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Source string length:  &quot;</span> &lt;&lt; s.<span class="built_in">length</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Pattern string length: &quot;</span> &lt;&lt; p.<span class="built_in">length</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Search result:         &quot;</span> &lt;&lt; pos &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Time:                  &quot;</span> &lt;&lt; tot_time / LOOP_COUNT &lt;&lt; <span class="string">&quot; ms&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="C-test-strstr-cpp"><a href="#C-test-strstr-cpp" class="headerlink" title="C++ - test_strstr.cpp"></a>C++ - <code>test_strstr.cpp</code></h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOOP_COUNT (1000)</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> std::chrono::high_resolution_clock;</span><br><span class="line"><span class="keyword">using</span> std::chrono::duration_cast;</span><br><span class="line"><span class="keyword">using</span> std::chrono::duration;</span><br><span class="line"><span class="keyword">using</span> std::chrono::milliseconds;</span><br><span class="line"><span class="keyword">char</span> s[<span class="number">1000005</span>], p[<span class="number">1005</span>], *pos=<span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">test</span><span class="params">(<span class="keyword">char</span>* s, <span class="keyword">char</span>* p, <span class="keyword">char</span>** pos_ptr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> t1 = high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">    *pos_ptr = <span class="built_in">strstr</span>(s, p);</span><br><span class="line">    <span class="keyword">auto</span> t2 = high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">    duration&lt;<span class="keyword">double</span>, milli&gt; ms_double = t2 - t1;</span><br><span class="line">    <span class="keyword">return</span> ms_double.<span class="built_in">count</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">ifstream <span class="title">srcfile</span><span class="params">(<span class="string">&quot;source.in&quot;</span>)</span></span>;</span><br><span class="line">    <span class="function">ifstream <span class="title">patfile</span><span class="params">(<span class="string">&quot;pattern.in&quot;</span>)</span></span>;</span><br><span class="line">    srcfile &gt;&gt; s;</span><br><span class="line">    patfile &gt;&gt; p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> tot_time = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; LOOP_COUNT; ++i) &#123;</span><br><span class="line">        tot_time += <span class="built_in">test</span>(s, p, &amp;pos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Loop count:            &quot;</span> &lt;&lt; LOOP_COUNT &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Source string length:  &quot;</span> &lt;&lt; <span class="built_in">strlen</span>(s) &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Pattern string length: &quot;</span> &lt;&lt; <span class="built_in">strlen</span>(p) &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Search result:         &quot;</span> &lt;&lt; pos - s &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Time:                  &quot;</span> &lt;&lt; tot_time / LOOP_COUNT &lt;&lt; <span class="string">&quot; ms&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="C-test-kmp-cpp"><a href="#C-test-kmp-cpp" class="headerlink" title="C++ - test_kmp.cpp"></a>C++ - <code>test_kmp.cpp</code></h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOOP_COUNT (1000)</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> std::chrono::high_resolution_clock;</span><br><span class="line"><span class="keyword">using</span> std::chrono::duration_cast;</span><br><span class="line"><span class="keyword">using</span> std::chrono::duration;</span><br><span class="line"><span class="keyword">using</span> std::chrono::milliseconds;</span><br><span class="line"><span class="keyword">int</span> dp[<span class="number">1005</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">KMP</span><span class="params">(string s, string p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> m = s.<span class="built_in">length</span>(), n = p.<span class="built_in">length</span>();</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (m &lt; n) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(dp, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>) * (n+<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i) &#123;</span><br><span class="line">        <span class="keyword">int</span> j = dp[i+<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">while</span> (j &gt; <span class="number">0</span> &amp;&amp; p[j] != p[i]) j = dp[j];</span><br><span class="line">        <span class="keyword">if</span> (j &gt; <span class="number">0</span> || p[j] == p[i]) dp[i+<span class="number">1</span>] = j + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; m; ++i)</span><br><span class="line">        <span class="keyword">if</span> (s[i] == p[j]) &#123; <span class="keyword">if</span> (++j == n) <span class="keyword">return</span> i - j + <span class="number">1</span>; &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (j &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            j = dp[j];</span><br><span class="line">            --i;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">test</span><span class="params">(string s, string p, <span class="keyword">int</span>* pos_ptr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> t1 = high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">    *pos_ptr = <span class="built_in">KMP</span>(s, p);</span><br><span class="line">    <span class="keyword">auto</span> t2 = high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">    duration&lt;<span class="keyword">double</span>, milli&gt; ms_double = t2 - t1;</span><br><span class="line">    <span class="keyword">return</span> ms_double.<span class="built_in">count</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    string s, p;</span><br><span class="line">    <span class="keyword">int</span> pos;</span><br><span class="line">    <span class="function">ifstream <span class="title">srcfile</span><span class="params">(<span class="string">&quot;source.in&quot;</span>)</span></span>;</span><br><span class="line">    <span class="function">ifstream <span class="title">patfile</span><span class="params">(<span class="string">&quot;pattern.in&quot;</span>)</span></span>;</span><br><span class="line">    srcfile &gt;&gt; s;</span><br><span class="line">    patfile &gt;&gt; p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> tot_time = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; LOOP_COUNT; ++i) &#123;</span><br><span class="line">        tot_time += <span class="built_in">test</span>(s, p, &amp;pos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Loop count:            &quot;</span> &lt;&lt; LOOP_COUNT &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Source string length:  &quot;</span> &lt;&lt; s.<span class="built_in">length</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Pattern string length: &quot;</span> &lt;&lt; p.<span class="built_in">length</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Search result:         &quot;</span> &lt;&lt; pos &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Time:                  &quot;</span> &lt;&lt; tot_time / LOOP_COUNT &lt;&lt; <span class="string">&quot; ms&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p>IPython 的 <code>%timeit</code> 魔法命令可以输出代码多次执行的平均时间和标准差，在此取平均时间。C++ 的代码对每个模式串固定运行 1,000 次后取平均时间。</p><p>以下时间若无特别说明，均以微秒为单位，保留到整数位。</p><table><thead><tr><th align="center">场景</th><th align="center">模式串出现位置</th><th align="center">Python</th><th align="center">C++ - <code>test.cpp</code></th><th align="center">C++ - <code>test_strstr.cpp</code></th><th align="center">C++ - <code>test_kmp.cpp</code></th></tr></thead><tbody><tr><td align="center">场景 1</td><td align="center">250,000</td><td align="center">105</td><td align="center">523</td><td align="center">155</td><td align="center">2564</td></tr><tr><td align="center">场景 1</td><td align="center">500,000</td><td align="center">183</td><td align="center">1053</td><td align="center">274</td><td align="center">3711</td></tr><tr><td align="center">场景 1</td><td align="center">750,000</td><td align="center">291</td><td align="center">1589</td><td align="center">447</td><td align="center">4900</td></tr><tr><td align="center">场景 2</td><td align="center">750,000</td><td align="center">2630*</td><td align="center">618</td><td align="center">353</td><td align="center">3565</td></tr></tbody></table><p>* 原输出为“2.63 ms”。IPython 的 <code>%timeit</code> 输出的均值保留 3 位有效数字，由于此时间已超过 1 毫秒，微秒位被舍弃。此处仍以微秒作单位，数值记为“2630”。</p><h2 id="局限性"><a href="#局限性" class="headerlink" title="局限性"></a>局限性</h2><p>本次实测时使用的设备硬件上劣于算法竞赛中的标准配置机器，实测结果中的“绝对数值”参考性较低。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>根据上表中的结果，在给定环境和相关参数条件下，场景 1 中 Python 的运行时间大约为 C++ 中 <code>string::find</code> 的五分之一，与 <code>std:strstr</code> 接近；而在场景 2 中 Python 的运行时间明显增长，但 C++ 的前两种测试方法的运行时间与先前接近甚至更短。四次测试中，C++ 的用户实现的 KMP 算法运行时间均较长，长于同条件下 Python 的情况。</p><p>Python 中的内置类型 <code>str</code> 的快速查找（<code>.find()</code>）和计数（<code>.count()</code>）算法基于 <a href="https://en.wikipedia.org/wiki/Boyer%E2%80%93Moore_string-search_algorithm">Boyer-Moore 算法</a>和 <a href="https://en.wikipedia.org/wiki/Boyer%E2%80%93Moore%E2%80%93Horspool_algorithm">Horspool 算法</a>的混合，其中后者是前者的简化，而前者与 <a href="https://en.wikipedia.org/wiki/Knuth%E2%80%93Morris%E2%80%93Pratt_algorithm">Knuth-Morris-Pratt 算法</a>有关。</p><p>有关 C++ 的 <code>string::find</code> 比 <code>std::strstr</code> 运行时间长的相关情况，参见 <a href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=66414"><strong>Bug 66414</strong> - string::find ten times slower than strstr</a>。</p><p>值得关注的是：C++ 中自行实现的 KMP 算法的运行时间竟然远长于 C++ 标准库甚至 Python 中的算法。这也类似于常说的“自己设计汇编代码运行效率低于编译器”的情况。Stack Overflow 的一个问题 <a href="https://stackoverflow.com/questions/7586990/strstr-faster-than-algorithms">strstr faster than algorithms?</a> 下有人<a href="https://stackoverflow.com/a/7587069/12002560">回答</a>如下：</p><blockquote><p>Why do you think <code>strstr</code> should be slower than all the others? Do you know what algorithm <code>strstr</code> uses? I think it’s quite likely that <code>strstr</code> uses a fine-tuned, processor-specific, assembly-coded algorithm of the <code>KMP</code> type or better. In which case you don’t stand a chance of out-performing it in <code>C</code> for such small benchmarks.</p></blockquote><p>KMP 算法并非是所有线性复杂度算法中最快的。在不同的环境（软硬件、测试数据等）下，KMP 与其变种乃至其他线性复杂度算法，孰优孰劣都无法判断。编译器在设计时考虑到诸多可能的因素，尽可能使不同环境下都能有相对较优的策略来得到结果。因而，在保证结果正确的情况下，与其根据算法原理自行编写，不如直接使用标准库中提供的函数。</p><p>同时本次实测也在运行时间角度再次印证 Python 并不适合在算法竞赛中取得高成绩的说法。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://stackoverflow.com/questions/22387586/measuring-execution-time-of-a-function-in-c">https://stackoverflow.com/questions/22387586/measuring-execution-time-of-a-function-in-c</a></li><li><a href="https://www.cplusplus.com/reference/string/string/find/">https://www.cplusplus.com/reference/string/string/find/</a></li><li><a href="https://stackoverflow.com/questions/681649/how-is-string-find-implemented-in-cpython">https://stackoverflow.com/questions/681649/how-is-string-find-implemented-in-cpython</a></li><li><a href="https://github.com/python/cpython/blob/main/Objects/stringlib/fastsearch.h#L5">https://github.com/python/cpython/blob/main/Objects/stringlib/fastsearch.h#L5</a></li><li><a href="https://stackoverflow.com/questions/8869605/c-stringfind-complexity">https://stackoverflow.com/questions/8869605/c-stringfind-complexity</a></li><li><a href="https://stackoverflow.com/questions/19506571/can-it-be-faster-to-find-the-minimum-periodic-string-inside-another-string-in-te">https://stackoverflow.com/questions/19506571/can-it-be-faster-to-find-the-minimum-periodic-string-inside-another-string-in-te</a></li><li><a href="https://gcc.gnu.org/onlinedocs/gcc-9.4.0/libstdc++/api/a17342_source.html">https://gcc.gnu.org/onlinedocs/gcc-9.4.0/libstdc++/api/a17342_source.html</a></li><li><a href="https://opensource.apple.com/source/tcl/tcl-10/tcl/compat/strstr.c.auto.html">https://opensource.apple.com/source/tcl/tcl-10/tcl/compat/strstr.c.auto.html</a></li><li><a href="https://gist.github.com/hsinewu/44a1ce38a1baf47893922e3f54807713">https://gist.github.com/hsinewu/44a1ce38a1baf47893922e3f54807713</a></li><li><a href="https://stackoverflow.com/questions/11799956/performance-comparison-strstr-vs-stdstringfind">https://stackoverflow.com/questions/11799956/performance-comparison-strstr-vs-stdstringfind</a></li><li><a href="https://stackoverflow.com/questions/7586990/strstr-faster-than-algorithms">https://stackoverflow.com/questions/7586990/strstr-faster-than-algorithms</a></li><li><a href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=66414">https://gcc.gnu.org/bugzilla/show_bug.cgi?id=66414</a></li><li><a href="http://0x80.pl/notesen/2016-10-08-slow-std-string-find.html">http://0x80.pl/notesen/2016-10-08-slow-std-string-find.html</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;最近在备战一场算法竞赛，语言误选了 Python ，无奈只能着手对常见场景进行语言迁移。而字符串查找的场景在算法竞赛中时有出现。本文即对此场景在 Python 和竞赛常用语言 C++ 下的速度进行对比，并提供相关参数和运行结果供他人参考。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Essay" scheme="https://blog.imakiseki.cf/categories/Essay/"/>
    
    
    <category term="Programming" scheme="https://blog.imakiseki.cf/tags/Programming/"/>
    
    <category term="Python" scheme="https://blog.imakiseki.cf/tags/Python/"/>
    
    <category term="C++" scheme="https://blog.imakiseki.cf/tags/C/"/>
    
    <category term="Performance" scheme="https://blog.imakiseki.cf/tags/Performance/"/>
    
  </entry>
  
  <entry>
    <title>Linux 时间操作及其同步</title>
    <link href="https://blog.imakiseki.cf/techdev/linux-time-operations-and-sync/"/>
    <id>https://blog.imakiseki.cf/techdev/linux-time-operations-and-sync/</id>
    <published>2022-02-27T12:14:00.000Z</published>
    <updated>2022-02-27T15:17:47.194Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>本文将以 Arch Linux 为例，讨论 Linux 的时间操作和同步方法。</p></blockquote><span id="more"></span><p>本文围绕 Linux 的时间将 ArchWiki 上 <a href="https://wiki.archlinux.org/title/System_time">System time</a> 页面的部分内容做简化，并整理其他文章作为补充，简化理论性，增强可操作性。</p><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>操作系统的时间 (clock) 由三或四部分决定：</p><ul><li>时间值；</li><li>是否为 UTC 时间；</li><li>时区；</li><li>（如果有）夏令时。</li></ul><p>而操作系统的时间一般有两种：硬件时间和系统时间。</p><h3 id="硬件时间"><a href="#硬件时间" class="headerlink" title="硬件时间"></a>硬件时间</h3><p>硬件时间 (也即真实时间 (Real Time Clock, RTC) 或 CMOS 时钟) 一般只存储时间值，直至 2016 年后 UEFI 硬件支持对时区和夏令时的存储。</p><h3 id="系统时间"><a href="#系统时间" class="headerlink" title="系统时间"></a>系统时间</h3><p>系统时间 (也即软件时间) 可以追踪时间值、时区以及可能存在的夏令时。系统时间由 Linux 内核计算，时间值为 UTC+0 下自 1970 年 1 月 1 日午夜至今的秒数——可以在 <a href="https://time.is/Unix_time_now">time.is 网站</a>查询得到。</p><p>尤其需要注意的是：操作系统完全启动后，系统时间与硬件时间是<strong>独立</strong>的。</p><h2 id="读取"><a href="#读取" class="headerlink" title="读取"></a>读取</h2><h3 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h3><p>Linux 的时间状态可由 <code>timedatectl</code> 或 <code>timedatectl status</code> 命令获取。输出类似于：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">               Local time: Sun 2022-02-27 12:52:24 UTC</span><br><span class="line">           Universal time: Sun 2022-02-27 12:52:24 UTC</span><br><span class="line">                 RTC time: n/a</span><br><span class="line">                Time zone: UTC (UTC, +0000)</span><br><span class="line">System clock synchronized: yes</span><br><span class="line">              NTP service: active</span><br><span class="line">          RTC in local TZ: no</span><br></pre></td></tr></table></figure><p>我们可以得知：</p><ul><li>本地时间值和 UTC 时间值均为 Sun 2022-02-27 12:52:24 UTC；</li><li>硬件时间不存在；</li><li>时区为 UTC (UTC+0)；</li><li>已经开启系统时间同步。</li></ul><h3 id="硬件时间-1"><a href="#硬件时间-1" class="headerlink" title="硬件时间"></a>硬件时间</h3><p>上方的示例中硬件时间 (RTC time) 显示为“n/a”，也就是不存在。在一部存在硬件时间的 Linux 设备上，可以执行 <code>hwclock --show</code> 查看硬件时间：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ hwclock --show</span><br><span class="line">2022-02-27 21:14:16.129670+08:00</span><br></pre></td></tr></table></figure><p>比 <code>timedatectl</code> 更进一步的是，<code>hwclock</code> 可以显示有关硬件时间的更详细信息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ hwclock --verbose</span><br><span class="line">hwclock from util-linux 2.34</span><br><span class="line">System Time: 1645967662.035542</span><br><span class="line">Trying to open: /dev/rtc0</span><br><span class="line">Using the rtc interface to the clock.</span><br><span class="line">Assuming hardware clock is kept in UTC time.</span><br><span class="line">Waiting for clock tick...</span><br><span class="line">...got clock tick</span><br><span class="line">Time read from Hardware Clock: 2022/02/27 13:14:24</span><br><span class="line">Hw clock time : 2022/02/27 13:14:24 = 1645967664 seconds since 1969</span><br><span class="line">Time since last adjustment is 1645967664 seconds</span><br><span class="line">Calculated Hardware Clock drift is 0.000000 seconds</span><br><span class="line">2022-02-27 21:14:23.020178+08:00</span><br></pre></td></tr></table></figure><p>对此输出不再作进一步介绍。</p><h2 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h2><h3 id="硬件时间（与系统时间一致）"><a href="#硬件时间（与系统时间一致）" class="headerlink" title="硬件时间（与系统时间一致）"></a>硬件时间（与系统时间一致）</h3><p>我们一般很少手动设置硬件时间。若要设置，可以使其与系统时间保持一致：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo hwclock --systohc</span><br></pre></td></tr></table></figure><p>这会新建或更新 <code>/etc/adjtime</code> 的内容，示例如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/adjtime</span><br><span class="line">0.000000 1645969156 0.000000</span><br><span class="line">1645969156</span><br><span class="line">LOCAL</span><br></pre></td></tr></table></figure><h3 id="系统时间-1"><a href="#系统时间-1" class="headerlink" title="系统时间"></a>系统时间</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo timedatectl set-time <span class="string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span></span><br></pre></td></tr></table></figure><p>例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo timedatectl set-time <span class="string">&quot;2014-05-26 11:13:54&quot;</span></span><br></pre></td></tr></table></figure><h3 id="时区"><a href="#时区" class="headerlink" title="时区"></a>时区</h3><p>设置时区前，先需要知道可用的时区：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl list-timezones</span><br></pre></td></tr></table></figure><p>其中有“Asia/Shanghai”，可将时区设置为此：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></table></figure><h2 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h2><p>此处提到的同步指的是系统时间与其他服务器提供的时间同步。以下提供两种方式。</p><h3 id="systemd-timesyncd-服务"><a href="#systemd-timesyncd-服务" class="headerlink" title="systemd-timesyncd 服务"></a>systemd-timesyncd 服务</h3><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>首先启用该服务，执行 <code>systemctl start systemd-timesyncd</code>。可以选择加入自启动项。</p><p>打开 <code>/etc/systemd/timesyncd.conf</code> 文件，其中的内容可能如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Time]</span><br><span class="line">#NTP=</span><br><span class="line">#FallbackNTP=0.arch.pool.ntp.org 1.arch.pool.ntp.org 2.arch.pool.ntp.org 3.arch.pool.ntp.org</span><br><span class="line">#RootDistanceMaxSec=5</span><br><span class="line">#PollIntervalMinSec=32</span><br><span class="line">#PollIntervalMaxSec=2048</span><br><span class="line">#SaveIntervalSec=60</span><br></pre></td></tr></table></figure><p>删去前两行的注释记号，并作如下修改：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NTP=0.cn.pool.ntp.org 1.cn.pool.ntp.org 2.cn.pool.ntp.org 3.cn.pool.ntp.org</span><br><span class="line">FallbackNTP=0.arch.pool.ntp.org 1.arch.pool.ntp.org 2.arch.pool.ntp.org 3.arch.pool.ntp.org</span><br></pre></td></tr></table></figure><p>若要验证配置，执行 <code>timedatectl show-timesync --all</code>。一般输出类似于：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LinkNTPServers=</span><br><span class="line">SystemNTPServers=</span><br><span class="line">FallbackNTPServers=0.arch.pool.ntp.org 1.arch.pool.ntp.org 2.arch.pool.ntp.org 3.arch.pool.ntp.org</span><br><span class="line">ServerName=0.arch.pool.ntp.org</span><br><span class="line">ServerAddress=103.47.76.177</span><br><span class="line">RootDistanceMaxUSec=5s</span><br><span class="line">PollIntervalMinUSec=32s</span><br><span class="line">PollIntervalMaxUSec=34min 8s</span><br><span class="line">PollIntervalUSec=1min 4s</span><br><span class="line">NTPMessage=&#123; Leap=0, Version=4, Mode=4, Stratum=2, Precision=-21, RootDelay=177.398ms, RootDispersion=142.196ms, Reference=C342F10A, OriginateTimestamp=Mon 2018-07-16 13:53:43 +08, ReceiveTimestamp=Mon 2018-07-16 13:53:43 +08, TransmitTimestamp=Mon 2018-07-16 13:53:43 +08, DestinationTimestamp=Mon 2018-07-16 13:53:43 +08, Ignored=no PacketCount=1, Jitter=0 &#125;</span><br><span class="line">Frequency=22520548</span><br></pre></td></tr></table></figure><p>但若出现类似如下的输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">LinkNTPServers=</span><br><span class="line">SystemNTPServers=0.cn.pool.ntp.org 1.cn.pool.ntp.org 2.cn.pool.ntp.org 3.cn.pool.ntp.org</span><br><span class="line">FallbackNTPServers=0.pool.ntp.org 1.pool.ntp.org 2.arch.pool.ntp.org 3.arch.pool.ntp.org</span><br><span class="line">ServerName=</span><br><span class="line">ServerAddress=</span><br><span class="line">RootDistanceMaxUSec=5s</span><br><span class="line">PollIntervalMinUSec=32s</span><br><span class="line">PollIntervalMaxUSec=34min 8s</span><br><span class="line">PollIntervalUSec=0</span><br><span class="line">Frequency=0</span><br></pre></td></tr></table></figure><p>请跳过本小节，跳转至 <a href="#chrony">chrony</a>。</p><h4 id="生效"><a href="#生效" class="headerlink" title="生效"></a>生效</h4><p>若要使配置生效，执行 <code>timedatectl set-ntp true</code>。</p><p>同步过程需要持续一段时间。若要检查同步状态，执行 <code>timedatectl status</code>。输出类似于：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">               Local time: Thu 2015-07-09 18:21:33 CEST</span><br><span class="line">           Universal time: Thu 2015-07-09 16:21:33 UTC</span><br><span class="line">                 RTC time: Thu 2015-07-09 16:21:33</span><br><span class="line">                Time zone: Europe/Amsterdam (CEST, +0200)</span><br><span class="line">System clock synchronized: yes</span><br><span class="line">              NTP service: active</span><br><span class="line">          RTC in local TZ: no</span><br></pre></td></tr></table></figure><p>若要查看详细信息，执行 <code>timedatectl timesync-status</code>。输出类似于：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">       Server: 103.47.76.177 (0.arch.pool.ntp.org)</span><br><span class="line">Poll interval: 2min 8s (min: 32s; max 34min 8s)</span><br><span class="line">         Leap: normal</span><br><span class="line">      Version: 4</span><br><span class="line">      Stratum: 2</span><br><span class="line">    Reference: C342F10A</span><br><span class="line">    Precision: 1us (-21)</span><br><span class="line">Root distance: 231.856ms (max: 5s)</span><br><span class="line">       Offset: -19.428ms</span><br><span class="line">        Delay: 36.717ms</span><br><span class="line">       Jitter: 7.343ms</span><br><span class="line"> Packet count: 2</span><br><span class="line">    Frequency: +267.747ppm</span><br></pre></td></tr></table></figure><h3 id="chrony"><a href="#chrony" class="headerlink" title="chrony"></a>chrony</h3><p><a href="https://chrony.tuxfamily.org/">chrony</a> 是一个漫游友好型、且专为非所有时间在线的系统设计的程序，可以用以同步系统时间。</p><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>大部分软件管理器中均有该软件包。执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S chrony</span><br></pre></td></tr></table></figure><p>这将在 <code>/usr/bin</code> 下放置 chrony 的两个可执行文件 <code>chronyc</code> 和 <code>chronyd</code>，分别作为客户端和服务端（保护进程）。</p><p>也可以在官网中查阅其他安装方式。</p><h4 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h4><p>配置文件一般为 <code>/etc/chrony.conf</code> 或 <code>/etc/chrony/chrony.conf</code>。</p><p>打开配置文件，做如下更改：</p><ul><li>定位到 <code>pool</code> 配置项，修改其后的服务器地址为 <code>0.cn.pool.ntp.org</code>；</li><li>定位到 <code>makestep</code> 配置项，根据需求修改；<ul><li>第一个数字：进行“时间跳跃”的阈值——同步时若系统时间与服务器返回结果相差在阈值内，则程序会逐渐调整当前系统时间；反之则会直接将系统时间设为正确时间（<strong>注意：</strong>“时间跳跃”可能会对其他程序造成负面影响，不宜将此值调至过小）；</li><li>第二个数字：可进行时间调整的范围——设置为 <code>n</code> 表示仅前 <code>n</code> 次时间更新过程可发生这种调整。</li></ul></li><li>定位到 <code>logdir</code> 配置项，删去配置记号；</li><li>定位到 <code>rtcsync</code> 配置项，删去注释记号。</li></ul><h4 id="生效-1"><a href="#生效-1" class="headerlink" title="生效"></a>生效</h4><p>启用该服务，执行 <code>systemctl start chronyd</code>。可以选择加入自启动项。重启，读取系统时间检查：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">               Local time: Sun 2022-02-27 23:16:28 CST</span><br><span class="line">           Universal time: Sun 2022-02-27 15:16:28 UTC</span><br><span class="line">                 RTC time: n/a</span><br><span class="line">                Time zone: Asia/Shanghai (CST, +0800)</span><br><span class="line">System clock synchronized: yes</span><br><span class="line">              NTP service: active</span><br><span class="line">          RTC in local TZ: no</span><br></pre></td></tr></table></figure><p>观察到“System clock synchronized”栏的输出是“yes”。</p><p>若要立刻更改系统时间，执行 <code>chronyc makestep</code>。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://wiki.archlinux.org/title/System_time">https://wiki.archlinux.org/title/System_time</a></li><li><a href="https://wiki.archlinux.org/title/Systemd-timesyncd">https://wiki.archlinux.org/title/Systemd-timesyncd</a></li><li><a href="https://www.tecmint.com/install-chrony-in-centos-ubuntu-linux/">https://www.tecmint.com/install-chrony-in-centos-ubuntu-linux/</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;本文将以 Arch Linux 为例，讨论 Linux 的时间操作和同步方法。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Essay" scheme="https://blog.imakiseki.cf/categories/Essay/"/>
    
    
    <category term="Linux" scheme="https://blog.imakiseki.cf/tags/Linux/"/>
    
    <category term="Arch Linux" scheme="https://blog.imakiseki.cf/tags/Arch-Linux/"/>
    
    <category term="Time" scheme="https://blog.imakiseki.cf/tags/Time/"/>
    
  </entry>
  
  <entry>
    <title>【ACG音乐分享】Ceui《今、歩き出す君へ》</title>
    <link href="https://blog.imakiseki.cf/acg/ima-aruki-dasu-kimi-e/"/>
    <id>https://blog.imakiseki.cf/acg/ima-aruki-dasu-kimi-e/</id>
    <published>2022-01-23T14:27:13.000Z</published>
    <updated>2022-01-23T15:19:27.879Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>《今、歩き出す君へ》是日本公司 fairys 制作的恋爱 AVG 《いますぐお兄ちゃんに妹だっていいたい！》的插曲，由 Ceui 演唱。</p></blockquote><span id="more"></span><p>《今、歩き出す君へ》（此刻，致迈步向前的你）是日本公司 fairys 制作的恋爱 AVG 《いますぐお兄ちゃんに妹だっていいたい！》（现在就想告诉哥哥，我是妹妹！）的插曲，由 Ceui 演唱，被收录于专辑《PCゲーム『いますぐお兄ちゃんに妹だっていいたい！』ボーカルアルバム》。</p><p><img src="/2022/01/23/acg/ima-aruki-dasu-kimi-e/images/2022-01-23-23-18-08.png" alt="图 1 专辑《PCゲーム『いますぐお兄ちゃんに妹だっていいたい！』ボーカルアルバム》封面"></p><p>图源为<a href="https://www.amazon.co.jp/PC%E3%82%B2%E3%83%BC%E3%83%A0-%E3%81%84%E3%81%BE%E3%81%99%E3%81%90%E3%81%8A%E5%85%84%E3%81%A1%E3%82%83%E3%82%93%E3%81%AB%E5%A6%B9%E3%81%A0%E3%81%A3%E3%81%A6%E3%81%84%E3%81%84%E3%81%9F%E3%81%84-%E3%83%9C%E3%83%BC%E3%82%AB%E3%83%AB%E3%82%A2%E3%83%AB%E3%83%90%E3%83%A0-%E3%82%B2%E3%83%BC%E3%83%A0%E3%83%BB%E3%83%9F%E3%83%A5%E3%83%BC%E3%82%B8%E3%83%83%E3%82%AF/dp/B00B2PH3MU">亚马逊商城</a>。</p><h2 id="歌词"><a href="#歌词" class="headerlink" title="歌词"></a>歌词</h2><p>歌词原作者为网易云音乐用户<a href="https://music.163.com/#/user/home?id=28522951">虚伪的祈愿</a>。</p><h3 id="日文歌词"><a href="#日文歌词" class="headerlink" title="日文歌词"></a>日文歌词</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">心の中で描いた地図は</span><br><span class="line">行き止まりばかり 迷路みたいで</span><br><span class="line">きっと誰もが傷つきながら</span><br><span class="line">心に鍵かけて泣いているんだろう</span><br><span class="line">いつも強がって 自分を奮い立たせ</span><br><span class="line">溢れる人ごみの中 遠い空、見上げてた</span><br><span class="line">過去の言葉より 未来のノートを開こう</span><br><span class="line">つまづいた分だけ 少しずつ 強くなれるよ</span><br><span class="line">世界でひとつの君という奇跡が</span><br><span class="line">モノクロの世界を色鮮やかに変えてゆく</span><br><span class="line">生きていく意味を見出すことが出来たなら</span><br><span class="line">描く未来は 君から始まる勇気</span><br><span class="line">上手く行かずに 臆病になって</span><br><span class="line">自分らしささえ 見失っても</span><br><span class="line">握り締めてる 熱い想いを</span><br><span class="line">ずっと忘れずに 歩き続けたい</span><br><span class="line">夢を追いかけた 少年の日の輝き</span><br><span class="line">誰もが抱きしめながら 同じ今を生きてる</span><br><span class="line">寂しい夜だって 誰かと繋がってる気持ち</span><br><span class="line">心のどこかで いつも信じていたいんだ</span><br><span class="line">世界でひとつの明日という未来が</span><br><span class="line">小さな涙の種を大きな花へ変える</span><br><span class="line">生きていく意味を見出すことが出来たなら</span><br><span class="line">昨日までの自分を越えられるはず</span><br><span class="line">理想や憧れが大きすぎてつらくなったら</span><br><span class="line">ありのままの心で君に語りかけよう</span><br><span class="line">回り道のどこかで 道なき道のどこかで</span><br><span class="line">出会えるかもしれない その時は笑顔で…</span><br><span class="line">世界でひとつの君という奇跡が消えない希望を</span><br><span class="line">僕に教えてくれたんだ</span><br><span class="line">生きていく意味は いつでもその胸にあるよ</span><br><span class="line">描く未来は もうすぐその先に</span><br><span class="line">世界でひとつの君という光が</span><br><span class="line">小さなこの地球のなか 広がる闇を照らす</span><br><span class="line">繋がる空の下 さあ自分らしく進もう</span><br><span class="line">始まりの詩贈るよ 歩き出す君へ</span><br></pre></td></tr></table></figure><details><summary>日文歌词 LRC 格式</summary><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[00:00.000] 作词 : Ceui</span><br><span class="line">[00:01.000] 作曲 : 小高光太郎</span><br><span class="line">[00:21.930]心の中で描いた地図は</span><br><span class="line">[00:27.670]行き止まりばかり 迷路みたいで</span><br><span class="line">[00:33.040]きっと誰もが傷つきながら</span><br><span class="line">[00:38.430]心に鍵かけて泣いているんだろう</span><br><span class="line">[00:44.100]いつも強がって 自分を奮い立たせ</span><br><span class="line">[00:49.430]溢れる人ごみの中 遠い空、見上げてた</span><br><span class="line">[00:54.960]過去の言葉より 未来のノートを開こう</span><br><span class="line">[01:00.650]つまづいた分だけ 少しずつ 強くなれるよ</span><br><span class="line">[01:08.870]世界でひとつの君という奇跡が</span><br><span class="line">[01:14.150]モノクロの世界を色鮮やかに変えてゆく</span><br><span class="line">[01:19.780]生きていく意味を見出すことが出来たなら</span><br><span class="line">[01:26.200]描く未来は 君から始まる勇気</span><br><span class="line">[01:41.530]上手く行かずに 臆病になって</span><br><span class="line">[01:47.260]自分らしささえ 見失っても</span><br><span class="line">[01:52.500]握り締めてる 熱い想いを</span><br><span class="line">[01:58.120]ずっと忘れずに 歩き続けたい</span><br><span class="line">[02:03.740]夢を追いかけた 少年の日の輝き</span><br><span class="line">[02:09.020]誰もが抱きしめながら 同じ今を生きてる</span><br><span class="line">[02:14.600]寂しい夜だって 誰かと繋がってる気持ち</span><br><span class="line">[02:20.130]心のどこかで いつも信じていたいんだ</span><br><span class="line">[02:28.450]世界でひとつの明日という未来が</span><br><span class="line">[02:33.680]小さな涙の種を大きな花へ変える</span><br><span class="line">[02:39.410]生きていく意味を見出すことが出来たなら</span><br><span class="line">[02:45.830]昨日までの自分を越えられるはず</span><br><span class="line">[02:52.900]理想や憧れが大きすぎてつらくなったら</span><br><span class="line">[02:58.530]ありのままの心で君に語りかけよう</span><br><span class="line">[03:04.160]回り道のどこかで 道なき道のどこかで</span><br><span class="line">[03:09.480]出会えるかもしれない その時は笑顔で…</span><br><span class="line">[03:28.600]世界でひとつの君という奇跡が消えない希望を</span><br><span class="line">[03:36.480]僕に教えてくれたんだ</span><br><span class="line">[03:39.960]生きていく意味は いつでもその胸にあるよ</span><br><span class="line">[03:45.830]描く未来は もうすぐその先に</span><br><span class="line">[03:50.760]世界でひとつの君という光が</span><br><span class="line">[03:56.180]小さなこの地球のなか 広がる闇を照らす</span><br><span class="line">[04:01.560]繋がる空の下 さあ自分らしく進もう</span><br><span class="line">[04:08.280]始まりの詩贈るよ 歩き出す君へ</span><br></pre></td></tr></table></figure></details><h3 id="中文歌词"><a href="#中文歌词" class="headerlink" title="中文歌词"></a>中文歌词</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">曾近绘于心的地图</span><br><span class="line">如同迷路了一般 总是处处碰壁</span><br><span class="line">谁都一样 都是在受伤时</span><br><span class="line">闭上自己的心扉哭泣着吧</span><br><span class="line">一直故作坚强 让自己奋起直追</span><br><span class="line">在这比肩接踵的人群中 仰望那遥远的天空</span><br><span class="line">抛弃过去的只言片语 打开那未来的一页吧</span><br><span class="line">在失足倒地后 慢慢坚强起来</span><br><span class="line">在这世间 有一个被称为「你」的奇迹</span><br><span class="line">让这黑白两色的世界变得五彩斑斓</span><br><span class="line">若能找到活下去的意义</span><br><span class="line">从中描绘出的未来 便是源自于你的勇气</span><br><span class="line">无法好好前进 变得胆怯懦弱</span><br><span class="line">就算心中的真实逐渐迷失</span><br><span class="line">也绝不会放手 绝不会忘怀</span><br><span class="line">那份热切的思念 坚持一步步前行</span><br><span class="line">追逐着梦想的少年 每一天都闪耀着光辉</span><br><span class="line">谁都会拥抱着 那不变的当下生活下去</span><br><span class="line">寂寞的夜晚里 也会感到和某人心心相印</span><br><span class="line">在心中的某处 一直这样坚信不疑</span><br><span class="line">在这世间 有一种被称为「明天」的未来</span><br><span class="line">将小小的泪珠变化为大大的花儿</span><br><span class="line">若能说出活下去的意义</span><br><span class="line">就一定会超越昨日的自己</span><br><span class="line">理想与憧憬太过宏大 变得举步维艰之时</span><br><span class="line">就用那毫无掩饰的心向你细细诉说吧</span><br><span class="line">在刻意绕远的道路某处 在没有尽头的道路某处</span><br><span class="line">也许会再次 和那时的笑颜相遇吧····</span><br><span class="line">在这世间 有一个被称为「你」的奇迹</span><br><span class="line">带给了我永不消逝的希望</span><br><span class="line">那活下去的意义  一直都在这心中哦</span><br><span class="line">描绘的未来 就在不远的前方</span><br><span class="line">在这世间 有一道被称为「你」的光芒</span><br><span class="line">在这小小的地球上不断扩大 照亮了黑暗</span><br><span class="line">彼此相连的青空之下 来吧 用自己独有的方式前进</span><br><span class="line">将这起始的诗篇 赠与迈出步伐的你</span><br></pre></td></tr></table></figure><details><summary>中文歌词 LRC 格式</summary><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[by:请不要在意我的昵称]</span><br><span class="line">[00:21.930]曾近绘于心的地图</span><br><span class="line">[00:27.670]如同迷路了一般 总是处处碰壁</span><br><span class="line">[00:33.040]谁都一样 都是在受伤时</span><br><span class="line">[00:38.430]闭上自己的心扉哭泣着吧</span><br><span class="line">[00:44.100]一直故作坚强 让自己奋起直追</span><br><span class="line">[00:49.430]在这比肩接踵的人群中 仰望那遥远的天空</span><br><span class="line">[00:54.960]抛弃过去的只言片语 打开那未来的一页吧</span><br><span class="line">[01:00.650]在失足倒地后 慢慢坚强起来</span><br><span class="line">[01:08.870]在这世间 有一个被称为「你」的奇迹</span><br><span class="line">[01:14.150]让这黑白两色的世界变得五彩斑斓</span><br><span class="line">[01:19.780]若能找到活下去的意义</span><br><span class="line">[01:26.200]从中描绘出的未来 便是源自于你的勇气</span><br><span class="line">[01:41.530]无法好好前进 变得胆怯懦弱</span><br><span class="line">[01:47.260]就算心中的真实逐渐迷失</span><br><span class="line">[01:52.500]也绝不会放手 绝不会忘怀</span><br><span class="line">[01:58.120]那份热切的思念 坚持一步步前行</span><br><span class="line">[02:03.740]追逐着梦想的少年 每一天都闪耀着光辉</span><br><span class="line">[02:09.020]谁都会拥抱着 那不变的当下生活下去</span><br><span class="line">[02:14.600]寂寞的夜晚里 也会感到和某人心心相印</span><br><span class="line">[02:20.130]在心中的某处 一直这样坚信不疑</span><br><span class="line">[02:28.450]在这世间 有一种被称为「明天」的未来</span><br><span class="line">[02:33.680]将小小的泪珠变化为大大的花儿</span><br><span class="line">[02:39.410]若能说出活下去的意义</span><br><span class="line">[02:45.830]就一定会超越昨日的自己</span><br><span class="line">[02:52.900]理想与憧憬太过宏大 变得举步维艰之时</span><br><span class="line">[02:58.530]就用那毫无掩饰的心向你细细诉说吧</span><br><span class="line">[03:04.160]在刻意绕远的道路某处 在没有尽头的道路某处</span><br><span class="line">[03:09.480]也许会再次 和那时的笑颜相遇吧····</span><br><span class="line">[03:28.600]在这世间 有一个被称为「你」的奇迹</span><br><span class="line">[03:36.480]带给了我永不消逝的希望</span><br><span class="line">[03:39.960]那活下去的意义  一直都在这心中哦</span><br><span class="line">[03:45.830]描绘的未来 就在不远的前方</span><br><span class="line">[03:50.760]在这世间 有一道被称为「你」的光芒</span><br><span class="line">[03:56.180]在这小小的地球上不断扩大 照亮了黑暗</span><br><span class="line">[04:01.560]彼此相连的青空之下 来吧 用自己独有的方式前进</span><br><span class="line">[04:08.280]将这起始的诗篇 赠与迈出步伐的你</span><br></pre></td></tr></table></figure></details><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>网易云音乐： <a href="https://music.163.com/#/song?id=26209670">https://music.163.com/#/song?id=26209670</a></li><li>萌娘百科同名词条： <a href="https://zh.moegirl.org.cn/%E6%AD%A4%E5%88%BB%EF%BC%8C%E8%87%B4%E8%BF%88%E6%AD%A5%E5%90%91%E5%89%8D%E7%9A%84%E4%BD%A0">https://zh.moegirl.org.cn/此刻，致迈步向前的你</a></li><li>萌娘百科“Ceui”词条： <a href="https://zh.moegirl.org.cn/Ceui">https://zh.moegirl.org.cn/Ceui</a></li><li>萌娘百科“现在就想告诉哥哥,我是妹妹!”词条： <a href="https://zh.moegirl.org.cn/%E7%8E%B0%E5%9C%A8%E5%B0%B1%E6%83%B3%E5%91%8A%E8%AF%89%E5%93%A5%E5%93%A5,%E6%88%91%E6%98%AF%E5%A6%B9%E5%A6%B9!">https://zh.moegirl.org.cn/现在就想告诉哥哥,我是妹妹!</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;《今、歩き出す君へ》是日本公司 fairys 制作的恋爱 AVG 《いますぐお兄ちゃんに妹だっていいたい！》的插曲，由 Ceui 演唱。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Share" scheme="https://blog.imakiseki.cf/categories/Share/"/>
    
    
    <category term="ACG" scheme="https://blog.imakiseki.cf/tags/ACG/"/>
    
    <category term="Music" scheme="https://blog.imakiseki.cf/tags/Music/"/>
    
    <category term="Ceui" scheme="https://blog.imakiseki.cf/tags/Ceui/"/>
    
    <category term="现在就想告诉哥哥，我是妹妹！" scheme="https://blog.imakiseki.cf/tags/%E7%8E%B0%E5%9C%A8%E5%B0%B1%E6%83%B3%E5%91%8A%E8%AF%89%E5%93%A5%E5%93%A5%EF%BC%8C%E6%88%91%E6%98%AF%E5%A6%B9%E5%A6%B9%EF%BC%81/"/>
    
  </entry>
  
  <entry>
    <title>【翻译】如何编写 Git 提交消息</title>
    <link href="https://blog.imakiseki.cf/techdev/how-to-write-a-git-commit-message-chs/"/>
    <id>https://blog.imakiseki.cf/techdev/how-to-write-a-git-commit-message-chs/</id>
    <published>2021-10-01T23:52:00.000Z</published>
    <updated>2022-01-22T15:34:14.746Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>《【翻译】如何编写 Git 提交消息》[^1]的简体中文翻译版本对应原文为 <a href="https://chris.beams.io/posts/git-commit/">How to Write a Git Commit Message</a> ，原作者为 Chris Beams 。</p></blockquote><span id="more"></span><p>《【翻译】如何编写 Git 提交消息》[^1]的简体中文翻译版本对应原文为 <a href="https://chris.beams.io/posts/git-commit/">How to Write a Git Commit Message</a> ，原作者为 Chris Beams 。请注意：</p><ul><li>正文格式尽可能与原网页保持一致；</li><li>译者注将以脚注 (footnote) 的形式呈现，且其内容应以”译者注：“起始；</li><li>原文中若有文内跳转超链接，如无必要，将直接去除，且不在译文中作进一步说明；</li><li>原文中若有翻译后难以传达作者写作意图的词句 (通常是命令，或由源语言的特殊性质等原因导致) ，此时将不再翻译，且不在译文中作进一步说明。</li></ul><p>翻译文本将从随后的分隔线开始展示。</p><hr><h1 id="如何编写-Git-提交信息"><a href="#如何编写-Git-提交信息" class="headerlink" title="如何编写 Git 提交信息"></a>如何编写 Git 提交信息</h1><blockquote><p>原作者： Chris Beams<br>原文创作日期： 2014 年 8 月 31 日</p></blockquote><blockquote><p>提交消息很重要。这里将展示如何写好它们。</p></blockquote><p><img src="/2021/10/02/techdev/how-to-write-a-git-commit-message-chs/images/1.png" alt="图1 信息量递减的提交消息"></p><!-- ![图1 信息量递减的提交消息](https://z3.ax1x.com/2021/08/22/hS1yxH.png) --><h2 id="引子：为什么好的提交消息很重要"><a href="#引子：为什么好的提交消息很重要" class="headerlink" title="引子：为什么好的提交消息很重要"></a>引子：为什么好的提交消息很重要</h2><p>如果你曾随意地浏览过一些 Git 仓库，你很可能会发现它们的提交消息或多或少有些杂乱。例如，你可以看看我早期提交给 Spring 的一些 <a href="https://github.com/spring-projects/spring-framework/commits/e5f4b49?author=cbeams">Gem</a>[^2] 的日志：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ git log --oneline -5 --author cbeams --before &quot;Fri Mar 26 2009&quot;</span><br><span class="line"></span><br><span class="line">e5f4b49 Re-adding ConfigurationPostProcessorTests after its brief removal in r814. @Ignore-ing the testCglibClassesAreLoadedJustInTimeForEnhancement() method as it turns out this was one of the culprits in the recent build breakage. The classloader hacking causes subtle downstream effects, breaking unrelated tests. The test method is still useful, but should only be run on a manual basis to ensure CGLIB is not prematurely classloaded, and should not be run as part of the automated build.</span><br><span class="line">2db0f12 fixed two build-breaking issues: + reverted ClassMetadataReadingVisitor to revision 794 + eliminated ConfigurationPostProcessorTests until further investigation determines why it causes downstream tests to fail (such as the seemingly unrelated ClassPathXmlApplicationContextTests)</span><br><span class="line">147709f Tweaks to package-info.java files</span><br><span class="line">22b25e0 Consolidated Util and MutableAnnotationUtils classes into existing AsmUtils</span><br><span class="line">7f96f57 polishing</span><br></pre></td></tr></table></figure><p>呀！再比较一下同一个仓库近期的一些提交的日志：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ git log --oneline -5 --author pwebb --before &quot;Sat Aug 30 2014&quot;</span><br><span class="line"></span><br><span class="line">5ba3db6 Fix failing CompositePropertySourceTests</span><br><span class="line">84564a0 Rework @PropertySource early parsing logic</span><br><span class="line">e142fd1 Add tests for ImportSelector meta-data</span><br><span class="line">887815f Update docbook dependency and generate epub</span><br><span class="line">ac8326d Polish mockito usage</span><br></pre></td></tr></table></figure><p>你更想去阅读哪一种呢？</p><p>前者的提交消息在长度和形式上各不相同，而后者更加精准和一致；前者是自然而然的结果，而后者绝不会是碰巧写成的。</p><p>当许多提交日志类似于前者的仓库随处可见时，也有一些例外存在。 <a href="https://github.com/torvalds/linux/commits/master">Linux 内核</a>和 <a href="https://github.com/git/git/commits/master">Git 自身</a>的源码正是良好的范例。或是看看 <a href="https://github.com/spring-projects/spring-boot/commits/master">Spring Boot</a> 或由 <a href="https://github.com/tpope/vim-pathogen/commits/master">Tim Pope</a> 管理的仓库。</p><p>这些仓库的贡献者们知道，一个经过精心打磨的 Git 提交消息是将一个更改与其他开发者 (以及未来的自己) 交流其<em>来龙去脉</em>的最好方式[^3]。一个 diff 的输出结果将告诉你<em>什么</em>改变了，而只有提交消息能恰当地告诉你<em>为什么</em>改变了。 Peter Hutterer <a href="http://who-t.blogspot.co.at/2009/12/on-commit-messages.html">将这个观点表达</a>得很好：</p><blockquote><p>重新确定一段代码的上下文是浪费的。我们不能完全避免它，因此我们应当努力去[竭尽]所能<a href="http://www.osnews.com/story/19266/WTFs_m">减少这种情况</a>的发生。提交消息能准确地做到这一点，所以<em>一条提交消息能够展示出一位开发者是不是好的协作者</em>。[^4]</p></blockquote><p>如果你还没有很多思路来编写良好的 Git 提交消息，这或许说明你没有花费很多时间使用 <code>git log</code> 命令和相关的工具。这里有一个残酷的循环：因为提交历史是缺少结构和一致性的，某个人不会花费很多时间使用或关心它。并且因为它不被使用或关心，它将始终缺少结构和一致性。</p><p>然而，被维护得很好的日志是一种优美和实用的东西，这会让 <code>git blame</code> 、<code>revert</code> 、<code>rebase</code> 、<code>log</code> 、<code>shortlog</code> 和其他子命令充满活力，会给回顾其他人的提交和 pull requests 带来一些价值——并且它们突然能被独立地完成。理解几个月或几年前一些事情为什么发生将不但变得可能，还将变得高效。</p><p>一个项目能否取得长远的成功 (相较于其他因素) 不但取决于其可维护性如何，还在于一个维护者是否没有多少比日志更加有力的工具了。我们值得花费一些时间来学习如何适切地维护项目的日志。起初维护日志时可能的困境不久就会转变为习惯，并最终成为所有参与者自豪感和生产力的源泉。</p><p>在这篇文章中，我将会告诉你保持一份健康的提交历史的最基础的要素：如何编写一条独立的提交消息。还有其他我在这里不会提及的重要习惯，比如说统整提交[^5]，或许我会在后续的投稿中谈到它们。</p><p>大多数编程语言都有着已经成形的惯例，它们构建了符合语言习惯的风格，就像命名、格式等等[^6]。当然，这些惯例有诸多变种，但大部分开发者都认同专注于其中一种的情形远优于每个人各自选用一种造成的混乱局面。</p><p>一个团队对待提交日志的方式应当没有丝毫不同。为了创建一份实用的修订历史，团队应该首先在至少符合以下三点的提交消息惯例上达成共识：</p><p><strong>风格</strong>。标记语言的句法[^7]，折行的间隔，语法[^8]，大小写，标点符号。将这些都明确给出，去除猜测，并且让一切都尽可能简单。最终的结果将会是一份格外一致的日志——不仅阅读起来很愉悦，而且实际上<em>的确能被定期阅读</em>[^9]。</p><p><strong>内容</strong>。提交消息的主体 (如果有的话) 应该包含什么信息？什么是<em>不能</em>包含的？</p><p><strong>元数据</strong>。诸如 issue 的追踪编号[^10]、 pull request 的编号应当如何被提及？</p><p>万幸的是，已经有一些成形的惯例来创建一条符合语言习惯的 Git 提交消息。的确，这些都假定在特定的 Git 命令运作的方式下。这里没有你需要重新发明的地方，只要遵循下方的七条规则，你就推开了像专家一样提交的大门。</p><h2 id="编写好的-Git-提交消息的七条规则"><a href="#编写好的-Git-提交消息的七条规则" class="headerlink" title="编写好的 Git 提交消息的七条规则"></a>编写好的 Git 提交消息的七条规则</h2><blockquote><p><em>请谨记：<a href="http://tbaggery.com/2008/04/19/a-note-about-git-commit-messages.html">这些</a><a href="https://www.git-scm.com/book/en/v2/Distributed-Git-Contributing-to-a-Project#_commit_guidelines">都</a><a href="https://github.com/torvalds/subsurface-for-dirk/blob/master/README.md#contributing">已被</a><a href="http://who-t.blogspot.co.at/2009/12/on-commit-messages.html">提出</a><a href="https://github.com/erlang/otp/wiki/writing-good-commit-messages">过</a><a href="https://github.com/spring-projects/spring-framework/blob/30bce7/CONTRIBUTING.md#format-commit-messages">了</a>。</em></p></blockquote><ol><li>用一个空行分隔标题和主体；</li><li>标题控制在 50 个字符以内；</li><li>标题的首字母大写；</li><li>标题的末尾不要写句号；</li><li>标题使用祈使语气；</li><li>主体每 72 个字符折行；</li><li>用主体解释<em>做了什么</em>和<em>为什么</em>，而不是<em>如何做到</em>。</li></ol><p>例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Summarize changes in around 50 characters or less</span><br><span class="line"></span><br><span class="line">More detailed explanatory text, if necessary. Wrap it to about 72</span><br><span class="line">characters or so. In some contexts, the first line is treated as the</span><br><span class="line">subject of the commit and the rest of the text as the body. The</span><br><span class="line">blank line separating the summary from the body is critical (unless</span><br><span class="line">you omit the body entirely); various tools like `log`, `shortlog`</span><br><span class="line">and `rebase` can get confused if you run the two together.</span><br><span class="line"></span><br><span class="line">Explain the problem that this commit is solving. Focus on why you</span><br><span class="line">are making this change as opposed to how (the code explains that).</span><br><span class="line">Are there side effects or other unintuitive consequences of this</span><br><span class="line">change? Here&#x27;s the place to explain them.</span><br><span class="line"></span><br><span class="line">Further paragraphs come after blank lines.</span><br><span class="line"></span><br><span class="line"> - Bullet points are okay, too</span><br><span class="line"></span><br><span class="line"> - Typically a hyphen or asterisk is used for the bullet, preceded</span><br><span class="line">   by a single space, with blank lines in between, but conventions</span><br><span class="line">   vary here</span><br><span class="line"></span><br><span class="line">If you use an issue tracker, put references to them at the bottom,</span><br><span class="line">like this:</span><br><span class="line"></span><br><span class="line">Resolves: #123</span><br><span class="line">See also: #456, #789</span><br></pre></td></tr></table></figure><h3 id="1-用一个空行分隔标题和主体"><a href="#1-用一个空行分隔标题和主体" class="headerlink" title="1. 用一个空行分隔标题和主体"></a>1. 用一个空行分隔标题和主体</h3><p>根据 <code>git commit</code> 命令的<a href="https://www.kernel.org/pub/software/scm/git/docs/git-commit.html#_discussion">帮助页面</a>：</p><blockquote><p>尽管不是必须的，一个好主意是，提交消息以一行简短的 (少于 50 个字符) 概括这个更改的文字为开始，紧接着是一个空行，随后是一段更详细的描述。整段文本的首行将被认作为提交的标题，那个标题将贯穿整个 Git[^11] 。例如， Git-format-patch(1) 将提交转变为邮件，它将提交的标题作为邮件的主题，将剩余的提交内容作为邮件的主体。</p></blockquote><p>首先，不是每一次提交都需要标题和主体。有时一行也很好，尤其是当更改很简单以至于进一步的阐释都不必要的时候。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Fix typo in introduction to user guide</span><br></pre></td></tr></table></figure><p>没有什么是需要解释的了。如果读者想知道这个拼写错误是什么，直接看这个更改本身即可，换句话说使用 <code>git show</code> 、 <code>git diff</code> 或 <code>git log -p</code> 。</p><p>如果你想用命令提交，给 <code>git commit</code> 命令添加 <code>-m</code> 选项是很容易的：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git commit -m<span class="string">&quot;Fix typo in introduction to user guide&quot;</span></span><br></pre></td></tr></table></figure><p>然而，当一个提交需要一点解释和上下文时，你需要编写它的主体。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Derezz the master control program</span><br><span class="line"></span><br><span class="line">MCP turned out to be evil and had become intent on world domination.</span><br><span class="line">This commit throws Tron&#x27;s disc into MCP (causing its deresolution)</span><br><span class="line">and turns it back into a chess game.</span><br></pre></td></tr></table></figure><p>用 <code>-m</code> 选项来写提交消息的主体不是很容易，你最好在一个合适的文本编辑器中编写它。如果你还没有一个编辑器，使用 Git 命令行来设置，参阅 <a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Configuration">Pro Git 的这一节</a>。</p><p>在任何情形下，标题和主体之间的间隔都能在浏览日志时得到回报。这里是完整的日志：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ git log</span><br><span class="line">commit 42e769bdf4894310333942ffc5a15151222a87be</span><br><span class="line">Author: Kevin Flynn &lt;kevin@flynnsarcade.com&gt;</span><br><span class="line">Date:   Fri Jan 01 00:00:00 1982 -0200</span><br><span class="line"></span><br><span class="line"> Derezz the master control program</span><br><span class="line"></span><br><span class="line"> MCP turned out to be evil and had become intent on world domination.</span><br><span class="line"> This commit throws Tron&#x27;s disc into MCP (causing its deresolution)</span><br><span class="line"> and turns it back into a chess game.</span><br></pre></td></tr></table></figure><p>现在执行 <code>git log --oneline</code> ，这会仅输出标题行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git log --oneline</span><br><span class="line">42e769 Derezz the master control program</span><br></pre></td></tr></table></figure><p>或者是执行 <code>git shortlog</code> ，这会按照用户给提交分组，为了简洁，同样会仅输出标题行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ git shortlog</span><br><span class="line">Kevin Flynn (1):</span><br><span class="line">      Derezz the master control program</span><br><span class="line"></span><br><span class="line">Alan Bradley (1):</span><br><span class="line">      Introduce security program &quot;Tron&quot;</span><br><span class="line"></span><br><span class="line">Ed Dillinger (3):</span><br><span class="line">      Rename chess program to &quot;MCP&quot;</span><br><span class="line">      Modify chess program</span><br><span class="line">      Upgrade chess program</span><br><span class="line"></span><br><span class="line">Walter Gibbs (1):</span><br><span class="line">      Introduce protoype chess program</span><br></pre></td></tr></table></figure><p>也有一些 Git 中的其他上下文，它们的标题行和主体的区别被打破了——但它们都无法在二者之间不空行时做得合适[^12]。</p><h3 id="2-标题控制在-50-个字符以内"><a href="#2-标题控制在-50-个字符以内" class="headerlink" title="2. 标题控制在 50 个字符以内"></a>2. 标题控制在 50 个字符以内</h3><p>50 个字符不是硬性限制，只是一个经验法则。将标题行控制在这个长度能保证它们是可读的，并且能强迫作者花一些时间思考如何最简洁地解释将要发生什么。</p><blockquote><p>提示：如果你难以概括你提交的内容，或许是因为你一次提交了太多的更改。努力做到<a href="https://www.freshconsulting.com/atomic-commits/">原子级提交</a>[^13] (另一篇投稿的话题) 吧。</p></blockquote><p>GitHub 的用户界面全面地意识到了这些惯例。例如，它会在你的标题行超过 50 个字符时警告你：</p><p><img src="/2021/10/02/techdev/how-to-write-a-git-commit-message-chs/images/2.png" alt="图2 GitHub 的字数警告"></p><!-- ![图2 GitHub 的字数警告](https://z3.ax1x.com/2021/08/22/hS1sRe.png) --><p>并且会截断超过 72 个字符的标题行，后续用省略号代替：</p><p><img src="/2021/10/02/techdev/how-to-write-a-git-commit-message-chs/images/3.png" alt="图3 GitHub 的字数超限截断"></p><!-- ![图3 GitHub 的字数超限截断](https://z3.ax1x.com/2021/08/22/hS1rGD.png) --><p>因此，争取限制在 50 个字符以内，并把 72 个字符当作是硬性限制。</p><h3 id="3-标题的首字母大写"><a href="#3-标题的首字母大写" class="headerlink" title="3. 标题的首字母大写"></a>3. 标题的首字母大写</h3><p>这就跟听起来一样简单。所有的标题行的首字母都需要大写。</p><p>例如，用：</p><ul><li>Accelerate to 88 miles per hour</li></ul><p>来替代：</p><ul><li><del>accelerate to 88 miles per hour</del></li></ul><h3 id="4-标题的末尾不要写句号"><a href="#4-标题的末尾不要写句号" class="headerlink" title="4. 标题的末尾不要写句号"></a>4. 标题的末尾不要写句号</h3><p>句末标点在标题中时无关紧要的。另外，当你想要控制 50 个字符时，空格是很珍贵的。</p><p>例如，用：</p><ul><li>Open the pod bay doors</li></ul><p>来替代：</p><ul><li><del>Open the pod bay doors.</del></li></ul><h3 id="5-标题使用祈使语气"><a href="#5-标题使用祈使语气" class="headerlink" title="5. 标题使用祈使语气"></a>5. 标题使用祈使语气</h3><p><em>祈使语气</em>意思就是“说出或写出类似命令或指示的东西”。以下是一些例子：</p><ul><li>清理你的房间</li><li>关上这扇门</li><li>拿走垃圾</li></ul><p>你正在阅读的七条规则的每一条都是用祈使语气写成的 (“主体每 72 个字符折行”以及其他的) 。</p><p>祈使语气听起来有一些失礼，这就是为什么我们不常使用，但是这对于 Git 提交的标题来说很完美，其中一个原因是 <strong>Git 自身以你的名义创建提交时都是使用祈使语气</strong>。</p><p>例如，使用 <code>git merge</code> 后的默认提交消息即是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Merge branch &#x27;myfeature&#x27;</span><br></pre></td></tr></table></figure><p>还有使用 <code>git revert</code> 后：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Revert &quot;Add the thing with the stuff&quot;</span><br><span class="line"></span><br><span class="line">This reverts commit cc87791524aedd593cff5a74532befe7ab69ce9d.</span><br></pre></td></tr></table></figure><p>或者是在 GitHub 的Pull Request 界面点击 “Merge” 按钮时：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Merge pull request #123 from someuser/somebranch</span><br></pre></td></tr></table></figure><p>因此，当你用祈使语气编写提交消息时，你就是在遵守 Git 内置的惯例。例如：</p><ul><li>Refactor subsystem X for readability</li><li>Update getting started documentation</li><li>Remove deprecated methods</li><li>Release version 1.0.0</li></ul><p>起初这样写可能显得有些蠢。我们更常用<em>陈述语气</em>说话，这种语气都是用于描述事实，这就是为什么提交消息很多都像这样结束了：</p><ul><li><del>Fixed bug with Y</del></li><li><del>Changing behavior of X</del></li></ul><p>并且有时提交消息写起来就像是它们的内容的描述：</p><ul><li><del>More fixes for broken stuff</del></li><li><del>Sweet new API methods</del></li></ul><p>为了去除任何困惑，这里是一条简单的规则来让你每次都能做对：</p><p><strong>一个合适的 Git 提交的标题应当总是能完成如下的句子：</strong></p><ul><li>如果被应用了，这个提交将会<em>这是你的标题</em></li></ul><p>例如：</p><ul><li>If applied, this commit will <em>refactor subsystem X for readability</em></li><li>If applied, this commit will <em>update getting started documentation</em></li><li>If applied, this commit will <em>remove deprecated methods</em></li><li>If applied, this commit will <em>release version 1.0.0</em></li><li>If applied, this commit will <em>merge pull request #123 from user/branch</em></li></ul><p>注意到对于非祈使语气，这是不能成功的：</p><ul><li>If applied, this commit will <del>fixed bug with Y</del></li><li>If applied, this commit will <del>changing behavior of X</del></li><li>If applied, this commit will <del>more fixes for broken stuff</del></li><li>If applied, this commit will <del>sweet new API methods</del></li></ul><blockquote><p>记住：祈使语气的使用仅对标题很重要。在写主体时，你可以放松这条规定。</p></blockquote><h3 id="6-主体每-72-个字符折行"><a href="#6-主体每-72-个字符折行" class="headerlink" title="6. 主体每 72 个字符折行"></a>6. 主体每 72 个字符折行</h3><p>Git 从来不会自动折行。当你编写一个提交的主体时，你需要注意到它的右边界，并手动折行。</p><p>折行的推荐值是 72 个字符，因此 Git 在大体上将对 80 个字符以内的内容保持原样，有足够的空间用于缩进排版。</p><p>一个好的文本编辑器能帮到你。 Vim 的配置很容易，例如在编写 Git 提交消息时在 72 个字符处折行。然而，在传统意义上， IDE 对于智能地支持提交消息的折行很糟糕 (尽管 IntelliJ IDEA 在最近的版本中<a href="https://youtrack.jetbrains.com/issue/IDEA-53615">终于</a><a href="https://youtrack.jetbrains.com/issue/IDEA-53615#comment=27-448299">做得</a><a href="https://youtrack.jetbrains.com/issue/IDEA-53615#comment=27-446912">比以前好</a>了) 。</p><h3 id="7-用主体解释做了什么和为什么，而不是如何做到"><a href="#7-用主体解释做了什么和为什么，而不是如何做到" class="headerlink" title="7. 用主体解释做了什么和为什么，而不是如何做到"></a>7. 用主体解释做了什么和为什么，而不是如何做到</h3><p>这里的<a href="https://github.com/bitcoin/bitcoin/commit/eb0b56b19017ab5c16c745e6da39c53126924ed6">一条来自 Bitcoin Core 的提交</a> 是解释更改了什么和为什么的最佳范例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">commit eb0b56b19017ab5c16c745e6da39c53126924ed6</span><br><span class="line">Author: Pieter Wuille &lt;pieter.wuille@gmail.com&gt;</span><br><span class="line">Date:   Fri Aug 1 22:57:55 2014 +0200</span><br><span class="line"></span><br><span class="line">   Simplify serialize.h&#x27;s exception handling</span><br><span class="line"></span><br><span class="line">   Remove the &#x27;state&#x27; and &#x27;exceptmask&#x27; from serialize.h&#x27;s stream</span><br><span class="line">   implementations, as well as related methods.</span><br><span class="line"></span><br><span class="line">   As exceptmask always included &#x27;failbit&#x27;, and setstate was always</span><br><span class="line">   called with bits = failbit, all it did was immediately raise an</span><br><span class="line">   exception. Get rid of those variables, and replace the setstate</span><br><span class="line">   with direct exception throwing (which also removes some dead</span><br><span class="line">   code).</span><br><span class="line"></span><br><span class="line">   As a result, good() is never reached after a failure (there are</span><br><span class="line">   only 2 calls, one of which is in tests), and can just be replaced</span><br><span class="line">   by !eof().</span><br><span class="line"></span><br><span class="line">   fail(), clear(n) and exceptions() are just never called. Delete</span><br><span class="line">   them.</span><br></pre></td></tr></table></figure><p>看一看它的<a href="https://github.com/bitcoin/bitcoin/commit/eb0b56b19017ab5c16c745e6da39c53126924ed6">完整的 diff 信息</a>，思考这位作者在此时此地花费时间提供代码的上下文节约了其他和未来的提交者多少时间。如果他没有做到，这次提交将很可能会永远被遗忘。</p><p>在大多数情况下，你可以省去这个更改如何被做出的细节。在这点上，代码通常能自我解释 (如果这段代码如此复杂以至于它需要用枯燥的语言来解释，那就是源代码注释应该做的事情了) 。只是专注于首先明确更改的原因——你在更改之前所做的事 (以及出现了什么错误) ，它们现在如何工作的，以及为什么你决定用你的方式解决这个问题[^14]。</p><p>未来感谢你的维护者可能就是你自己！</p><h2 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h2><h3 id="学着热爱命令行。把-IDE-抛在脑后。"><a href="#学着热爱命令行。把-IDE-抛在脑后。" class="headerlink" title="学着热爱命令行。把 IDE 抛在脑后。"></a>学着热爱命令行。把 IDE 抛在脑后。</h3><p>处于诸多原因，比如说 Git 子命令的存在，拥抱命令行是一种明智之举。 Git 有着令人疯狂的力量， IDE 亦然，但这两者体现在不同的方面上。我每天都使用一款 IDE (IntelliJ IDEA) ，也广泛地使用其他的 (Eclipse) ，但我还从没有见过哪款 IDE 的 Git 集成能比得上简单有力的命令行 (一旦你意识到了这点) 。</p><p>某些 Git 相关的 IDE 功能是无价的[^15]，就像当你删除文件时执行 <code>git rm</code> ，在你重命名文件的时候用 <code>git</code> 执行正确的命令。而当你开始试着用 IDE 提交、合并、 rebase 或分析高深莫测的历史记录时，一切都会崩溃。</p><p>当支配 Git 的全部法力之日到来之时，一切都只剩下命令行。</p><p>记住不论你是使用 Bash 、 zsh 还是 PowerShell ，都有 <a href="https://git-scm.com/book/en/v2/Appendix-A%3A-Git-in-Other-Environments-Git-in-Bash">Tab</a> <a href="https://git-scm.com/book/en/v2/Appendix-A%3A-Git-in-Other-Environments-Git-in-Zsh">自动补全</a><a href="https://git-scm.com/book/en/v2/Appendix-A%3A-Git-in-Other-Environments-Git-in-PowerShell">脚本</a>来减轻不少记忆子命令和开关的痛苦。</p><h3 id="阅读-Pro-Git"><a href="#阅读-Pro-Git" class="headerlink" title="阅读 Pro Git"></a>阅读 Pro Git</h3><p><a href="https://git-scm.com/book/en/v2">Pro Git</a> 在网上可以免费阅读，并且它很美妙。好好利用它吧！</p><p><em>题图提供者： <a href="https://xkcd.com/1296/">xkcd</a></em></p><hr><p><strong>【完】</strong></p><h6 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h6><p>[^1]: 译者注：”提交消息“原文为 ”commit message“ ，下同。<br>[^2]: 译者注： Spring 库的插件名为 “Gem” 。<br>[^3]: 译者注：原文为 ”The contributors to these repositories know that a well-crafted Git commit message is the best way to communicate context about a change to fellow developers (and indeed to their future selves)“ 。<br>[^4]: 译者注：原文为 ”Re-establishing the context of a piece of code is wasteful. We can’t avoid it completely, so our efforts should go to <u>reducing it</u> [as much] as possible. Commit messages can do exactly that and as a result, <em>a commit message shows whether a developer is a good collaborator</em>“ 。<br>[^5]: 译者注：原文为 “commit squashing” 。<br>[^6]: 译者注：原文为 “Most programming languages have well-established conventions as to what constitutes idiomatic style, i.e. naming, formatting and so on” 。<br>[^7]: 译者注：原文为 “syntax” 。<br>[^8]: 译者注：原文为 “grammar” 。<br>[^9]: 译者注：原文为 “The end result will be a remarkably consistent log that’s not only a pleasure to read but that actually <em>does get read</em> on a regular basis” 。<br>[^10]: 译者注：原文为 “issue tracking IDs” 。<br>[^11]: 译者注：原文为 “ The text up to the first blank line in a commit message is treated as the commit title, and that title is used throughout Git” 。<br>[^12]: 译者注：原文为 “There are a number of other contexts in Git where the distinction between subject line and body kicks in—but none of them work properly without the blank line in between” 。<br>[^13]: 译者注：原文为 “atomic commits” 。<br>[^14]: 译者注：原文为 “Just focus on making clear the reasons why you made the change in the first place—the way things worked before the change (and what was wrong with that), the way they work now, and why you decided to solve it the way you did” 。<br>[^15]: 译者注：原文为 “Certain Git-related IDE functions are invaluable” 。</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;《【翻译】如何编写 Git 提交消息》[^1]的简体中文翻译版本对应原文为 &lt;a href=&quot;https://chris.beams.io/posts/git-commit/&quot;&gt;How to Write a Git Commit Message&lt;/a&gt; ，原作者为 Chris Beams 。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Translation" scheme="https://blog.imakiseki.cf/categories/Translation/"/>
    
    
    <category term="Programming" scheme="https://blog.imakiseki.cf/tags/Programming/"/>
    
    <category term="Simplified Chinese" scheme="https://blog.imakiseki.cf/tags/Simplified-Chinese/"/>
    
    <category term="Git" scheme="https://blog.imakiseki.cf/tags/Git/"/>
    
  </entry>
  
  <entry>
    <title>【文件格式探究】EP.1 对ePub文件格式的初探</title>
    <link href="https://blog.imakiseki.cf/techdev/format/epub/"/>
    <id>https://blog.imakiseki.cf/techdev/format/epub/</id>
    <published>2021-08-22T15:36:05.000Z</published>
    <updated>2022-01-22T15:34:35.641Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>这是“文件格式探究”专题的第 1 期——初探 “ePub” 文件格式。</p></blockquote><span id="more"></span><p>这是“文件格式探究”专题的第 1 期——初探 “ePub” 文件格式。这个专题将会给各位读者呈现笔者探索各种文件格式的过程，具体则是文件的内容是<strong>如何呈现</strong>出来的。原则上我们假定仅对于这些文件格式的<strong>用途</strong>有所了解，但具体实现的细节并不清楚 (如果提前掌握了部分内容，笔者全当其不存在) 。探究过程中我们会尝试使用各种方法来逐渐初步掌握其概貌。</p><h2 id="文件格式简介"><a href="#文件格式简介" class="headerlink" title="文件格式简介"></a>文件格式简介</h2><p>根据<a href="https://zh.wikipedia.org/zh-cn/EPUB">维基百科大陆简体版本</a>的相关描述：</p><blockquote><p>EPub 是一个自由的开放标准，属于一种可以“自动重新排版”的内容；也就是文字内容可以根据阅读设备的特性，以最适于阅读的方式显示。</p></blockquote><p>之所以后面不截是因为再截就剧透了。简单来说，ePub 就是类似于 PDF 那样的“文档型”文件格式，常用于分发电子读物等。</p><h2 id="探究过程"><a href="#探究过程" class="headerlink" title="探究过程"></a>探究过程</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>现在笔者手头上有一份用于测试的 ePub 文件，文件路径为 <code>~/Downloads/咖啡馆推理事件簿系列（全四本）.epub</code> <del>(趁机夹带私货，反正很合我胃口就是了)</del> ，后续所有的探究活动均建立于此文件上。笔者目前的操作系统环境为 Manjaro 21.1.0 on amd64，终端环境为 GNU bash 5.1.8(1)-release 。为了方便，我们先把文件改个名字 (那你还把原来的名字给出来干嘛？！) ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[littleye233@lymjrolt Downloads]$ <span class="built_in">cd</span> ~</span><br><span class="line">[littleye233@lymjrolt ~]$ <span class="built_in">cd</span> Downloads</span><br><span class="line">[littleye233@lymjrolt Downloads]$ mv 咖啡馆推理事件簿系列（全四本）.epub test.epub</span><br><span class="line">[littleye233@lymjrolt Downloads]$ ll test.epub</span><br><span class="line">-rw-r--r-- 1 littleye233 littleye233 1253964 Aug 22 23:24 test.epub</span><br></pre></td></tr></table></figure><h3 id="Round-I-文件类型"><a href="#Round-I-文件类型" class="headerlink" title="Round I. 文件类型"></a>Round I. 文件类型</h3><p>首先我们先尝试用 Linux 系统的内置命令 <code>file</code> 试试水，看看会输出什么东西。键入 <code>file test.epub</code>后执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[littleye233@lymjrolt Downloads]$ file test.epub</span><br><span class="line">test.epub: EPUB document EPUB document</span><br></pre></td></tr></table></figure><p>哎呀，真可惜！ <code>file</code> 命令几乎什么有效信息都没给我们。 <code>file</code> 命令的 <code>man</code> 页面明确给出此命令可以判断文件格式，但其实它能做到的有很多，例如如果对一个图片文件使用 <code>file</code> ，可能会出现类似下面的结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[littleye233@lymjrolt Downloads]$ file ~/.<span class="built_in">local</span>/share/osu/screenshots/osu_2021-08-21_23-40-03.png</span><br><span class="line">/home/littleye233/.<span class="built_in">local</span>/share/osu/screenshots/osu_2021-08-21_23-40-03.png: PNG image data, 1920 x 961, 8-bit/color RGBA, non-interlaced</span><br></pre></td></tr></table></figure><p>这样我们可以通过 <code>file</code> 中提供的相关信息顺藤摸瓜，尝试在文件的二进制编码内容中寻找其蛛丝马迹，进而推测对应“位点”所表达的含义 (因为一些文件格式要求在特定的位置表达某些含义) ，如果能提供类似注释的信息就再好不过了。</p><h3 id="Round-II-文件结构"><a href="#Round-II-文件结构" class="headerlink" title="Round II. 文件结构"></a>Round II. 文件结构</h3><p>现在我们回到这个 ePub 文件上来。现在我们尝试能否直接获取其内容，目的是通过文件头部的部分<strong>可见</strong>字符猜测其文件结构。输入 <code>nano test.epub</code> 直接预览，或使用 <code>head --bytes=120 test.epub</code> 查看前面 120 个字节的内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[littleye233@lymjrolt Downloads]$ head --bytes=120 test.epub</span><br><span class="line">PK!oa�mimetypeapplication/epub+zipPU�N�;�ʯ�META-INF/container.xml]�A</span><br><span class="line">�0E�=</span><br></pre></td></tr></table></figure><p>果不其然，我们看到了一些有趣的字眼： “mimetypeapplication/epub+zip” ，凭经验猜测，这应该是 ePub 文件格式的文件头，而其中的 “zip” 也说明—— ePub 文件可能本质上就是一个压缩档。</p><p>其实很多文件格式 (例如 Word 文档 “*.docx”) 其本质都是在一个压缩档中加入各种资源文件和配置文件，只要有对应的软件进行读取并重新加工，用户即能看到效果。</p><h3 id="Round-III-目录树结构"><a href="#Round-III-目录树结构" class="headerlink" title="Round III. 目录树结构"></a>Round III. 目录树结构</h3><p>现在我们可以使用解压缩程序解出 ePub 文件中的内容了。在终端中执行 <code>unzip -l test.epub</code> ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">[littleye233@lymjrolt Downloads]$ unzip -l test.epub</span><br><span class="line">Archive:  test.epub</span><br><span class="line">  Length      Date    Time    Name</span><br><span class="line">---------  ---------- -----   ----</span><br><span class="line">       20  1980-01-01 00:00   mimetype</span><br><span class="line">      251  2019-06-27 10:40   META-INF/container.xml</span><br><span class="line">    12307  2019-06-27 10:40   OEBPS/content.opf</span><br><span class="line">   112368  2019-06-27 10:40   OEBPS/Images/cover00464.jpeg</span><br><span class="line">   128680  2019-06-27 10:40   OEBPS/Images/image00456.jpeg</span><br><span class="line">   120936  2019-06-27 10:40   OEBPS/Images/image00457.jpeg</span><br><span class="line">     1392  2019-06-27 10:40   OEBPS/Images/image00458.jpeg</span><br><span class="line">   101948  2019-06-27 10:40   OEBPS/Images/image00459.jpeg</span><br><span class="line">   119124  2019-06-27 10:40   OEBPS/Images/image00460.jpeg</span><br><span class="line">     1268  2019-06-27 10:40   OEBPS/Images/image00461.jpeg</span><br><span class="line">    42944  2019-06-27 10:40   OEBPS/Images/image00462.jpeg</span><br><span class="line">   121284  2019-06-27 10:40   OEBPS/Images/image00463.jpeg</span><br><span class="line">     2251  2019-06-27 10:40   OEBPS/Styles/style0001.css</span><br><span class="line">     9816  2019-06-27 10:40   OEBPS/Styles/style0002.css</span><br><span class="line">     2251  2019-06-27 10:40   OEBPS/Styles/style0003.css</span><br><span class="line">     9789  2019-06-27 10:40   OEBPS/Styles/style0004.css</span><br><span class="line">     2251  2019-06-27 10:40   OEBPS/Styles/style0005.css</span><br><span class="line">    29245  2019-06-27 10:40   OEBPS/Styles/style0006.css</span><br><span class="line">     2235  2019-06-27 10:40   OEBPS/Styles/style0007.css</span><br><span class="line">    29914  2019-06-27 10:40   OEBPS/Styles/style0008.css</span><br><span class="line">     2251  2019-06-27 10:40   OEBPS/Styles/style0009.css</span><br><span class="line">      624  2019-06-27 10:40   OEBPS/Text/cover_page.xhtml</span><br><span class="line">      851  2019-06-27 10:40   OEBPS/Text/part0000.xhtml</span><br><span class="line">      561  2019-06-27 10:40   OEBPS/Text/part0001.xhtml</span><br><span class="line">      428  2019-06-27 10:40   OEBPS/Text/part0002.xhtml</span><br><span class="line">     1518  2019-06-27 10:40   OEBPS/Text/part0003.xhtml</span><br><span class="line">      661  2019-06-27 10:40   OEBPS/Text/part0004.xhtml</span><br><span class="line">     2311  2019-06-27 10:40   OEBPS/Text/part0005.xhtml</span><br><span class="line">    55157  2019-06-27 10:40   OEBPS/Text/part0006.xhtml</span><br><span class="line">    58266  2019-06-27 10:40   OEBPS/Text/part0007.xhtml</span><br><span class="line">    59953  2019-06-27 10:40   OEBPS/Text/part0008.xhtml</span><br><span class="line">    49789  2019-06-27 10:40   OEBPS/Text/part0009.xhtml</span><br><span class="line">    66870  2019-06-27 10:40   OEBPS/Text/part0010.xhtml</span><br><span class="line">    57342  2019-06-27 10:40   OEBPS/Text/part0011.xhtml</span><br><span class="line">    67449  2019-06-27 10:40   OEBPS/Text/part0012.xhtml</span><br><span class="line">    16183  2019-06-27 10:40   OEBPS/Text/part0013.xhtml</span><br><span class="line">      561  2019-06-27 10:40   OEBPS/Text/part0014.xhtml</span><br><span class="line">      428  2019-06-27 10:40   OEBPS/Text/part0015.xhtml</span><br><span class="line">     1575  2019-06-27 10:40   OEBPS/Text/part0016.xhtml</span><br><span class="line">      496  2019-06-27 10:40   OEBPS/Text/part0017.xhtml</span><br><span class="line">     1446  2019-06-27 10:40   OEBPS/Text/part0018.xhtml</span><br><span class="line">    52358  2019-06-27 10:40   OEBPS/Text/part0019.xhtml</span><br><span class="line">    75746  2019-06-27 10:40   OEBPS/Text/part0020.xhtml</span><br><span class="line">    63420  2019-06-27 10:40   OEBPS/Text/part0021.xhtml</span><br><span class="line">    57399  2019-06-27 10:40   OEBPS/Text/part0022.xhtml</span><br><span class="line">    58590  2019-06-27 10:40   OEBPS/Text/part0023.xhtml</span><br><span class="line">    40263  2019-06-27 10:40   OEBPS/Text/part0024.xhtml</span><br><span class="line">    66099  2019-06-27 10:40   OEBPS/Text/part0025.xhtml</span><br><span class="line">    15143  2019-06-27 10:40   OEBPS/Text/part0026.xhtml</span><br><span class="line">      561  2019-06-27 10:40   OEBPS/Text/part0027.xhtml</span><br><span class="line">      612  2019-06-27 10:40   OEBPS/Text/part0028.xhtml</span><br><span class="line">     1344  2019-06-27 10:40   OEBPS/Text/part0029.xhtml</span><br><span class="line">      640  2019-06-27 10:40   OEBPS/Text/part0030.xhtml</span><br><span class="line">     6144  2019-06-27 10:40   OEBPS/Text/part0031.xhtml</span><br><span class="line">    25197  2019-06-27 10:40   OEBPS/Text/part0032.xhtml</span><br><span class="line">    54594  2019-06-27 10:40   OEBPS/Text/part0033.xhtml</span><br><span class="line">    87394  2019-06-27 10:40   OEBPS/Text/part0034.xhtml</span><br><span class="line">    97557  2019-06-27 10:40   OEBPS/Text/part0035.xhtml</span><br><span class="line">   109901  2019-06-27 10:40   OEBPS/Text/part0036.xhtml</span><br><span class="line">    17181  2019-06-27 10:40   OEBPS/Text/part0037.xhtml</span><br><span class="line">     5238  2019-06-27 10:40   OEBPS/Text/part0038.xhtml</span><br><span class="line">      561  2019-06-27 10:40   OEBPS/Text/part0039.xhtml</span><br><span class="line">      644  2019-06-27 10:40   OEBPS/Text/part0040.xhtml</span><br><span class="line">     1163  2019-06-27 10:40   OEBPS/Text/part0041.xhtml</span><br><span class="line">     1473  2019-06-27 10:40   OEBPS/Text/part0042.xhtml</span><br><span class="line">    38427  2019-06-27 10:40   OEBPS/Text/part0043.xhtml</span><br><span class="line">    90589  2019-06-27 10:40   OEBPS/Text/part0044.xhtml</span><br><span class="line">    51278  2019-06-27 10:40   OEBPS/Text/part0045.xhtml</span><br><span class="line">    58321  2019-06-27 10:40   OEBPS/Text/part0046.xhtml</span><br><span class="line">    29670  2019-06-27 10:40   OEBPS/Text/part0047.xhtml</span><br><span class="line">    12903  2019-06-27 10:40   OEBPS/Text/part0048.xhtml</span><br><span class="line">     7364  2019-06-27 10:40   OEBPS/toc.ncx</span><br><span class="line">---------                     -------</span><br><span class="line">  2422768                     72 files</span><br></pre></td></tr></table></figure><p>同时可以直接解压：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">[littleye233@lymjrolt Downloads]$ unzip test.epub -d test_epub</span><br><span class="line">Archive:  test.epub</span><br><span class="line"> extracting: test_epub/mimetype</span><br><span class="line">  inflating: test_epub/META-INF/container.xml</span><br><span class="line">  inflating: test_epub/OEBPS/content.opf</span><br><span class="line">  inflating: test_epub/OEBPS/Images/cover00464.jpeg</span><br><span class="line">  inflating: test_epub/OEBPS/Images/image00456.jpeg</span><br><span class="line">  inflating: test_epub/OEBPS/Images/image00457.jpeg</span><br><span class="line">  inflating: test_epub/OEBPS/Images/image00458.jpeg</span><br><span class="line">  inflating: test_epub/OEBPS/Images/image00459.jpeg</span><br><span class="line">  inflating: test_epub/OEBPS/Images/image00460.jpeg</span><br><span class="line">  inflating: test_epub/OEBPS/Images/image00461.jpeg</span><br><span class="line">  inflating: test_epub/OEBPS/Images/image00462.jpeg</span><br><span class="line">  inflating: test_epub/OEBPS/Images/image00463.jpeg</span><br><span class="line">  inflating: test_epub/OEBPS/Styles/style0001.css</span><br><span class="line">  inflating: test_epub/OEBPS/Styles/style0002.css</span><br><span class="line">  inflating: test_epub/OEBPS/Styles/style0003.css</span><br><span class="line">  inflating: test_epub/OEBPS/Styles/style0004.css</span><br><span class="line">  inflating: test_epub/OEBPS/Styles/style0005.css</span><br><span class="line">  inflating: test_epub/OEBPS/Styles/style0006.css</span><br><span class="line">  inflating: test_epub/OEBPS/Styles/style0007.css</span><br><span class="line">  inflating: test_epub/OEBPS/Styles/style0008.css</span><br><span class="line">  inflating: test_epub/OEBPS/Styles/style0009.css</span><br><span class="line">  inflating: test_epub/OEBPS/Text/cover_page.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0000.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0001.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0002.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0003.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0004.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0005.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0006.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0007.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0008.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0009.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0010.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0011.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0012.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0013.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0014.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0015.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0016.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0017.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0018.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0019.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0020.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0021.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0022.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0023.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0024.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0025.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0026.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0027.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0028.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0029.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0030.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0031.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0032.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0033.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0034.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0035.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0036.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0037.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0038.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0039.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0040.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0041.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0042.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0043.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0044.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0045.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0046.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0047.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/Text/part0048.xhtml</span><br><span class="line">  inflating: test_epub/OEBPS/toc.ncx</span><br></pre></td></tr></table></figure><p>为了更清楚地显示文件树结构，我们也可以使用 <code>tree</code> 命令 (这个命令在 Windows 中是内置的，在 Linux 中需要安装 <code>tree</code> 这个包，使用软件包管理器或编译安装均可) ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[littleye233@lymjrolt test_epub]$ tree</span><br><span class="line">.</span><br><span class="line">├── META-INF</span><br><span class="line">│   └── container.xml</span><br><span class="line">├── mimetype</span><br><span class="line">└── OEBPS</span><br><span class="line">    ├── content.opf</span><br><span class="line">    ├── Images</span><br><span class="line">    │   ├── cover00464.jpeg</span><br><span class="line">    │   ├── image00456.jpeg</span><br><span class="line">    │   ├── image00457.jpeg</span><br><span class="line">    │   ├── image00458.jpeg</span><br><span class="line">    │   ├── image00459.jpeg</span><br><span class="line">    │   ├── image00460.jpeg</span><br><span class="line">    │   ├── image00461.jpeg</span><br><span class="line">    │   ├── image00462.jpeg</span><br><span class="line">    │   └── image00463.jpeg</span><br><span class="line">    ├── Styles</span><br><span class="line">    │   ├── style0001.css</span><br><span class="line">    │   ├── style0002.css</span><br><span class="line">    │   ├── style0003.css</span><br><span class="line">    │   ├── style0004.css</span><br><span class="line">    │   ├── style0005.css</span><br><span class="line">    │   ├── style0006.css</span><br><span class="line">    │   ├── style0007.css</span><br><span class="line">    │   ├── style0008.css</span><br><span class="line">    │   └── style0009.css</span><br><span class="line">    ├── Text</span><br><span class="line">    │   ├── cover_page.xhtml</span><br><span class="line">    │   ├── part0000.xhtml</span><br><span class="line">    │   ├── part0001.xhtml</span><br><span class="line">    │   ├── part0002.xhtml</span><br><span class="line">    │   ├── part0003.xhtml</span><br><span class="line">    │   ├── part0004.xhtml</span><br><span class="line">    │   ├── part0005.xhtml</span><br><span class="line">    │   ├── part0006.xhtml</span><br><span class="line">    │   ├── part0007.xhtml</span><br><span class="line">    │   ├── part0008.xhtml</span><br><span class="line">    │   ├── part0009.xhtml</span><br><span class="line">    │   ├── part0010.xhtml</span><br><span class="line">    │   ├── part0011.xhtml</span><br><span class="line">    │   ├── part0012.xhtml</span><br><span class="line">    │   ├── part0013.xhtml</span><br><span class="line">    │   ├── part0014.xhtml</span><br><span class="line">    │   ├── part0015.xhtml</span><br><span class="line">    │   ├── part0016.xhtml</span><br><span class="line">    │   ├── part0017.xhtml</span><br><span class="line">    │   ├── part0018.xhtml</span><br><span class="line">    │   ├── part0019.xhtml</span><br><span class="line">    │   ├── part0020.xhtml</span><br><span class="line">    │   ├── part0021.xhtml</span><br><span class="line">    │   ├── part0022.xhtml</span><br><span class="line">    │   ├── part0023.xhtml</span><br><span class="line">    │   ├── part0024.xhtml</span><br><span class="line">    │   ├── part0025.xhtml</span><br><span class="line">    │   ├── part0026.xhtml</span><br><span class="line">    │   ├── part0027.xhtml</span><br><span class="line">    │   ├── part0028.xhtml</span><br><span class="line">    │   ├── part0029.xhtml</span><br><span class="line">    │   ├── part0030.xhtml</span><br><span class="line">    │   ├── part0031.xhtml</span><br><span class="line">    │   ├── part0032.xhtml</span><br><span class="line">    │   ├── part0033.xhtml</span><br><span class="line">    │   ├── part0034.xhtml</span><br><span class="line">    │   ├── part0035.xhtml</span><br><span class="line">    │   ├── part0036.xhtml</span><br><span class="line">    │   ├── part0037.xhtml</span><br><span class="line">    │   ├── part0038.xhtml</span><br><span class="line">    │   ├── part0039.xhtml</span><br><span class="line">    │   ├── part0040.xhtml</span><br><span class="line">    │   ├── part0041.xhtml</span><br><span class="line">    │   ├── part0042.xhtml</span><br><span class="line">    │   ├── part0043.xhtml</span><br><span class="line">    │   ├── part0044.xhtml</span><br><span class="line">    │   ├── part0045.xhtml</span><br><span class="line">    │   ├── part0046.xhtml</span><br><span class="line">    │   ├── part0047.xhtml</span><br><span class="line">    │   └── part0048.xhtml</span><br><span class="line">    └── toc.ncx</span><br><span class="line"></span><br><span class="line">5 directories, 72 files</span><br></pre></td></tr></table></figure><h3 id="Round-IV-内部文件"><a href="#Round-IV-内部文件" class="headerlink" title="Round IV. 内部文件"></a>Round IV. 内部文件</h3><p>到这里我们大概就能猜出来：</p><ul><li><code>META-INF</code> 文件夹：里面存放的应该是“容器” (也就是这个 ePub 文件) 的相关配置文件；</li><li><code>mimetype</code> 文件：里面定义了这个文件的类型为 “ePub” (其中 “MIME” 是 “Multipurpose Internet Mail Extensions” 的缩写，从字面上也能看出其具有指示 “Extension” 的机能) ；</li><li><code>OEBPS</code> 文件夹：虽暂不知其确切含义，但应存放 ePub 的文字、图片以及其他的界面数据；<ul><li><code>content.opf</code> 文件：里面存放的应该是目录信息——或是定义各种文件的“次序”；</li><li><code>Images</code> <code>Styles</code> 和 <code>Text</code> 文件夹：明显分别存放图片、层叠样式表和文字数据；</li><li><code>toc.ncx</code> 文件：可能是真正的目录 (“toc” 是 “table of contents” 的缩写)。</li></ul></li></ul><p>接下来我们将挨个分析。</p><h4 id="Round-IV-I-容器"><a href="#Round-IV-I-容器" class="headerlink" title="Round IV.I. 容器"></a>Round IV.I. 容器</h4><p>先看 <code>META-INF/container.xml</code> ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[littleye233@lymjrolt test_epub]$ file META-INF/container.xml</span><br><span class="line">META-INF/container.xml: XML 1.0 document, ASCII text</span><br></pre></td></tr></table></figure><p>输出其内容：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">container</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;urn:oasis:names:tc:opendocument:xmlns:container&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rootfiles</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rootfile</span> <span class="attr">full-path</span>=<span class="string">&quot;OEBPS/content.opf&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/oebps-package+xml&quot;</span>/&gt;</span>    <span class="tag">&lt;/<span class="name">rootfiles</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">container</span>&gt;</span></span><br></pre></td></tr></table></figure><p>显然是一个标准的 XML 文件，其中我们可以注意到 <code>/container/rootfiles/rootfile[@class=&#39;full-path&#39;]</code>[^1] 中定义了一个我们之前认定的目录文件，但此处可以规范化，故这个文件在大多数 ePub 档中应该是相同的。</p><h4 id="Round-IV-II-文件类型定性"><a href="#Round-IV-II-文件类型定性" class="headerlink" title="Round IV.II. 文件类型定性"></a>Round IV.II. 文件类型定性</h4><p>接下来看 <code>mimetype</code> 文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[littleye233@lymjrolt test_epub]$ cat mimetype</span><br><span class="line">application/epub+zip</span><br></pre></td></tr></table></figure><p>这也是相当显然的，也不再赘述。</p><h4 id="Round-IV-III-目录？"><a href="#Round-IV-III-目录？" class="headerlink" title="Round IV.III. 目录？"></a>Round IV.III. 目录？</h4><p>再看 <code>OEBPS/content.opf</code> ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[littleye233@lymjrolt test_epub]$ file OEBPS/content.opf</span><br><span class="line">OEBPS/content.opf: XML 1.0 document, Unicode text, UTF-8 text, with very long lines (504)</span><br></pre></td></tr></table></figure><p>这也是一个 XML 文件，令人惊讶的是 <code>file</code> 命令竟能看出这个文件中最长的行有 504 个字符，属实让人害怕。</p><details><summary>点此查看 `OEBPS/content.opf` 的全部内容 (已经过格式化)</summary><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.idpf.org/2007/opf&quot;</span> <span class="attr">version</span>=<span class="string">&quot;2.0&quot;</span> <span class="attr">unique-identifier</span>=<span class="string">&quot;uid&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">metadata</span> <span class="attr">xmlns:dc</span>=<span class="string">&quot;http://purl.org/dc/elements/1.1/&quot;</span> <span class="attr">xmlns:opf</span>=<span class="string">&quot;http://www.idpf.org/2007/opf&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dc:title</span> <span class="attr">opf:file-as</span>=<span class="string">&quot;kafeiguantuilishijianbuxilie（quansiben）&quot;</span>&gt;</span>咖啡馆推理事件簿系列（全四本）<span class="tag">&lt;/<span class="name">dc:title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dc:language</span>&gt;</span>zh<span class="tag">&lt;/<span class="name">dc:language</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dc:identifier</span> <span class="attr">id</span>=<span class="string">&quot;uid&quot;</span>&gt;</span>3899198450<span class="tag">&lt;/<span class="name">dc:identifier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dc:creator</span> <span class="attr">opf:file-as</span>=<span class="string">&quot;（ri）gangqizuomo&quot;</span>&gt;</span>（日）冈崎琢磨<span class="tag">&lt;/<span class="name">dc:creator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dc:date</span> <span class="attr">opf:event</span>=<span class="string">&quot;publication&quot;</span>&gt;</span>2018-03-15<span class="tag">&lt;/<span class="name">dc:date</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Extra MetaData from RESC</span></span><br><span class="line"><span class="comment">&lt;dc:coverage/&gt;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;cover&quot;</span> <span class="attr">content</span>=<span class="string">&quot;x_cover-image&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;output encoding&quot;</span> <span class="attr">content</span>=<span class="string">&quot;utf-8&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;primary-writing-mode&quot;</span> <span class="attr">content</span>=<span class="string">&quot;horizontal-lr&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- BEGIN INFORMATION ONLY</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Cover ThumbNail Image&quot; content=&quot;Images/image00466.jpeg&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Drm Ebookbase Book Id&quot; content=&quot;0006008690412&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;ASIN&quot; content=&quot;B07BFTVX98&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Creator-Software&quot; content=&quot;201&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Author-Pronunciation&quot; content=&quot;（ri）gangqizuomo&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Embedded-Record-Count&quot; content=&quot;11&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Unknown_(403)_(hex)&quot; content=&quot;00&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;HasFakeCover&quot; content=&quot;0&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Creator-Major-Version&quot; content=&quot;2&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;cdeType&quot; content=&quot;EBOK&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;override-kindle-fonts&quot; content=&quot;false&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;CDEContentKey&quot; content=&quot;B07BFTVX98&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Compression-Upgraded&quot; content=&quot;Source-Target:c1-c2 KT_Version:2.9 Build:0805-4a0c57c&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;HD-Media-Containers-Info&quot; content=&quot;2400x3840:0-11|&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;548 (hex)&quot; content=&quot;496e4d656d6f7279&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Unknown_(407)_(hex)&quot; content=&quot;0000000000000000&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Amazon_Creator_Info&quot; content=&quot;kjw&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Clipping-Limit&quot; content=&quot;100&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Tamper-Proof-Keys_(hex)&quot; content=&quot;01000000d000000001940000000191000000019500000001960000000197&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Title-Pronunciation&quot; content=&quot;kafeiguantuilishijianbuxilie（quansiben）&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Creator-Minor-Version&quot; content=&quot;9&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;MetadataResourceURI&quot; content=&quot;kindle:embed:000A&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Updated_Title&quot; content=&quot;咖啡馆推理事件簿系列（全四本）&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Ownership-Type_(hex)&quot; content=&quot;00&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;547 (hex)&quot; content=&quot;496e4d656d6f7279&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Content-Language-Tag&quot; content=&quot;zh&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;sample&quot; content=&quot;0&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Metadata-Record-Offset&quot; content=&quot;4294967295&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Creator-Build-Tag&quot; content=&quot;0721-dedaf5&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Publisher-Pronunciation&quot; content=&quot;xiandaichubanshe&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;StartOffset&quot; content=&quot;4294967295&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Watermark_(hex)&quot; content=&quot;6174763a6b696e3a323a49396e41307a4239625565766a514961583462736b66476a394535335a51616a696368585638364447746b65544379504d504c4d75445a35524f39676b584d35515a6433694f424b5531546643766f5a62507763705a6b49486f6f366a6639785944327a4158494263536c495879676b6a38616b566e4763327a2b2b50434c454c464b2b4e30495a4556437a6331516f656f4451546b3865374a6f61696251526d6f682b7574586b3661466a554477704a3165636c68665367414a35664745413a68614f61636b496839662b61786c457733397665774b32554a57453d&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Text-to-Speech-Disabled&quot; content=&quot;0&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Font-Signature_(hex)&quot; content=&quot;0300000000480f08100000000000008000200000000000000000000000000000bef4edec01b701d7409440984099409c409d40a64a804c9c608160826080608b60e8618b60cd60c661aa61f361d661e9629c73df0213c9021fd90173cd01429f037e9a037e8c037e81037e9f&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Rental-Expiration-Time&quot; content=&quot;0000000000000000&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Container_Id&quot; content=&quot;ZkM0&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Mobi8-Boundary-Section&quot; content=&quot;420&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;meta name=&quot;Creator-Build-Number&quot; content=&quot;0&quot; /&gt;</span></span><br><span class="line"><span class="comment">END INFORMATION ONLY --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">metadata</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_cover&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/cover_page.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_TableOfContents&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0000.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a1cover.html&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0001.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a1bookname&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0002.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a1TableOfContents&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0003.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a1Chapter001&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0004.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a1Chapter002&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0005.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a1Chapter003&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0006.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a1Chapter004&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0007.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a1Chapter005&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0008.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a1Chapter006&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0009.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a1Chapter007&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0010.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a1Chapter008&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0011.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a1Chapter009&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0012.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a1Chapter010&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0013.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a2cover.html&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0014.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a2bookname&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0015.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a2TableOfContents&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0016.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a2Chapter001&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0017.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a2Chapter002&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0018.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a2Chapter003&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0019.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a2Chapter004&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0020.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a2Chapter005&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0021.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a2Chapter006&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0022.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a2Chapter007&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0023.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a2Chapter008&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0024.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a2Chapter009&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0025.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a2Chapter010&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0026.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a3cover.html&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0027.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a3bookname&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0028.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a3TableOfContents&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0029.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a3Chapter001&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0030.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a3Chapter002&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0031.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a3Chapter003&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0032.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a3Chapter004&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0033.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a3Chapter005&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0034.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a3Chapter006&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0035.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a3Chapter007&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0036.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a3Chapter008&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0037.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a3Chapter009&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0038.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a4cover.html&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0039.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a4bookname&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0040.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a4TableOfContents&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0041.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a4Chapter001&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0042.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a4Chapter002&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0043.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a4Chapter003&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0044.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a4Chapter004&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0045.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a4Chapter005&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0046.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a4Chapter006&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0047.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_a4Chapter007&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/xhtml+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0048.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item50&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Styles/style0001.css&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item51&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Styles/style0002.css&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item52&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Styles/style0003.css&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item53&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Styles/style0004.css&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item54&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Styles/style0005.css&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item55&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Styles/style0006.css&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item56&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Styles/style0007.css&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item57&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Styles/style0008.css&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item58&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Styles/style0009.css&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item59&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;image/jpeg&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Images/image00456.jpeg&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item60&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;image/jpeg&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Images/image00457.jpeg&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item61&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;image/jpeg&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Images/image00458.jpeg&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item62&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;image/jpeg&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Images/image00459.jpeg&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item63&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;image/jpeg&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Images/image00460.jpeg&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item64&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;image/jpeg&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Images/image00461.jpeg&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item65&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;image/jpeg&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Images/image00462.jpeg&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;item66&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;image/jpeg&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Images/image00463.jpeg&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;x_cover-image&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;image/jpeg&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Images/cover00464.jpeg&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">id</span>=<span class="string">&quot;ncx&quot;</span> <span class="attr">media-type</span>=<span class="string">&quot;application/x-dtbncx+xml&quot;</span> <span class="attr">href</span>=<span class="string">&quot;toc.ncx&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spine</span> <span class="attr">toc</span>=<span class="string">&quot;ncx&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_cover&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;no&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_TableOfContents&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a1cover.html&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a1bookname&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a1TableOfContents&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a1Chapter001&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a1Chapter002&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a1Chapter003&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a1Chapter004&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a1Chapter005&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a1Chapter006&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a1Chapter007&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a1Chapter008&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a1Chapter009&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a1Chapter010&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a2cover.html&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a2bookname&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a2TableOfContents&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a2Chapter001&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a2Chapter002&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a2Chapter003&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a2Chapter004&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a2Chapter005&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a2Chapter006&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a2Chapter007&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a2Chapter008&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a2Chapter009&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a2Chapter010&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a3cover.html&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a3bookname&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a3TableOfContents&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a3Chapter001&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a3Chapter002&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a3Chapter003&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a3Chapter004&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a3Chapter005&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a3Chapter006&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a3Chapter007&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a3Chapter008&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a3Chapter009&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a4cover.html&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a4bookname&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a4TableOfContents&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a4Chapter001&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a4Chapter002&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a4Chapter003&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a4Chapter004&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a4Chapter005&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a4Chapter006&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">itemref</span> <span class="attr">idref</span>=<span class="string">&quot;x_a4Chapter007&quot;</span> <span class="attr">linear</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">spine</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tours</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tours</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">guide</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">reference</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">title</span>=<span class="string">&quot;Start&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0004.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">reference</span> <span class="attr">type</span>=<span class="string">&quot;toc&quot;</span> <span class="attr">title</span>=<span class="string">&quot;Table of Contents&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/part0000.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">reference</span> <span class="attr">type</span>=<span class="string">&quot;cover&quot;</span> <span class="attr">title</span>=<span class="string">&quot;Cover&quot;</span> <span class="attr">href</span>=<span class="string">&quot;Text/cover_page.xhtml&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">guide</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br></pre></td></tr></table></figure></details><p>说明我之前并没有猜错，这个文件存放的是超越“目录”的东西，而是“次序”——更进一步说。是“索引”。这个文件类似于其他文件格式或目录树中的 <code>index.*</code> ，将 ePub 中的各种数据编上号码，同时这里也定义了标题、语言、作者、出版 (发布) 日期等元信息。至于之前看到的超长行，似乎是一种十六进制的水印 (watermark) ，或许是为了防侵权等。</p><p>其中的 <code>/package/manifest/item</code> 定义了所有的索引，以及文件对应的类型； <code>/package/spine/itemref</code> 暂不知进一步的作用，但从中可看出能定义是否“线性” (linear) ； <code>/package/guide/reference</code> 定义了 ePub 的封面等索引，可供文件管理器和 ePub 阅读器使用 (显示预览页) 。</p><h4 id="Round-IV-IV-目录！"><a href="#Round-IV-IV-目录！" class="headerlink" title="Round IV.IV. 目录！"></a>Round IV.IV. 目录！</h4><p>再看 <code>OEBPS/toc.ncx</code> ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[littleye233@lymjrolt test_epub]$ file OEBPS/toc.ncx</span><br><span class="line">OEBPS/toc.ncx: XML 1.0 document, Unicode text, UTF-8 text</span><br></pre></td></tr></table></figure><p>感觉再讨论文件类型已经无关紧要了。再次查看内容：</p><details><summary>点此查看 `OEBPS/toc.ncx` 的全部内容 (已经过格式化)</summary><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ncx</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.daisy.org/z3986/2005/ncx/&quot;</span> <span class="attr">version</span>=<span class="string">&quot;2005-1&quot;</span> <span class="attr">xml:lang</span>=<span class="string">&quot;zh&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">content</span>=<span class="string">&quot;3899198450&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dtb:uid&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">content</span>=<span class="string">&quot;2&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dtb:depth&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">content</span>=<span class="string">&quot;mobiunpack.py&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dtb:generator&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">content</span>=<span class="string">&quot;0&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dtb:totalPageCount&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">content</span>=<span class="string">&quot;0&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dtb:maxPageNumber&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">docTitle</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span>&gt;</span>咖啡馆推理事件簿系列（全四本）<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">docTitle</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">navMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_1&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span>&gt;</span>总目录<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0000.xhtml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_2&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span>&gt;</span>咖啡馆推理事件簿：下次见面时，请让我品尝你煮的咖啡<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0001.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_3&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;3&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>序章<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0005.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_4&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>一　事件始于第二次光顾<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0006.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_5&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;5&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>二　Bittersweet Black<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0007.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_6&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;6&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>三　隐藏在乳白色中的心<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0008.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_7&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;7&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>四　棋盘上的狩猎<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0009.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_8&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;8&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>五　past，present，f******？<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0010.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_9&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;9&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>六　Animals in the closed room<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0011.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_10&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;10&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>七　下次见面时，请让我品尝你煮的咖啡<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0012.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_11&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;11&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>终章<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0013.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_12&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;12&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span>&gt;</span>咖啡馆推理事件簿2：她梦到了欧蕾咖啡<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0014.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_13&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;13&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>序曲　她的梦<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0018.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_14&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;14&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>第一章　敬启致未来的你<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0019.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_15&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;15&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>第二章　狐狸的迷惑<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0020.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_16&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;16&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>第三章　打碎乳白色的心<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0021.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_17&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;17&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>第四章　咖啡侦探蕾拉事件簿<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0022.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_18&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;18&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>第五章　（She Wanted To Be）WANTED<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0023.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_19&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;19&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>第六章　the Sky Occluded in the Sun<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0024.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_20&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;20&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>第七章　在星空之下同命相连<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0025.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_21&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;21&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>终章　她梦到了欧蕾咖啡<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0026.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_22&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;22&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span>&gt;</span>咖啡馆推理事件簿3：扰人心神的咖啡<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0027.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_23&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;23&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>序曲　五年前<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0031.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_24&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;24&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>第一章　参加大赛<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0032.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_25&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;25&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>第二章　前夜<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0033.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_26&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;26&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>第三章　第一天<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0034.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_27&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;27&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>第四章　第二天<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0035.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_28&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;28&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>第五章　真相<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0036.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_29&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;29&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>第六章　日后<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0037.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_30&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;30&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>尾声　五年前<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0038.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_31&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;31&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span>&gt;</span>咖啡馆推理事件簿4：休闲时光的五种风味<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0039.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_32&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;32&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>午后三点前的无聊风景<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0043.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_33&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;33&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>帕列塔之恋<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0044.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_34&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;34&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>消失的礼物飞镖<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0045.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_35&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;35&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>可视化的原生艺术<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0046.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_36&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;36&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>在塔列兰咖啡馆的庭院里<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0047.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">navPoint</span> <span class="attr">id</span>=<span class="string">&quot;np_37&quot;</span> <span class="attr">playOrder</span>=<span class="string">&quot;37&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navLabel</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">text</span>&gt;</span>特别篇　如释重负<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navLabel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">content</span> <span class="attr">src</span>=<span class="string">&quot;Text/part0048.xhtml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">navPoint</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">navMap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ncx</span>&gt;</span></span><br></pre></td></tr></table></figure></details><p>我们不妨将目光转向较为重要的“目录”的定义上。为了方便观察，笔者偷点懒，使用桌面环境中自带的阅读器观察：</p><p><img src="/2021/08/22/techdev/format/epub/images/1.png" alt="图1 `test.epub` 在阅读器中显示出的目录"></p><p>从中可以看出目录是二层结构，恰好和 <code>OEBPS/toc.ncx</code> 中的定义保持一致。而其中的部分重要属性均可“望文生义”，此处不再进一步研究。</p><h4 id="Round-IV-V-其余部分"><a href="#Round-IV-V-其余部分" class="headerlink" title="Round IV.V. 其余部分"></a>Round IV.V. 其余部分</h4><p>最后剩下的是图片、文字和层叠样式表。虽然这部分是在整个 ePub 文件中占比最大也可以说是最重要的部分，但由于这一块的内容实在是太过直白，再讲下去恐怕要开始补习 HTML 和 CSS 知识了，故同样略去。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>根据上文中的简要探究， ePub 是一种以 XML 文件格式为配置文件类型的、包含有图片及文字等数据的、以压缩档为本质的文件格式。查阅相关资料后可知其实质与上文中分析类似。</p><p>而通过上文的分析，我们初步体验到分析一种陌生文件格式的规律和技巧，可以用于后续对更复杂的文件格式的探究。</p><p><br><br><br><br><br></p><p>但最后，别忘了把那个 ePub 文件的名字改回来 XD ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[littleye233@lymjrolt Downloads]$ mv test.epub 咖啡馆推理事件簿系列（全四本）.epub</span><br></pre></td></tr></table></figure><p><strong>【完】</strong></p><h6 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h6><p>[^1]: 此处为 XPath 语法，用于描述类 XML 文件各种元素的位置，后文类似者不再注明。</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;这是“文件格式探究”专题的第 1 期——初探 “ePub” 文件格式。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Essay" scheme="https://blog.imakiseki.cf/categories/Essay/"/>
    
    
    <category term="File Format" scheme="https://blog.imakiseki.cf/tags/File-Format/"/>
    
    <category term="ePub" scheme="https://blog.imakiseki.cf/tags/ePub/"/>
    
  </entry>
  
  <entry>
    <title>【Python|RPG】Continuous Infinity制作实录 - EP.2 游戏大厅界面</title>
    <link href="https://blog.imakiseki.cf/techdev/continuous-infinity/ep-2/"/>
    <id>https://blog.imakiseki.cf/techdev/continuous-infinity/ep-2/</id>
    <published>2021-07-05T06:43:57.000Z</published>
    <updated>2022-01-22T15:35:19.634Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>这一期我们准备建设比较粗犷的部分——游戏大厅界面，这部分的代码对应源代码中 <code>run.py</code> 的部分。</p></blockquote><span id="more"></span><p>这一期我们准备建设比较粗犷的部分——游戏大厅界面，这部分的代码对应源代码中 <code>run.py</code> 的部分。为了不让以前的代 (shi) 码 (shan) 影响我们的思路，现在笔者将旧的代码全部删去。</p><p>照例先起个头，装作“万事开头难”的“开头”已经结束了 <del>(自欺欺人+1)</del> ：</p><figure class="highlight python"><figcaption><span>src/run.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Project: Continuous Infinity</span></span><br><span class="line"><span class="string">    File: src/run.py</span></span><br><span class="line"><span class="string">    Author: Little_Ye233</span></span><br><span class="line"><span class="string">    Created: 2021-07-05</span></span><br><span class="line"><span class="string">    Description: Main run shell.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure><h2 id="Part-I-欢迎界面"><a href="#Part-I-欢迎界面" class="headerlink" title="Part I. 欢迎界面"></a>Part I. 欢迎界面</h2><p>除去初始化的等待界面，玩家游玩游戏见到的第一个界面多半就是游戏大厅界面了，这也很大程度上决定了玩家的第一印象。不过我们这里只是简单的制作一个<strong>可以称得上</strong> TRPG 的东西，所以也没必要搞那么多花里胡哨的，直接上一个简朴的界面：</p><figure class="highlight python"><figcaption><span>src/game/system/scenes/lobby.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Project: Continuous Infinity</span></span><br><span class="line"><span class="string">    File: src/game/system/scenes/lobby.py</span></span><br><span class="line"><span class="string">    Author: Little_Ye233</span></span><br><span class="line"><span class="string">    Created: 2021-07-05</span></span><br><span class="line"><span class="string">    Description: Game algorithms of lobby scene.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ..constants <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lobby</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">        <span class="built_in">print</span>(SYSTEM_SCENES_LOBBY_WELCOME)</span><br></pre></td></tr></table></figure><figure class="highlight python"><figcaption><span>src/game/system/constants.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Project: Continuous Infinity</span></span><br><span class="line"><span class="string">    File: src/game/system/constants.py</span></span><br><span class="line"><span class="string">    Author: Little_Ye233</span></span><br><span class="line"><span class="string">    Created: 2021-07-05</span></span><br><span class="line"><span class="string">    Description: Definitions of game constants.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># System</span></span><br><span class="line">version = <span class="string">&#x27;0.1.0&#x27;</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Literal strings</span></span><br><span class="line">SYSTEM_SCENES_LOBBY_WELCOME = <span class="string">f&#x27;&#x27;&#x27;\</span></span><br><span class="line"><span class="string">-*-*- Continuous Infinity -*-*-</span></span><br><span class="line"><span class="string">-*- Ver <span class="subst">&#123;version&#125;</span> -*-</span></span><br><span class="line"><span class="string">-*- Author: Little_Ye233 -*-&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>嗯嗯嗯？！为什么多了个 <code>lobby.py</code> 和 <code>constants.py</code> ？还有原来的 <code>system.py</code> 为什么变成了一个同名的文件夹？</p><p>其实这个是笔者先前开发项目时的常有情况——每每做出了一定的规划，最后总会在某个地方需要修改原先的架构。这里也是模仿当时的情况做出的——在实际情况下考虑到单个文件 <code>system.py</code> 放置所有的逻辑可能会导致文件过于冗杂，故分离出多个子文件 (夹) 。其实这里我还埋伏了一手，就是 <code>constants.py</code> 。我们看到这里定义常量的时候我的命名方式是“源文件名 (下划线作文件路径分隔符) +其他标识符”，这也是一种冗长的写法，但笔者先暂时这么写，如果后期发现其他方式命名起来更容易，就尝试进一步修改。</p><p>先看这里的 <code>src/game/system/constants.py</code> 定义的内容。第一段 <code>System</code> 下定义的是版本号，变量名定义采用了许多著名模块中的 <code>version</code> (这里注意到变量名称是全部小写) 模块级变量定义方式，其中的字符串遵循<a href="https://semver.bootcss.com/lang/en/">“Semantic Versioning” (语义化版本)</a> 中的规定。第二段下定义了一个游戏大厅的欢迎界面，注意到这里利用了 Python 3.6 下引入的字符串格式化输出方式“f-string”。</p><h2 id="Part-II-选项"><a href="#Part-II-选项" class="headerlink" title="Part II. 选项"></a>Part II. 选项</h2><p>有了欢迎界面自然也要有选择的部分。选项的设计可以有简单的两种：第一种是给出所有可选项并标号，玩家自行输入标号；第二种是给出所有可选项，玩家通过方向键控制高亮选项。当然这两种也可以继续细分，实现选项的方式也不止这两种，甚至可以几种方式结合。我们这里为了简便，就采用第一种方式——不过看起来可能比较复杂就是了：</p><figure class="highlight python"><figcaption><span>src/game/system/scenes/lobby.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ..widgets <span class="keyword">import</span> Options</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lobby</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">        <span class="built_in">print</span>(LOBBY_WELCOME)</span><br><span class="line">        cmd = Options(<span class="number">0</span>, [</span><br><span class="line">            START_GAME,</span><br><span class="line">            SELECT_LEVEL,</span><br><span class="line">            SETTINGS,</span><br><span class="line">            CREDITS,</span><br><span class="line">            EXIT_GAME</span><br><span class="line">        ]).show()</span><br></pre></td></tr></table></figure><p>这是 <code>src/game/system/scenes/lobby.py</code> 的一部分定义。明显发现原来很长的常量名变成了直接表义的名字 <code>LOBBY_WELCOME</code> ，一方面是因为实在太长打起来很累 (终于悔改了) ，另一方面是因为使用只表义但不包含文件路径信息的记法便于在不同位置使用相同的字符串 (比如可能很多地方都会用到“开始游戏”之内的字符串) 。而这里我们又引入了一个新的概念 (坑) ——组件 (Widget) ，以将游戏设计中出现的各种小程序片段统一化。这里我们构造出了第一种组件——选项 (Options) ，来为玩家提供一个简单的选择系统。对于实现的细节我们先按下不表，只需能大致了解它实现出的效果即可：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="keyword">from</span> src.game.system.widgets <span class="keyword">import</span> Options</span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: cmd = Options(<span class="string">&#x27;0&#x27;</span>, [<span class="string">&#x27;Option 1&#x27;</span>, <span class="string">&#x27;Option 2&#x27;</span>, <span class="string">&#x27;Option 3&#x27;</span>]).show()</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">ValueError                                Traceback (most recent call last)</span><br><span class="line">&lt;ipython-<span class="built_in">input</span>-<span class="number">2</span>-6f1c48425fd6&gt; <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">----&gt; <span class="number">1</span> cmd = Options(<span class="string">&#x27;0&#x27;</span>, [<span class="string">&#x27;Option 1&#x27;</span>, <span class="string">&#x27;Option 2&#x27;</span>, <span class="string">&#x27;Option 3&#x27;</span>]).show()</span><br><span class="line"></span><br><span class="line">~/Documents/code/Python/rpg/ContinuousInfinity/src/game/system/widgets/options/main.py <span class="keyword">in</span> __init__(self, style, *params)</span><br><span class="line">     <span class="number">38</span>         <span class="comment"># CAUTIONS: now `style` can be 0 only</span></span><br><span class="line">     <span class="number">39</span>         <span class="keyword">if</span> style <span class="keyword">not</span> <span class="keyword">in</span> self._avail_style:</span><br><span class="line">---&gt; <span class="number">40</span>             <span class="keyword">raise</span> ValueError(<span class="string">f&#x27;style ID <span class="subst">&#123;style&#125;</span> is unavailable&#x27;</span>)</span><br><span class="line">     <span class="number">41</span></span><br><span class="line">     <span class="number">42</span>         self.style = style</span><br><span class="line"></span><br><span class="line">ValueError: style ID <span class="number">0</span> <span class="keyword">is</span> unavailable</span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: cmd = Options(<span class="number">0</span>, [<span class="string">&#x27;Option 1&#x27;</span>, <span class="string">&#x27;Option 2&#x27;</span>, <span class="string">&#x27;Option 3&#x27;</span>]).show()</span><br><span class="line">Choices:</span><br><span class="line">(<span class="number">1</span>) Option <span class="number">1</span></span><br><span class="line">(<span class="number">2</span>) Option <span class="number">2</span></span><br><span class="line">(<span class="number">3</span>) Option <span class="number">3</span></span><br><span class="line">Please choose: a</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">ValueError                                Traceback (most recent call last)</span><br><span class="line">&lt;ipython-<span class="built_in">input</span>-<span class="number">3</span>-c0fc1f068dc0&gt; <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">----&gt; <span class="number">1</span> cmd = Options(<span class="number">0</span>, [<span class="string">&#x27;Option 1&#x27;</span>, <span class="string">&#x27;Option 2&#x27;</span>, <span class="string">&#x27;Option 3&#x27;</span>]).show()</span><br><span class="line"></span><br><span class="line">~/Documents/code/Python/rpg/ContinuousInfinity/src/game/system/widgets/options/main.py <span class="keyword">in</span> show(self)</span><br><span class="line">     <span class="number">51</span>                     <span class="string">&#x27;src.game.system.widgets.options.styles&#x27;</span></span><br><span class="line">     <span class="number">52</span>                 )</span><br><span class="line">---&gt; <span class="number">53</span>         <span class="keyword">return</span> style.Style.show(*self.params)</span><br><span class="line"></span><br><span class="line">~/Documents/code/Python/rpg/ContinuousInfinity/src/game/system/widgets/options/styles/style0.py <span class="keyword">in</span> show(*params)</span><br><span class="line">     <span class="number">22</span>         s = <span class="built_in">input</span>(<span class="string">&#x27;Please choose: &#x27;</span>)</span><br><span class="line">     <span class="number">23</span>         <span class="keyword">if</span> <span class="keyword">not</span> s.isdigit() <span class="keyword">or</span> <span class="built_in">int</span>(s) == <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">int</span>(s) &gt; <span class="built_in">len</span>(choices):</span><br><span class="line">---&gt; <span class="number">24</span>             <span class="keyword">raise</span> ValueError(<span class="string">f&#x27;invalid input value: <span class="subst">&#123;s&#125;</span>&#x27;</span>)</span><br><span class="line">     <span class="number">25</span>         <span class="keyword">return</span> <span class="built_in">int</span>(s)</span><br><span class="line"></span><br><span class="line">ValueError: invalid <span class="built_in">input</span> value: a</span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: cmd = Options(<span class="number">0</span>, [<span class="string">&#x27;Option 1&#x27;</span>, <span class="string">&#x27;Option 2&#x27;</span>, <span class="string">&#x27;Option 3&#x27;</span>]).show()</span><br><span class="line">Choices:</span><br><span class="line">(<span class="number">1</span>) Option <span class="number">1</span></span><br><span class="line">(<span class="number">2</span>) Option <span class="number">2</span></span><br><span class="line">(<span class="number">3</span>) Option <span class="number">3</span></span><br><span class="line">Please choose: <span class="number">0</span></span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">ValueError                                Traceback (most recent call last)</span><br><span class="line">&lt;ipython-<span class="built_in">input</span>-<span class="number">4</span>-c0fc1f068dc0&gt; <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">----&gt; <span class="number">1</span> cmd = Options(<span class="number">0</span>, [<span class="string">&#x27;Option 1&#x27;</span>, <span class="string">&#x27;Option 2&#x27;</span>, <span class="string">&#x27;Option 3&#x27;</span>]).show()</span><br><span class="line"></span><br><span class="line">~/Documents/code/Python/rpg/ContinuousInfinity/src/game/system/widgets/options/main.py <span class="keyword">in</span> show(self)</span><br><span class="line">     <span class="number">51</span>                     <span class="string">&#x27;src.game.system.widgets.options.styles&#x27;</span></span><br><span class="line">     <span class="number">52</span>                 )</span><br><span class="line">---&gt; <span class="number">53</span>         <span class="keyword">return</span> style.Style.show(*self.params)</span><br><span class="line"></span><br><span class="line">~/Documents/code/Python/rpg/ContinuousInfinity/src/game/system/widgets/options/styles/style0.py <span class="keyword">in</span> show(*params)</span><br><span class="line">     <span class="number">22</span>         s = <span class="built_in">input</span>(<span class="string">&#x27;Please choose: &#x27;</span>)</span><br><span class="line">     <span class="number">23</span>         <span class="keyword">if</span> <span class="keyword">not</span> s.isdigit() <span class="keyword">or</span> <span class="built_in">int</span>(s) == <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">int</span>(s) &gt; <span class="built_in">len</span>(choices):</span><br><span class="line">---&gt; <span class="number">24</span>             <span class="keyword">raise</span> ValueError(<span class="string">f&#x27;invalid input value: <span class="subst">&#123;s&#125;</span>&#x27;</span>)</span><br><span class="line">     <span class="number">25</span>         <span class="keyword">return</span> <span class="built_in">int</span>(s)</span><br><span class="line"></span><br><span class="line">ValueError: invalid <span class="built_in">input</span> value: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: cmd = Options(<span class="number">0</span>, [<span class="string">&#x27;Option 1&#x27;</span>, <span class="string">&#x27;Option 2&#x27;</span>, <span class="string">&#x27;Option 3&#x27;</span>]).show()</span><br><span class="line">Choices:</span><br><span class="line">(<span class="number">1</span>) Option <span class="number">1</span></span><br><span class="line">(<span class="number">2</span>) Option <span class="number">2</span></span><br><span class="line">(<span class="number">3</span>) Option <span class="number">3</span></span><br><span class="line">Please choose: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: cmd</span><br><span class="line">Out[<span class="number">6</span>]: <span class="number">1</span></span><br></pre></td></tr></table></figure><p>这里我们可以看到， <code>Options</code> 类能够根据给定参数产生一个实例，而这个实例的 <code>show</code> 方法则能在<strong>默认输出设备</strong>——也就是终端 (terminal) ——其实这里我预感没有加上 IO 设备的参数后期会出麻烦，但现在暂时先这么写着。然后如果交互过程没有异常的话，这个方法会将玩家选择的选项的编号 (在当前的 style 中，必定为一个正整数) 作为返回值。依此我们可以编写出如下的游戏大厅页面场景 (scene) 代码：</p><figure class="highlight python"><figcaption><span>src/game/system/scenes/lobby.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ..constants <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ..widgets <span class="keyword">import</span> Options</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_game</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;start_game: Not implemented yet!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">select_level</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;select_level: Not implemented yet!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">settings</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;settings: Not implemented yet!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_credits</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(CREDITS_MSG)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit_game</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(LOBBY_EXIT)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">actions = [<span class="literal">None</span>, start_game, select_level, settings, show_credits, exit_game]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lobby</span>:</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">        <span class="built_in">print</span>(LOBBY_WELCOME)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                cmd = Options(<span class="number">0</span>, [</span><br><span class="line">                    START_GAME,</span><br><span class="line">                    SELECT_LEVEL,</span><br><span class="line">                    SETTINGS,</span><br><span class="line">                    CREDITS,</span><br><span class="line">                    EXIT_GAME</span><br><span class="line">                ]).show()</span><br><span class="line">            <span class="keyword">except</span> ValueError:  <span class="comment"># wrong `cmd`</span></span><br><span class="line">                <span class="built_in">print</span>()</span><br><span class="line">                <span class="built_in">print</span>(WRONG_CMD)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>()</span><br><span class="line">                actions[cmd]()</span><br><span class="line">            <span class="built_in">print</span>()</span><br></pre></td></tr></table></figure><p>一些常量的定义暂时忽略。最终能得到如下的测试结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">$ python src/run.py</span><br><span class="line">-*-*- Continuous Infinity -*-*-</span><br><span class="line">-*- Ver 0.1.0 -*-</span><br><span class="line">-*- Author: Little_Ye233 -*-</span><br><span class="line">Choices:</span><br><span class="line">(1) Start Game</span><br><span class="line">(2) Select a Level</span><br><span class="line">(3) Settings</span><br><span class="line">(4) Credits</span><br><span class="line">(5) Exit Game</span><br><span class="line">Please choose: 0</span><br><span class="line"></span><br><span class="line">Got a wrong choice. Please try again.</span><br><span class="line"></span><br><span class="line">Choices:</span><br><span class="line">(1) Start Game</span><br><span class="line">(2) Select a Level</span><br><span class="line">(3) Settings</span><br><span class="line">(4) Credits</span><br><span class="line">(5) Exit Game</span><br><span class="line">Please choose: 1</span><br><span class="line"></span><br><span class="line">start_game: Not implemented yet!</span><br><span class="line"></span><br><span class="line">Choices:</span><br><span class="line">(1) Start Game</span><br><span class="line">(2) Select a Level</span><br><span class="line">(3) Settings</span><br><span class="line">(4) Credits</span><br><span class="line">(5) Exit Game</span><br><span class="line">Please choose: 2</span><br><span class="line"></span><br><span class="line">select_level: Not implemented yet!</span><br><span class="line"></span><br><span class="line">Choices:</span><br><span class="line">(1) Start Game</span><br><span class="line">(2) Select a Level</span><br><span class="line">(3) Settings</span><br><span class="line">(4) Credits</span><br><span class="line">(5) Exit Game</span><br><span class="line">Please choose: 3</span><br><span class="line"></span><br><span class="line">settings: Not implemented yet!</span><br><span class="line"></span><br><span class="line">Choices:</span><br><span class="line">(1) Start Game</span><br><span class="line">(2) Select a Level</span><br><span class="line">(3) Settings</span><br><span class="line">(4) Credits</span><br><span class="line">(5) Exit Game</span><br><span class="line">Please choose: 4</span><br><span class="line"></span><br><span class="line">-*-*- Credits -*-*-</span><br><span class="line">Author: Little_Ye233</span><br><span class="line"></span><br><span class="line">Choices:</span><br><span class="line">(1) Start Game</span><br><span class="line">(2) Select a Level</span><br><span class="line">(3) Settings</span><br><span class="line">(4) Credits</span><br><span class="line">(5) Exit Game</span><br><span class="line">Please choose: 5</span><br><span class="line"></span><br><span class="line">Goodbye!</span><br></pre></td></tr></table></figure><p><strong>【完】</strong></p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;这一期我们准备建设比较粗犷的部分——游戏大厅界面，这部分的代码对应源代码中 &lt;code&gt;run.py&lt;/code&gt; 的部分。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Record" scheme="https://blog.imakiseki.cf/categories/Record/"/>
    
    
    <category term="Programming" scheme="https://blog.imakiseki.cf/tags/Programming/"/>
    
    <category term="Python" scheme="https://blog.imakiseki.cf/tags/Python/"/>
    
    <category term="RPG" scheme="https://blog.imakiseki.cf/tags/RPG/"/>
    
    <category term="Continuous Infinity" scheme="https://blog.imakiseki.cf/tags/Continuous-Infinity/"/>
    
  </entry>
  
  <entry>
    <title>【Python|RPG】Continuous Infinity制作实录 - EP.1 框架</title>
    <link href="https://blog.imakiseki.cf/techdev/continuous-infinity/ep-1/"/>
    <id>https://blog.imakiseki.cf/techdev/continuous-infinity/ep-1/</id>
    <published>2021-06-30T15:11:45.000Z</published>
    <updated>2022-01-22T15:35:00.349Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>我们这次将开始利用Python制作一款简易的TRPG，名字在很久以前已经想好——《Continuous Infinity》，这个名字出自刚立项时的想法——最终实现自动生成无限多的关卡。</p></blockquote><span id="more"></span><p>我们这次将开始利用Python制作一款简易的TRPG，名字在很久以前已经想好——《Continuous Infinity》，这个名字出自刚立项时的想法——最终实现自动生成无限多的关卡。</p><p>为了使本文简洁明了，这个系列就不废话了 <del>(希望如此)</del> 。</p><h2 id="Part-I-规划"><a href="#Part-I-规划" class="headerlink" title="Part I. 规划"></a>Part I. 规划</h2><p>从总体上看整个游戏流程，应该可以分成以下几步：</p><ol><li>主页：进行游戏配置，选择进入或退出游戏；</li><li>主体：游戏主体部分，<strong>项目的核心</strong>；<ol><li>接受玩家操作，产生效果；</li><li>检查是否达到退出条件；</li><li>程序作出操作，产生效果；</li><li>检查是否达到退出条件；</li></ol></li><li>退出游戏或回到1.。</li></ol><p>游戏的主要形式即是玩家操纵角色与其他角色 (程序控制的敌人) 进行对战，互相攻击对方，直至一方血量归零，触发事件，执行后续操作——玩家死亡结算、敌方给出新角色、进入下一关等。由此可以归纳出游戏时需要<strong>定义</strong>的“<strong>具体事物</strong>”有<strong>角色 (mob) 、物品 (item) (包括装备、道具) 、技能 (skill) 等</strong>，稍抽象一点的是<strong>关卡 (level)</strong> (需要定义每个关卡的敌方角色的各种信息) 。</p><h2 id="Part-II-源码结构"><a href="#Part-II-源码结构" class="headerlink" title="Part II. 源码结构"></a>Part II. 源码结构</h2><p>继而我们可以给出如下的源码结构作为参考：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">│  run.py</span><br><span class="line">│</span><br><span class="line">├─game</span><br><span class="line">│  │  system.py</span><br><span class="line">│  │</span><br><span class="line">│  ├─data</span><br><span class="line">│  │  ├─items</span><br><span class="line">│  │  ├─levels</span><br><span class="line">│  │  ├─mobs</span><br><span class="line">│  │  └─skills</span><br><span class="line">│  ├─generator</span><br><span class="line">│  │      levels.py</span><br><span class="line">│  │</span><br><span class="line">│  ├─loader</span><br><span class="line">│  │      items.py</span><br><span class="line">│  │      levels.py</span><br><span class="line">│  │      mobs.py</span><br><span class="line">│  │      skills.py</span><br><span class="line">│  │</span><br><span class="line">│  └─locales</span><br><span class="line">└─test</span><br><span class="line">        .keep</span><br></pre></td></tr></table></figure><p>其中<code>run.py</code>是游戏启动的脚本；<code>test</code>文件夹存放单元测试的相关内容；<code>game</code>文件夹存放本游戏的主体内容，包括游戏的绝大多数逻辑、上文所说的具体事物的定义和设计等；<code>game/data</code>文件夹存放的即是所谓的“设计”；<code>game/generator</code>文件夹存放游戏的生成器，用以自定义一系列具体事物以及其自动生成算法；<code>game/loader</code>文件夹存放游戏的加载器，用以读取<code>game/data</code>定义的内容；<code>game/locales</code>文件夹存放游戏的多语言文件 <em>(锦上添花而已，不重要)</em> 。</p><h2 id="Part-III-具体事物的信息存储和对战系统逻辑"><a href="#Part-III-具体事物的信息存储和对战系统逻辑" class="headerlink" title="Part III. 具体事物的信息存储和对战系统逻辑"></a>Part III. 具体事物的信息存储和对战系统逻辑</h2><p>前文提到了对战系统的主要形式是回合制，而较为精细的逻辑则需要涉及到一些具体事物的“使用——生效”机制。当开始某个角色 (不论是玩家还是敌方角色) 的回合时，这个角色可以选择出招 (skill) ，也可以选择使用道具 (item) 增益己方或损害对方，亦可以临时装备一些物品 (item)，或是执行系统级操作——逃跑 (假设未来某天加入游戏中) 、投降 (同上) 、退出当前对局等。不过其中需要伤点脑子的是如何有效地存储一些具体事物的各种信息，以及如何让具体事物在对战时产生效果。</p><p>在早期的设计过程中，笔者写出了如下的代码来存储角色的信息：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mob</span>(<span class="params"><span class="built_in">object</span></span>):</span> <span class="comment"># Player and enemy</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, <span class="built_in">type</span>, name, lvl, exp, hp, pp, hpm, ppm, atk, dfd, spd, pack, coin, skill, weapon, helmet, chestplate, leggings, boots</span>):</span></span><br><span class="line">        self.<span class="built_in">type</span> = <span class="built_in">type</span>                <span class="comment"># 类型（职业）</span></span><br><span class="line">        self.name = name                <span class="comment"># 名字</span></span><br><span class="line">        self.lvl = lvl                  <span class="comment"># 等级</span></span><br><span class="line">        self.exp = exp                  <span class="comment"># 经验值</span></span><br><span class="line">        self.hp = hp                    <span class="comment"># 血量</span></span><br><span class="line">        self.pp = pp                    <span class="comment"># 技能点</span></span><br><span class="line">        self.hpm = hpm                  <span class="comment"># 血量上限</span></span><br><span class="line">        self.ppm = ppm                  <span class="comment"># 技能点上限</span></span><br><span class="line">        self.atk = atk                  <span class="comment"># 攻击力</span></span><br><span class="line">        self.dfd = dfd                  <span class="comment"># 防御力</span></span><br><span class="line">        self.spd = spd                  <span class="comment"># 迅捷度</span></span><br><span class="line">        self.pack = pack                <span class="comment"># 背包列表</span></span><br><span class="line">        self.coin = coin                <span class="comment"># 金钱</span></span><br><span class="line">        self.skill = skill              <span class="comment"># 技能列表</span></span><br><span class="line">        self.weapon = weapon            <span class="comment"># 武器</span></span><br><span class="line">        self.helmet = helmet            <span class="comment"># 头盔</span></span><br><span class="line">        self.chestplate = chestplate    <span class="comment"># 胸甲</span></span><br><span class="line">        self.leggings = leggings        <span class="comment"># 腿甲</span></span><br><span class="line">        self.boots = boots              <span class="comment"># 靴子</span></span><br></pre></td></tr></table></figure><p>原来的代码中其实连中文注释都没有。但即便按照PEP 8进行格式化，加上了详细的注释，又添上了“docstring”，这段代码依然冗长，而且在定义一个角色的时候需要在参数中加上大量的<code>None</code>，十分不便。这是笔者联想到<code>requests</code>模块的<code>get</code>函数，<code>get</code>函数支持添加许多参数，但模块作者采用了一个较为聪明的方法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [2]: requests.get?</span><br><span class="line">Signature: requests.get(url, params=None, **kwargs)</span><br><span class="line">Docstring:</span><br><span class="line">Sends a GET request.</span><br><span class="line"></span><br><span class="line">:param url: URL for the new :class:`Request` object.</span><br><span class="line">:param params: (optional) Dictionary, list of tuples or bytes to send</span><br><span class="line">    in the body of the :class:`Request`.</span><br><span class="line">:param \*\*kwargs: Optional arguments that ``request`` takes.</span><br><span class="line">:return: :class:`Response &lt;Response&gt;` object</span><br><span class="line">:rtype: requests.Response</span><br></pre></td></tr></table></figure><p>因而我们也可以让定义者显式地传入一个角色的个性化参数，如果没有给出就保持默认值，这样可以极好地便利游戏数据设计者。同时这样的设计可以在形式上将一个角色的所有信息<strong>平权</strong>，作为“字典型”参数传入时，没有明显的次序之分，总体上是优雅和谐的。</p><p>而对于产生效果的方法，一个问题是如何选择目标角色。一项技能和一个物品发挥作用，其目标可以是使用者自身，也可以是己方或对方所有角色，甚至是让使用者自选角色乃至随机角色。为了适应多种需求，我们可以借鉴游戏《Minecraft》上“目标选择器”的机制——利用简单的语法形成的字符串来选择目标。而第二个问题是施加效果，如果便利游戏数据设计者，可以封死自定义复杂函数的通道，只提供一个简单的列表保证一些必要数据 (譬如血量、技能点、装备、物品数量) 的增减；而如果提供充分的自由度，我们可以允许游戏数据设计者向loader提供一个含有指定接口的函数，loader只需利用提供的接口执行更复杂的操作即可。如果为了“双赢”，可以同时实现这两种方式，当然这样的话最累的就是游戏设计者 (其实就是笔者) 。</p><p><strong>【完】</strong></p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;我们这次将开始利用Python制作一款简易的TRPG，名字在很久以前已经想好——《Continuous Infinity》，这个名字出自刚立项时的想法——最终实现自动生成无限多的关卡。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Record" scheme="https://blog.imakiseki.cf/categories/Record/"/>
    
    
    <category term="Programming" scheme="https://blog.imakiseki.cf/tags/Programming/"/>
    
    <category term="Python" scheme="https://blog.imakiseki.cf/tags/Python/"/>
    
    <category term="RPG" scheme="https://blog.imakiseki.cf/tags/RPG/"/>
    
    <category term="Continuous Infinity" scheme="https://blog.imakiseki.cf/tags/Continuous-Infinity/"/>
    
  </entry>
  
</feed>
